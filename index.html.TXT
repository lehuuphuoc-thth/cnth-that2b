<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tin h·ªçc & C√¥ng ngh·ªá c·ªßa Em</title>
  <link rel="icon" type="image/png" href="image/icon.png" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>
  <style>
    /* B·ªè hi·ªáu ·ª©ng m∆∞·ª£t, d√πng display */
    #menu li.folder > ul {
      display: none;
      padding-left: 10px;
      border-left: 2px solid #e2e8f0;
      margin-left: 10px;
    }
    #menu li.folder.open > ul {
      display: block;
    }
  </style>
</head>
<body id="appBody">
  <button id="toggleBtn">‚ò∞ Menu</button>
  <div id="overlay"></div>
  <div id="container">
    <div id="sidebar">
      <h3>Danh m·ª•c</h3>
      <div id="menu"></div>
    </div>
    <div id="content">
      <iframe name="contentFrame"></iframe>
    </div>
  </div>

  <script>
    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("overlay");
    const toggleBtn = document.getElementById("toggleBtn");

    const musicPaths = [
      "music/background.mp3",
      "music/Disco_con_Tutti.mp3",
      "music/Hot_Rock.mp3",
      "music/Macaroon_5.mp3",
      "music/home_base_groove.mp3"
    ];
    let audioPlayer = null;
    let clickSynth = null;
    let isAudioContextActive = false;

    function playClickSound() {
      if (isAudioContextActive && clickSynth) {
        clickSynth.triggerAttackRelease("C5", "32n");
      }
    }
    async function initializeAudio() {
      if (isAudioContextActive) return;
      await Tone.start();
      isAudioContextActive = true;
      clickSynth = new Tone.PolySynth(Tone.Synth).toDestination();
    }
    function playSong(url) {
      if (audioPlayer) audioPlayer.pause();
      audioPlayer = new Audio(url);
      audioPlayer.loop = false;
      audioPlayer.muted = true;
      audioPlayer.play().catch(() => {});
    }
    document.body.addEventListener("click", () => {
      if (audioPlayer) audioPlayer.muted = false;
    }, { once: true });

    function setupMusicToggleButton() {
      const btn = document.createElement("button");
      btn.id = "musicToggleBtn";
      btn.textContent = "üîä";
      btn.onclick = () => {
        playClickSound();
        if (audioPlayer && !audioPlayer.paused) {
          audioPlayer.pause();
          btn.textContent = "üîà";
        } else {
          audioPlayer.play().catch(() => {});
          btn.textContent = "üîä";
        }
      };
      sidebar.insertBefore(btn, sidebar.firstChild);
    }

    function applyTimeBasedTheme() {
      const hour = new Date().getHours();
      document.body.classList.toggle("dark-mode", hour >= 18 || hour < 6);
    }

    fetch("data.json")
      .then(res => res.json())
      .then(data => {
        const menu = document.getElementById("menu");
        function buildTree(items) {
          const ul = document.createElement("ul");
          items.forEach(item => {
            const li = document.createElement("li");
            if (item.children) {
              li.classList.add("folder");
              const span = document.createElement("span");
              span.textContent = item.title;

              // ‚úÖ Toggle ƒë∆°n gi·∫£n, kh√¥ng hi·ªáu ·ª©ng m∆∞·ª£t
              span.onclick = () => {
                playClickSound();
                li.classList.toggle("open");
              };

              li.appendChild(span);
              li.appendChild(buildTree(item.children));
            } else {
              const a = document.createElement("a");
              a.textContent = item.title;
              a.href = "#";
              a.onclick = (e) => {
                e.preventDefault();
                playClickSound();
                document.querySelector("iframe").src = item.url;
                if (window.innerWidth <= 768) {
                  sidebar.classList.remove("show");
                  overlay.style.display = "none";
                }
                document.getElementById("content").classList.add("show");
              };
              li.appendChild(a);
            }
            ul.appendChild(li);
          });
          return ul;
        }
        menu.appendChild(buildTree(data.pages));
      });

    function showIntroThenLoadHome() {
      const intro = document.createElement("div");
      intro.id = "introAnim";
      intro.innerHTML = `
        <div class="intro-sun"></div>
        <div class="intro-horizon"></div>
        <div class="intro-balloon b1"></div>
        <div class="intro-balloon b2"></div>
        <div class="intro-balloon b3"></div>
        <div class="intro-balloon b4"></div>
      `;
      document.body.appendChild(intro);
      setTimeout(() => {
        document.querySelector("iframe").src = "pages/trangchu.html";
        intro.style.transition = "opacity 1s ease";
        intro.style.opacity = "0";
        intro.addEventListener("transitionend", () => intro.remove());
        initializeAudio();
        playSong(musicPaths[0]);
        setupMusicToggleButton();
        document.getElementById("content").classList.add("show");
      }, 5000);
    }

    toggleBtn.onclick = () => {
      const isMobile = window.innerWidth <= 768;
      playClickSound();
      if (isMobile) {
        const isOpen = sidebar.classList.contains("show");
        sidebar.classList.toggle("show", !isOpen);
        overlay.style.display = !isOpen ? "block" : "none";
      } else {
        sidebar.classList.toggle("hidden");
      }
    };

    overlay.onclick = () => {
      sidebar.classList.remove("show");
      overlay.style.display = "none";
      playClickSound();
    };

    applyTimeBasedTheme();
    setInterval(applyTimeBasedTheme, 60000);
    document.addEventListener("DOMContentLoaded", showIntroThenLoadHome);
  </script>
</body>
</html>