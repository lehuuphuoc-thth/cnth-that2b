<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·∫£ng X·∫øp H·∫°ng C√¥ng Ngh·ªá & Tin H·ªçc</title>
    <!-- T·∫£i Tailwind CSS cho giao di·ªán ƒë·∫πp v√† responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- T·∫£i th∆∞ vi·ªán Tone.js cho √¢m thanh vui t∆∞∆°i -->
    <script src="https://unpkg.com/tone@14.7.58/build/Tone.js"></script>
    <style>
        /* T√πy ch·ªânh font ch·ªØ Inter v√† l√†m cho giao di·ªán tr·ªü n√™n vui nh·ªôn h∆°n */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f9ff; /* M√†u n·ªÅn xanh da tr·ªùi nh·∫°t */
        }
        .header-bg {
            background-image: linear-gradient(to right, #4c51bf, #667eea); /* Gradient t√≠m-xanh */
        }
        .card-shadow { box-shadow: 0 10px 20px rgba(0,0,0,0.1), 0 6px 6px rgba(0,0,0,0.06); }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #6366f1;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* --- STYLES CHO TOP 3 ƒê∆Ø·ª¢C C·∫¨P NH·∫¨T --- */

        /* Hi·ªáu ·ª©ng chung cho t·∫•t c·∫£ c√°c h√†ng */
        #leaderboard-body tr {
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
            border-radius: 0.5rem; /* G√≥c bo tr√≤n cho h√†ng */
        }
        
        /* Hi·ªáu ·ª©ng hover cho c√°c h√†ng th∆∞·ªùng (kh√¥ng ph·∫£i top 3) */
        #leaderboard-body tr:not(.top-rank-row):hover {
            background-color: #f5f5f5; 
            transform: scale(1.005);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        /* M√†u r·ª±c r·ª° cho H·∫°ng 1 (V√†ng) */
        .rank-gold { 
            background-color: #ffeb3b; 
            color: #a0522d; 
            border: 4px solid #fbc02d; 
        }
        /* M√†u r·ª±c r·ª° cho H·∫°ng 2 (B·∫°c) */
        .rank-silver { 
            background-color: #bdbdbd; 
            color: #424242; 
            border: 4px solid #757575; 
        }
        /* M√†u r·ª±c r·ª° cho H·∫°ng 3 (ƒê·ªìng) */
        .rank-bronze { 
            background-color: #d7885b; 
            color: #ffffff; 
            border: 4px solid #a15f3a; 
        }

        /* L·ªõp cho h√†ng Top 3: ƒë·∫£m b·∫£o font l·ªõn h∆°n v√† hi·ªáu ·ª©ng hover m·∫°nh h∆°n */
        .top-rank-row {
            font-size: 1.1rem; /* K√≠ch th∆∞·ªõc font c∆° b·∫£n l·ªõn h∆°n */
            font-weight: 700;
        }

        /* Hi·ªáu ·ª©ng hover cho Top 3: N·ªïi b·∫≠t h∆°n */
        .top-rank-row:hover {
            transform: scale(1.02); /* N·ªïi l√™n r√µ r·ªát */
            box-shadow: 0 15px 30px rgba(76, 81, 191, 0.3); /* B√≥ng ƒë·ªï t√≠m r·ª±c r·ª° */
            z-index: 10;
            position: relative; 
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- Thanh header v√† Ti√™u ƒë·ªÅ -->
    <header class="header-bg p-6 rounded-xl shadow-lg mb-8 text-white">
        <h1 class="text-4xl font-extrabold text-center tracking-tight">
            üèÜ B·∫¢NG X·∫æP H·∫†NG T√ÄI NƒÇNG NH√ç (TIN H·ªåC & C√îNG NGH·ªÜ) üíª
        </h1>
        <p class="text-center text-xl mt-2 font-light">
            Tr∆∞·ªùng Ti·ªÉu H·ªçc An Th·∫°nh 2 - NƒÉm H·ªçc 2025-2026
        </p>
    </header>

    <!-- Khu v·ª±c Ch·ªçn B·∫£ng X·∫øp H·∫°ng -->
    <div id="selection-section" class="bg-white p-6 rounded-xl card-shadow mb-8 border border-indigo-200">
        <h2 class="text-2xl font-bold mb-4 text-indigo-600">Ch·ªçn B·∫£ng X·∫øp H·∫°ng</h2>
        <p class="text-sm mb-4 text-gray-600 font-semibold">
            Ch·ªçn kh·ªëi l·ªõp b·∫°n mu·ªën hi·ªÉn th·ªã b·∫£ng x·∫øp h·∫°ng:
        </p>
        <select id="sheet-selector"
               class="w-full p-3 border-2 border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 text-lg">
            <!-- Options s·∫Ω ƒë∆∞·ª£c th√™m v√†o b·∫±ng JavaScript -->
        </select>
        <p id="error-message" class="text-red-500 mt-2 hidden text-sm font-medium"></p>
    </div>

    <!-- Khu v·ª±c B·∫£ng X·∫øp H·∫°ng Ch√≠nh -->
    <div id="leaderboard-section" class="bg-white p-4 md:p-8 rounded-xl card-shadow">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-3xl font-extrabold text-gray-800">
                ‚≠ê <span id="current-leaderboard-title">...</span>
            </h2>
            <button id="refresh-btn"
                    class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-full transition duration-300 shadow-md flex items-center">
                <div id="loading-indicator" class="loading-spinner mr-2 hidden"></div>
                <svg id="refresh-icon" class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 19m4.356 2H15V19"></path></svg>
                T·∫£i L·∫°i
            </button>
        </div>

        <!-- B·∫£ng x·∫øp h·∫°ng -->
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-indigo-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider rounded-tl-lg">H·∫°ng</th>
                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">H·ªç v√† T√™n</th>
                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">L·ªõp</th> <!-- C·ªôt m·ªõi: L·ªõp -->
                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider rounded-tr-lg">T·ªïng ƒëi·ªÉm</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-body" class="bg-white divide-y divide-gray-100">
                    <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c ch√®n v√†o ƒë√¢y b·ªüi JavaScript -->
                    <tr><td colspan="4" class="text-center py-8 text-gray-500">Vui l√≤ng ch·ªçn m·ªôt B·∫£ng X·∫øp H·∫°ng ·ªü tr√™n ƒë·ªÉ xem d·ªØ li·ªáu.</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Ch√∫ th√≠ch vui v·∫ª -->
    <footer class="mt-8 text-center text-gray-500 text-sm">
        <p>Ch√∫c m·ª´ng nh·ªØng "Ch√∫ Ong chƒÉm ch·ªâ" ƒë√£ ho√†n th√†nh xu·∫•t s·∫Øc th·ª≠ th√°ch!</p>
    </footer>

    <!-- D·ªØ li·ªáu JSON c·∫•u h√¨nh B·∫£ng X·∫øp H·∫°ng (D·ªÖ d√†ng ch·ªânh s·ª≠a) -->
    <script type="application/json" id="leaderboard-data">
[
    {
        "key": "khoi_4_tong_hop",
        "title": "B·∫£ng X·∫øp H·∫°ng Kh·ªëi 4",
        "spreadsheetId": "1e72CzgD91I_4qj0kEQ0B0UxcE903axcxPWyTu4pNmzc",
        "gid": "69854433"
    },
    {
        "key": "khoi_5_tong_hop",
        "title": "B·∫£ng X·∫øp H·∫°ng Kh·ªëi 5",
        "spreadsheetId": "1yLxFYp99eymGr58E1bqGZNAhKUvhyaIeSZPEDM-CxPA",
        "gid": "431843891"
    }
]
    </script>

    <script>
        // H√†m t·∫£i c·∫•u h√¨nh JSON t·ª´ th·∫ª script
        function loadConfig() {
            const scriptTag = document.getElementById('leaderboard-data');
            if (!scriptTag || !scriptTag.textContent) {
                console.error("L·ªñI C·∫§U H√åNH: Kh√¥ng t√¨m th·∫•y th·∫ª <script id='leaderboard-data'> ho·∫∑c th·∫ª b·ªã r·ªóng.");
                return {};
            }

            try {
                // Ph√¢n t√≠ch c√∫ ph√°p m·∫£ng JSON
                const arrayConfig = JSON.parse(scriptTag.textContent.trim());
                
                // Chuy·ªÉn m·∫£ng th√†nh ƒë·ªëi t∆∞·ª£ng (Map) ƒë·ªÉ d·ªÖ d√†ng tra c·ª©u b·∫±ng 'key'
                return arrayConfig.reduce((acc, current) => {
                    // ƒê·∫£m b·∫£o c√≥ key tr∆∞·ªõc khi th√™m
                    if (current.key) {
                        acc[current.key] = current;
                    } else {
                        console.warn("C·∫§U H√åNH C·∫¢NH B√ÅO: M·ªôt m·ª•c trong JSON kh√¥ng c√≥ 'key' v√† ƒë√£ b·ªã b·ªè qua.");
                    }
                    return acc;
                }, {});
            } catch (e) {
                console.error("L·ªñI C·∫§U H√åNH: Kh√¥ng th·ªÉ ph√¢n t√≠ch c√∫ ph√°p JSON. Vui l√≤ng ki·ªÉm tra d·∫•u ph·∫©y, d·∫•u ngo·∫∑c k√©p, v√† c·∫•u tr√∫c.", e);
                return {};
            }
        }

        const GOOGLE_SHEET_CONFIG = loadConfig();
        
        // C·∫•u h√¨nh Tone.js cho √¢m thanh
        const playCheerSound = () => {
            try {
                // Kh·ªüi t·∫°o m·ªôt b·ªô t·ªïng h·ª£p ƒë∆°n gi·∫£n (Synth)
                const synth = new Tone.Synth({
                    oscillator: {
                        type: "triangle"
                    },
                    envelope: {
                        attack: 0.005,
                        decay: 0.1,
                        sustain: 0.05,
                        release: 0.5,
                    }
                }).toDestination();
                // Ph√°t ra m·ªôt n·ªët nh·∫°c vui v·∫ª
                Tone.start();
                synth.triggerAttackRelease("C5", "8n");
                synth.triggerAttackRelease("E5", "8n", "+0.1");
                synth.triggerAttackRelease("G5", "8n", "+0.2");
            } catch (e) {
                console.warn("L·ªói ph√°t √¢m thanh Tone.js:", e);
            }
        };

        const sheetSelector = document.getElementById('sheet-selector');
        const refreshBtn = document.getElementById('refresh-btn');
        const loadingIndicator = document.getElementById('loading-indicator');
        const refreshIcon = document.getElementById('refresh-icon');
        const errorMsg = document.getElementById('error-message');
        const leaderboardBody = document.getElementById('leaderboard-body');
        const currentTitle = document.getElementById('current-leaderboard-title');

        // ƒê·ªãnh nghƒ©a c√°c h·∫±ng s·ªë cho key trong data (t∆∞∆°ng ·ª©ng v·ªõi c·ªôt trong Sheet)
        // C·∫≠p nh·∫≠t ƒë·ªÉ ph√π h·ª£p v·ªõi c·∫•u tr√∫c Sheet: H·∫°ng, H·ªç v√† t√™n, L·ªõp, T·ªïng ƒëi·ªÉm
        const COL_RANK = 'X·∫øp h·∫°ng';   // C·ªôt 5 (E)
        const COL_NAME = 'H·ªç v√† T√™n';   // C·ªôt 2 (B)
        const COL_CLASS = 'L·ªõp';        // C·ªôt 3 (C)
        const COL_SCORE = 'T·ªïng ƒëi·ªÉm';  // C·ªôt 4 (D)

        // H√†m t·∫°o URL CSV t·ª´ config
        const createCsvUrl = (config) => {
            // ƒê·∫£m b·∫£o URL l√† c√¥ng khai (publis on the web)
            return `https://docs.google.com/spreadsheets/d/${config.spreadsheetId}/gviz/tq?tqx=out:csv&gid=${config.gid}`;
        };

        // H√†m chuy·ªÉn ƒë·ªïi CSV th√†nh m·∫£ng ƒë·ªëi t∆∞·ª£ng JavaScript
        function csvToJson(csv) {
            const lines = csv.split('\n').filter(line => line.trim() !== '');
            if (lines.length === 0) return [];

            // T√°ch header (D√≤ng ƒë·∫ßu ti√™n, lo·∫°i b·ªè kho·∫£ng tr·∫Øng d∆∞ th·ª´a)
            const headers = lines[0].split(',').map(header => header.trim().replace(/"/g, ''));

            const result = [];
            for (let i = 1; i < lines.length; i++) {
                const currentline = lines[i];
                if (!currentline) continue;

                // T√°ch d·ª±a tr√™n d·∫•u ph·∫©y, bao g·ªìm c·∫£ x·ª≠ l√Ω d·∫•u ngo·∫∑c k√©p (n·∫øu c√≥)
                const values = [];
                let match;
                const regex = /(?:^|,)(\"(?:[^\"]+|\"\")*\"|[^,]*)/g;

                while (match = regex.exec(currentline)) {
                    let value = match[1];
                    if (value.startsWith(',')) value = value.substring(1);
                    value = value.trim().replace(/^"|"$/g, '').trim();
                    values.push(value);
                }

                if (values.length !== headers.length) continue;

                const obj = {};
                for (let j = 0; j < headers.length; j++) {
                    obj[headers[j]] = values[j];
                }

                // Ch·ªâ l·∫•y c√°c ƒë·ªëi t∆∞·ª£ng c√≥ ƒë·ªß tr∆∞·ªùng T√™n v√† ƒêi·ªÉm
                if (obj[COL_NAME] && obj[COL_SCORE] && obj[COL_RANK]) { // ƒê·∫£m b·∫£o c√≥ ƒë·ªß 3 c·ªôt c·∫ßn thi·∫øt
                     // Chuy·ªÉn ƒêi·ªÉm S·ªë v√† X·∫øp h·∫°ng th√†nh s·ªë
                    obj[COL_SCORE] = parseFloat(obj[COL_SCORE].replace(/[^0-9.]/g, '')) || 0;
                    // L·∫•y H·∫°ng t·ª´ c·ªôt "X·∫øp h·∫°ng" (c√≥ th·ªÉ l√† s·ªë ho·∫∑c chu·ªói)
                    obj[COL_RANK] = parseInt(obj[COL_RANK]) || 0; 
                    result.push(obj);
                }
            }
            return result;
        }

        // H√†m s·∫Øp x·∫øp b·∫£ng x·∫øp h·∫°ng (ch·ªâ d·ª±a v√†o T·ªïng ƒëi·ªÉm) - Gi·ªØ nguy√™n v√¨ ƒëi·ªÉm v·∫´n l√† y·∫øu t·ªë ch√≠nh
        function sortData(data) {
            // S·∫Øp x·∫øp gi·∫£m d·∫ßn theo T·ªïng ƒëi·ªÉm
            return data.sort((a, b) => b[COL_SCORE] - a[COL_SCORE]);
        }

        // H√†m render d·ªØ li·ªáu ra b·∫£ng HTML
        function renderLeaderboard(data) {
            leaderboardBody.innerHTML = '';

            if (data.length === 0) {
                // C·∫≠p nh·∫≠t colspan t·ª´ 3 l√™n 4
                leaderboardBody.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-gray-500 font-semibold">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu h·ª£p l·ªá trong Sheet n√†y.</td></tr>';
                return;
            }

            const sortedData = sortData(data);

            sortedData.forEach((row, index) => {
                // L·∫•y h·∫°ng tr·ª±c ti·∫øp t·ª´ c·ªôt 'X·∫øp h·∫°ng' c·ªßa Sheet
                const rank = row[COL_RANK]; 
                let rankClasses = 'bg-white text-gray-800';
                let rankSymbol = rank;
                let rowClasses = '';

                // C·∫≠p nh·∫≠t: √Åp d·ª•ng class, k√≠ch th∆∞·ªõc ch·ªØ v√† m√†u s·∫Øc r·ª±c r·ª° cho Top 3
                let nameTextSize = 'text-base font-medium text-gray-900';
                let scoreTextSize = 'text-sm font-semibold text-indigo-600';
                // Style cho c·ªôt L·ªõp (m·ªõi)
                let classTextSize = 'text-sm font-semibold text-gray-700';

                if (rank === 1) {
                    rankClasses = 'rank-gold font-extrabold text-lg';
                    rankSymbol = 'ü•á ' + rank;
                    rowClasses = 'top-rank-row shadow-lg bg-yellow-50'; // H√†ng n·ªÅn v√†ng nh·∫°t
                    nameTextSize = 'text-xl font-extrabold text-indigo-800';
                    scoreTextSize = 'text-xl font-extrabold text-red-600';
                    classTextSize = 'text-base font-extrabold text-green-700';
                } else if (rank === 2) {
                    rankClasses = 'rank-silver font-bold';
                    rankSymbol = 'ü•à ' + rank;
                    rowClasses = 'top-rank-row shadow-lg bg-gray-100'; // H√†ng n·ªÅn x√°m nh·∫°t
                    nameTextSize = 'text-lg font-bold text-gray-800';
                    scoreTextSize = 'text-lg font-bold text-orange-500';
                    classTextSize = 'text-base font-bold text-green-600';
                } else if (rank === 3) {
                    rankClasses = 'rank-bronze font-bold text-white';
                    rankSymbol = 'ü•â ' + rank;
                    rowClasses = 'top-rank-row shadow-lg bg-amber-50'; // H√†ng n·ªÅn cam nh·∫°t
                    nameTextSize = 'text-lg font-bold text-gray-700';
                    scoreTextSize = 'text-lg font-bold text-indigo-500';
                    classTextSize = 'text-base font-bold text-green-500';
                } else if (rank <= 10) {
                    rankSymbol = '‚≠ê ' + rank;
                } else {
                    rankSymbol = rank; // D√πng h·∫°ng t·ª´ sheet cho t·∫•t c·∫£ c√°c h√†ng
                }

                const rowHtml = `
                    <tr class="${rowClasses} transition duration-150">
                        <td class="px-6 py-3 whitespace-nowrap text-center text-sm ${rankClasses} rounded-lg border-r-4 border-white">${rankSymbol}</td>
                        <td class="px-6 py-3 whitespace-nowrap ${nameTextSize}">${row[COL_NAME]}</td>
                        <td class="px-6 py-3 whitespace-nowrap ${classTextSize}">${row[COL_CLASS] || 'N/A'}</td> <!-- HI·ªÇN TH·ªä L·ªöP -->
                        <td class="px-6 py-3 whitespace-nowrap ${scoreTextSize}">${row[COL_SCORE].toLocaleString()}</td>
                    </tr>
                `;
                leaderboardBody.innerHTML += rowHtml;
            });
        }

        // H√†m ch√≠nh ƒë·ªÉ t·∫£i d·ªØ li·ªáu
        async function fetchLeaderboardData(key) {
            const config = GOOGLE_SHEET_CONFIG[key];
            if (!config) return;

            const url = createCsvUrl(config);
            currentTitle.textContent = config.title;

            loadingIndicator.classList.remove('hidden');
            refreshIcon.classList.add('hidden');
            errorMsg.classList.add('hidden');
            // C·∫≠p nh·∫≠t colspan t·ª´ 3 l√™n 4
            leaderboardBody.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-indigo-500 font-semibold">ƒêang t·∫£i d·ªØ li·ªáu... üöÄ</td></tr>';

            try {
                // ƒê·ª£i Tone.js kh·ªüi ƒë·ªông (quan tr·ªçng cho l·∫ßn nh·∫•p ƒë·∫ßu ti√™n)
                await Tone.start();

                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`L·ªói t·∫£i d·ªØ li·ªáu. H√£y ki·ªÉm tra c√†i ƒë·∫∑t "Xu·∫•t b·∫£n l√™n web" cho Sheet ID ${config.spreadsheetId} v√† gid ${config.gid}.`);
                }
                const csvText = await response.text();
                const data = csvToJson(csvText);

                renderLeaderboard(data);
                playCheerSound();
                localStorage.setItem('leaderboardSelection', key); // L∆∞u l·ª±a ch·ªçn hi·ªán t·∫°i

            } catch (error) {
                console.error("L·ªñI T·∫¢I D·ªÆ LI·ªÜU:", error);
                errorMsg.textContent = `L·ªói t·∫£i [${config.title}]: ${error.message}`;
                errorMsg.classList.remove('hidden');
                // C·∫≠p nh·∫≠t colspan t·ª´ 3 l√™n 4
                leaderboardBody.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-red-500 font-semibold">T·∫£i th·∫•t b·∫°i. Vui l√≤ng xem console ho·∫∑c ki·ªÉm tra URL/c√†i ƒë·∫∑t c√¥ng khai.</td></tr>';
            } finally {
                loadingIndicator.classList.add('hidden');
                refreshIcon.classList.remove('hidden');
            }
        }

        // H√†m kh·ªüi t·∫°o Dropdown v√† Listener
        function initApp() {
            const configKeys = Object.keys(GOOGLE_SHEET_CONFIG);
            
            // --- DEBUG CHECK ---
            console.log(`[DEBUG] S·ªë l∆∞·ª£ng c·∫•u h√¨nh b·∫£ng x·∫øp h·∫°ng ƒë∆∞·ª£c t·∫£i: ${configKeys.length}`);
            // -------------------
            
            if (configKeys.length === 0) {
                 errorMsg.textContent = 'L·ªói c·∫•u h√¨nh: Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu b·∫£ng x·∫øp h·∫°ng n√†o ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a.';
                 errorMsg.classList.remove('hidden');
                 return;
            }

            // 1. T·∫°o Options cho Dropdown (Bao g·ªìm Placeholder)
            // Th√™m t√πy ch·ªçn r·ªóng/placeholder ·ªü ƒë·∫ßu v√† ƒë·∫∑t n√≥ l√† 'disabled' v√† 'selected'
            let optionsHtml = '<option value="" disabled selected>--- Ch·ªçn B·∫£ng X·∫øp H·∫°ng ---</option>'; 
            for (const key of configKeys) {
                optionsHtml += `<option value="${key}">${GOOGLE_SHEET_CONFIG[key].title}</option>`;
            }
            sheetSelector.innerHTML = optionsHtml;

            // 2. T·∫£i Sheet ƒë√£ l∆∞u ho·∫∑c ƒë·ªÉ Placeholder ƒë∆∞·ª£c ch·ªçn
            const savedKey = localStorage.getItem('leaderboardSelection'); // Kh√¥ng ƒë·∫∑t gi√° tr·ªã m·∫∑c ƒë·ªãnh ban ƒë·∫ßu
            let initialKey = null;

            if (savedKey && GOOGLE_SHEET_CONFIG[savedKey]) {
                // N·∫øu c√≥ key ƒë√£ l∆∞u v√† h·ª£p l·ªá, ch·ªçn n√≥ v√† t·∫£i d·ªØ li·ªáu
                initialKey = savedKey;
                sheetSelector.value = initialKey;
                fetchLeaderboardData(initialKey);
            } else {
                 // Kh√¥ng c√≥ key ƒë∆∞·ª£c l∆∞u, ho·∫∑c key kh√¥ng h·ª£p l·ªá, gi·ªØ placeholder ƒë∆∞·ª£c ch·ªçn
                sheetSelector.value = ""; 
                // C·∫≠p nh·∫≠t colspan t·ª´ 3 l√™n 4
                leaderboardBody.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-gray-500 font-semibold">Vui l√≤ng ch·ªçn m·ªôt B·∫£ng X·∫øp H·∫°ng ·ªü tr√™n ƒë·ªÉ xem d·ªØ li·ªáu.</td></tr>';
                currentTitle.textContent = "Ch∆∞a Ch·ªçn";
            }
            
            // 3. L·∫Øng nghe s·ª± ki·ªán thay ƒë·ªïi Dropdown
            sheetSelector.addEventListener('change', (e) => {
                const selectedKey = e.target.value;
                if (selectedKey) { // ƒê·∫£m b·∫£o kh√¥ng g·ªçi v·ªõi gi√° tr·ªã r·ªóng c·ªßa placeholder
                    fetchLeaderboardData(selectedKey);
                    errorMsg.classList.add('hidden'); // ·∫®n l·ªói n·∫øu ch·ªçn th√†nh c√¥ng
                }
            });

            // 4. L·∫Øng nghe s·ª± ki·ªán T·∫£i L·∫°i
            refreshBtn.addEventListener('click', () => {
                const selectedKey = sheetSelector.value;
                if (selectedKey) { // Ch·ªâ t·∫£i l·∫°i n·∫øu ƒë√£ c√≥ key ƒë∆∞·ª£c ch·ªçn
                    fetchLeaderboardData(selectedKey);
                } else {
                    errorMsg.textContent = 'Vui l√≤ng ch·ªçn m·ªôt B·∫£ng X·∫øp H·∫°ng tr∆∞·ªõc khi t·∫£i l·∫°i.';
                    errorMsg.classList.remove('hidden');
                }
            });
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
