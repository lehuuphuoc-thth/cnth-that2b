<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Th√°m t·ª≠ Tin h·ªçc: Nhi·ªám v·ª• thu th·∫≠p th√¥ng tin</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');

        :root {
            --color-primary: #4CAF50; /* Green */
            --color-secondary: #FFC107; /* Amber */
            --color-background: #E8F5E9; /* Light Green */
            --color-card: #FFFFFF;
            --color-text: #333333;
            --color-correct: #8BC34A;
            --color-wrong: #FF5722;
            --color-blue: #2196F3;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, var(--color-background) 0%, #B9F6CA 100%);
            color: var(--color-text);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            overflow-y: auto;
        }

        .game-container {
            width: 100%;
            max-width: 900px;
            background: var(--color-card);
            border-radius: 20px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
            padding: 30px;
            position: relative;
            min-height: 600px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        h1, h2 {
            text-align: center;
            color: var(--color-primary);
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        /* --- Global Button Style --- */
        button {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 0 var(--color-primary);
            background: var(--color-primary);
            color: white;
            text-transform: uppercase;
        }

        button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 6px 0 var(--color-primary);
        }

        button:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 var(--color-primary);
        }
        
        /* --- Ph·∫ßn 1: ƒêi·ªÅn th√¥ng tin --- */
        #info-screen {
            text-align: center;
            padding: 50px 20px;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
            max-width: 400px;
            margin: 0 auto 20px auto;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--color-blue);
        }

        .input-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--color-blue);
            border-radius: 8px;
            font-size: 1em;
            box-sizing: border-box;
        }

        #start-btn {
            background: var(--color-blue);
            box-shadow: 0 4px 0 #1565C0;
        }
        #start-btn:hover {
            box-shadow: 0 6px 0 #1565C0;
        }
        #start-btn:active {
            box-shadow: 0 2px 0 #1565C0;
        }

        /* --- Ph·∫ßn 2: N·ªôi dung tr√≤ ch∆°i --- */
        #game-screen {
            display: none;
            position: relative;
            padding: 20px;
        }

        .progress-bar {
            height: 25px;
            background-color: #f3f3f3;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
            border: 2px solid var(--color-primary);
        }

        .progress {
            height: 100%;
            width: 0%;
            background-color: var(--color-primary);
            transition: width 0.5s ease-in-out;
            border-radius: 8px;
            line-height: 20px;
            text-align: center;
            color: white;
            font-weight: bold;
        }

        .challenge-info {
            text-align: center;
            margin-bottom: 20px;
        }

        .challenge-box {
            background: #fff;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            min-height: 300px;
        }

        .question-text {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 25px;
            color: var(--color-blue);
        }
        
        /* --- D·∫°ng c√¢u h·ªèi: Multiple Choice, True/False --- */
        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .option-btn {
            background: #FFECB3; /* Light secondary */
            color: var(--color-text);
            padding: 15px;
            border: 2px solid var(--color-secondary);
            font-size: 1.1em;
            text-align: left;
            border-radius: 10px;
            transition: all 0.2s;
            box-shadow: 0 3px 0 var(--color-secondary);
        }

        .option-btn:hover {
            background: #FFE082;
        }

        .option-btn.selected {
            border-color: var(--color-blue);
            background: #BBDEFB; /* Light Blue */
            box-shadow: 0 3px 0 var(--color-blue);
            transform: scale(1.02);
            font-weight: bold;
        }
        
        /* True/False specific */
        .true-false-options {
            grid-template-columns: 1fr 1fr;
            max-width: 500px;
            margin: 0 auto;
        }
        
        /* Next Button */
        #next-challenge-btn {
            display: block;
            margin: 20px auto 0;
            width: 50%;
            background: var(--color-primary);
            box-shadow: 0 4px 0 #388E3C;
        }
        #next-challenge-btn:hover {
            box-shadow: 0 6px 0 #388E3C;
        }
        #next-challenge-btn:active {
            box-shadow: 0 2px 0 #388E3C;
        }
        
        /* --- D·∫°ng c√¢u h·ªèi: N·ªëi c·ªôt (Matching) --- */
        .matching-container {
            display: flex;
            justify-content: space-around;
            gap: 20px;
            user-select: none;
        }

        .column {
            flex-basis: 45%;
            padding: 10px;
            min-height: 200px;
        }

        .match-item {
            background: #B2DFDB; /* Teal light */
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.1s;
            border: 2px solid #009688;
            font-weight: bold;
            box-shadow: 0 2px 0 #00897B;
        }

        .match-item:hover {
            background: #80CBC4;
        }

        .match-item.selected-match {
            border: 3px dashed var(--color-wrong); /* Red dashed for selection */
            background: #FFCDD2; /* Red light for selection */
            box-shadow: none;
        }
        
        .match-item.matched {
             border: 3px solid var(--color-correct); /* Green for matched */
             background: #DCEDC8; /* Light Green */
             cursor: default;
             pointer-events: none;
        }
        
        /* Matching lines with SVG - not implemented in pure JS for simplicity, using visual match */
        /* For simple implementation, we'll only use visual feedback and logical pairing */
        
        /* --- D·∫°ng c√¢u h·ªèi: K√©o th·∫£ (Ordering/S·∫Øp x·∫øp) --- */
        .drag-drop-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 600px;
            margin: 0 auto;
        }

        .drop-item {
            background: #E1F5FE; /* Blue light */
            padding: 15px;
            border-radius: 8px;
            cursor: grab;
            transition: all 0.2s;
            border: 2px solid var(--color-blue);
            font-weight: bold;
            box-shadow: 0 2px 0 #0288D1;
        }

        .drop-item:hover {
            background: #B3E5FC;
        }

        .dragging {
            opacity: 0.5;
            transform: scale(1.05);
        }
        
        /* --- Ph·∫ßn 3: K·∫øt qu·∫£ --- */
        #results-screen {
            display: none;
            text-align: center;
            padding: 30px;
        }

        .results-box {
            background: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            margin: 0 auto;
        }

        .result-item {
            margin-bottom: 10px;
            font-size: 1.1em;
            text-align: left;
            border-bottom: 1px dashed #CCC;
            padding-bottom: 5px;
        }

        .result-item span {
            font-weight: bold;
            color: var(--color-primary);
            float: right;
        }

        #comment {
            font-size: 1.4em;
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            font-style: italic;
            background: #FFF9C4; /* Yellow light */
            color: #FBC02D; /* Darker Yellow */
        }

        #reward-image {
            font-size: 4em;
            margin: 20px 0;
            color: gold;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }
        
        /* Specific result button styles */
        #play-again-btn {
            background: var(--color-primary);
            box-shadow: 0 4px 0 #388E3C;
        }
        #play-again-btn:hover {
            box-shadow: 0 6px 0 #388E3C;
        }
        #play-again-btn:active {
            box-shadow: 0 2px 0 #388E3C;
        }

        #share-btn {
            background: var(--color-blue);
            box-shadow: 0 4px 0 #1565C0;
        }
        #share-btn:hover {
            box-shadow: 0 6px 0 #1565C0;
        }
        #share-btn:active {
            box-shadow: 0 2px 0 #1565C0;
        }
        
        /* T√πy ch·ªânh cho m√†n h√¨nh ch·ª•p ·∫£nh */
        .printable-area {
             background: linear-gradient(135deg, #E8F5E9 0%, #B9F6CA 100%);
             padding: 30px;
             border-radius: 20px;
             box-shadow: none; /* Remove shadow for clean image */
        }
    </style>
</head>
<body>

    <div class="game-container">
        
        <audio id="select-sound" src="https://www.soundjay.com/buttons/button-2.mp3" preload="auto"></audio>
        <audio id="result-sound" src="https://www.soundjay.com/misc/success-bell-edit.mp3" preload="auto"></audio>
        
        <div id="info-screen">
            <h1>TH√ÅM T·ª¨ TIN H·ªåC üïµÔ∏è‚Äç‚ôÇÔ∏è</h1>
            <h2>Nhi·ªám v·ª• thu th·∫≠p th√¥ng tin</h2>
            <p>Ho√†n th√†nh 6 th·ª≠ th√°ch ƒë·ªÉ t√¨m ra l·ªùi gi·∫£i cho v·∫•n ƒë·ªÅ!</p>

            <div class="input-group">
                <label for="player-name">H·ªç v√† t√™n:</label>
                <input type="text" id="player-name" placeholder="Nh·∫≠p H·ªç v√† t√™n c·ªßa em" required>
            </div>
            <div class="input-group">
                <label for="player-class">L·ªõp:</label>
                <input type="text" id="player-class" placeholder="V√≠ d·ª•: 5A1" required>
            </div>

            <button id="start-btn">B·∫ÆT ƒê·∫¶U NHI·ªÜM V·ª§</button>
        </div>

        <div id="game-screen" style="display: none;">
            <div class="challenge-info">
                <div class="progress-bar">
                    <div class="progress" id="progress-indicator"></div>
                </div>
                <h2>Th·ª≠ th√°ch <span id="current-challenge-number">1</span> / <span id="total-challenges"></span></h2>
            </div>
            
            <div class="challenge-box">
                <p class="question-text" id="challenge-text"></p>
                
                <div id="challenge-content">
                    </div>
                
            </div>
            
            <button id="next-challenge-btn" style="display: none;">TI·∫æP T·ª§C</button>
        </div>

        <div id="results-screen" style="display: none;">
            <div class="results-box printable-area" id="printable-area">
                <h1 style="color: var(--color-wrong);">B√ÅO C√ÅO K·∫æT QU·∫¢ NHI·ªÜM V·ª§</h1>
                <h3 style="color: var(--color-blue);">Tin h·ªçc 5 - B√†i h·ªçc:  Th√¥ng tin trong gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ</h3>
                
                <div id="reward-image"></div>
                
                <p id="comment"></p>

                <div class="result-item">H·ªç t√™n: <span id="res-name"></span></div>
                <div class="result-item">L·ªõp: <span id="res-class"></span></div>
                <div class="result-item">S·ªë l·∫ßn ch∆°i: <span id="res-play-count"></span></div>
                <div class="result-item">T·ªïng th·ª≠ th√°ch: <span id="res-total"></span></div>
                <div class="result-item">S·ªë th·ª≠ th√°ch ƒë√∫ng: <span id="res-correct"></span></div>
                <div class="result-item">% ho√†n th√†nh ƒë√∫ng: <span id="res-percentage"></span></div>
                <div class="result-item">Th·ªùi gian ho√†n th√†nh: <span id="res-time"></span></div>
            </div>
            
            <div class="action-buttons">
                <button id="play-again-btn">CH∆†I L·∫†I</button>
                <button id="share-btn">CHIA S·∫∫ K·∫æT QU·∫¢</button>
            </div>
        </div>

    </div>

<script>
    // D·ªØ li·ªáu tr√≤ ch∆°i: M·∫£ng c√°c Th·ª≠ th√°ch (C√¢u h·ªèi)
    const GAME_DATA = [
        {
            id: 1,
            type: 'multiple-choice', // Tr·∫Øc nghi·ªám nhi·ªÅu l·ª±a ch·ªçn
            question: 'Trong qu√° tr√¨nh gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ, b∆∞·ªõc ƒë·∫ßu ti√™n v√† quan tr·ªçng nh·∫•t gi√∫p ta hi·ªÉu r√µ v·∫•n ƒë·ªÅ l√† g√¨?',
            options: [
                'A. Th·ª≠ nghi·ªám ngay c√°c gi·∫£i ph√°p c√≥ s·∫µn.',
                'B. **Thu th·∫≠p th√¥ng tin v√† t√¨m hi·ªÉu v·∫•n ƒë·ªÅ.**',
                'C. K√™u g·ªçi gi√∫p ƒë·ª° m√† kh√¥ng c·∫ßn t√¨m hi·ªÉu.',
                'D. B·ªè qua v·∫•n ƒë·ªÅ v√¨ qu√° kh√≥.'
            ],
            correct_answer: 'B. **Thu th·∫≠p th√¥ng tin v√† t√¨m hi·ªÉu v·∫•n ƒë·ªÅ.**',
            user_answer: null,
            is_correct: false
        },
        {
            id: 2,
            type: 'true-false', // ƒê√∫ng/Sai
            question: 'Khi gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ, ta n√™n thu th·∫≠p m·ªçi th√¥ng tin ta t√¨m ƒë∆∞·ª£c, v√¨ c√†ng nhi·ªÅu th√¥ng tin th√¨ v·∫•n ƒë·ªÅ s·∫Ω c√†ng d·ªÖ gi·∫£i quy·∫øt h∆°n.',
            correct_answer: 'Sai', // C·∫ßn T√åM v√† CH·ªåN th√¥ng tin PH√ô H·ª¢P
            options: ['ƒê√∫ng', 'Sai'],
            user_answer: null,
            is_correct: false
        },
        {
            id: 3,
            type: 'matching', // N·ªëi c·ªôt
            question: 'H√£y n·ªëi t·∫ßm quan tr·ªçng c·ªßa vi·ªác thu th·∫≠p th√¥ng tin (C·ªôt A) v·ªõi gi·∫£i th√≠ch ph√π h·ª£p (C·ªôt B).',
            items_a: [
                { id: 'a1', text: '1. Gi√∫p hi·ªÉu r√µ g·ªëc r·ªÖ c·ªßa v·∫•n ƒë·ªÅ.' },
                { id: 'a2', text: '2. Gi√∫p ƒë∆∞a ra quy·∫øt ƒë·ªãnh gi·∫£i ph√°p.' },
                { id: 'a3', text: '3. Gi√∫p ti·∫øt ki·ªám th·ªùi gian v√† c√¥ng s·ª©c.' }
            ],
            items_b: [
                { id: 'b1', text: 'A. C√≥ c∆° s·ªü ƒë·ªÉ l·ª±a ch·ªçn c√°ch l√†m ƒë√∫ng.' },
                { id: 'b2', text: 'B. Nh·ªù bi·∫øt ƒë∆∞·ª£c nguy√™n nh√¢n c·ªët l√µi.' },
                { id: 'b3', text: 'C. Tr√°nh ph·∫£i l√†m l·∫°i ho·∫∑c l√†m sai nhi·ªÅu l·∫ßn.' }
            ],
            correct_pairs: { 'a1': 'b2', 'a2': 'b1', 'a3': 'b3' }, // ƒê·ªãnh nghƒ©a c·∫∑p ƒë√∫ng: idA: idB
            user_pairs: {},
            is_correct: false
        },
        {
            id: 4,
            type: 'multiple-choice',
            question: 'ƒê·ªÉ gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ h·ªçc t·∫≠p m·ªôt c√°ch ƒë√°ng tin c·∫≠y, ngu·ªìn th√¥ng tin n√†o sau ƒë√¢y l√† ph√π h·ª£p nh·∫•t?',
            options: [
                'A. L·ªùi ƒë·ªìn t·ª´ b·∫°n b√® trong gi·ªù gi·∫£i lao.',
                'B. Video h∆∞·ªõng d·∫´n tr√™n m·∫°ng x√£ h·ªôi kh√¥ng r√µ ngu·ªìn.',
                'C. **S√°ch gi√°o khoa, l·ªùi gi·∫£i th√≠ch c·ªßa th·∫ßy c√¥, b√°o c√°o khoa h·ªçc.**',
                'D. M·ªôt √Ω ki·∫øn b·∫•t k·ª≥ t·ª´ ng∆∞·ªùi l·∫° tr√™n ƒë∆∞·ªùng.'
            ],
            correct_answer: 'C. **S√°ch gi√°o khoa, l·ªùi gi·∫£i th√≠ch c·ªßa th·∫ßy c√¥, b√°o c√°o khoa h·ªçc.**',
            user_answer: null,
            is_correct: false
        },
        {
            id: 5,
            type: 'drag-drop', // K√©o th·∫£ (S·∫Øp x·∫øp)
            question: 'H√£y s·∫Øp x·∫øp c√°c b∆∞·ªõc c∆° b·∫£n sau trong qu√° tr√¨nh gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ theo th·ª© t·ª± ƒë√∫ng.',
            items: [
                { id: 1, text: 'ƒê√°nh gi√° k·∫øt qu·∫£ sau khi th·ª±c hi·ªán.' },
                { id: 2, text: 'L·∫≠p k·∫ø ho·∫°ch h√†nh ƒë·ªông c·ª• th·ªÉ.' },
                { id: 3, text: 'T√¨m hi·ªÉu v√† thu th·∫≠p th√¥ng tin v·ªÅ v·∫•n ƒë·ªÅ.' },
                { id: 4, text: 'Th·ª±c hi·ªán gi·∫£i ph√°p theo k·∫ø ho·∫°ch.' }
            ],
            correct_order: [3, 2, 4, 1], // Th·ª© t·ª± ID ƒë√∫ng
            user_order: [],
            is_correct: false
        },
        {
            id: 6,
            type: 'true-false',
            question: 'Khi l√†m vi·ªác nh√≥m ƒë·ªÉ gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ, ch·ªâ c·∫ßn m·ªôt ng∆∞·ªùi thu th·∫≠p th√¥ng tin l√† ƒë·ªß, nh·ªØng ng∆∞·ªùi kh√°c ch·ªâ c·∫ßn ƒë·ª£i k·∫øt qu·∫£.',
            correct_answer: 'Sai', // C·∫ßn s·ª± h·ª£p t√°c, m·ªói ng∆∞·ªùi g√≥p m·ªôt ph·∫ßn
            options: ['ƒê√∫ng', 'Sai'],
            user_answer: null,
            is_correct: false
        }
    ];

    let gameState = {
        player: { name: '', className: '', playCount: 0, bestScore: 0 },
        currentChallengeIndex: 0,
        startTime: null,
        endTime: null,
        challenges: [], // S·∫Ω ch·ª©a m·∫£ng GAME_DATA ƒë√£ x√°o tr·ªôn
        isChallengeCompleted: false,
    };
    
    // Kh·ªüi t·∫°o c√°c ph·∫ßn t·ª≠ DOM
    const DOM = {
        infoScreen: document.getElementById('info-screen'),
        gameScreen: document.getElementById('game-screen'),
        resultsScreen: document.getElementById('results-screen'),
        playerNameInput: document.getElementById('player-name'),
        playerClassInput: document.getElementById('player-class'),
        startBtn: document.getElementById('start-btn'),
        
        // Game UI
        currentChallengeNumber: document.getElementById('current-challenge-number'),
        totalChallenges: document.getElementById('total-challenges'),
        progressIndicator: document.getElementById('progress-indicator'),
        challengeText: document.getElementById('challenge-text'),
        challengeContent: document.getElementById('challenge-content'),
        nextChallengeBtn: document.getElementById('next-challenge-btn'),
        
        // Results UI
        printableArea: document.getElementById('printable-area'),
        resName: document.getElementById('res-name'),
        resClass: document.getElementById('res-class'),
        resPlayCount: document.getElementById('res-play-count'),
        resTotal: document.getElementById('res-total'),
        resCorrect: document.getElementById('res-correct'),
        resPercentage: document.getElementById('res-percentage'),
        resTime: document.getElementById('res-time'),
        comment: document.getElementById('comment'),
        rewardImage: document.getElementById('reward-image'),
        playAgainBtn: document.getElementById('play-again-btn'),
        shareBtn: document.getElementById('share-btn'),

        // Audio
        selectSound: document.getElementById('select-sound'),
        resultSound: document.getElementById('result-sound'),
    };
    
    // --- Utils ---
    /** H√†m x√°o tr·ªôn m·∫£ng (Fisher-Yates) */
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function playSound(element) {
        element.currentTime = 0;
        element.play().catch(e => console.log("Audio play prevented:", e));
    }
    
    function loadPlayerData() {
        const storedPlayer = localStorage.getItem('detectiveGamePlayer');
        if (storedPlayer) {
            gameState.player = JSON.parse(storedPlayer);
            DOM.playerNameInput.value = gameState.player.name;
            DOM.playerClassInput.value = gameState.player.className;
        }
        DOM.totalChallenges.textContent = GAME_DATA.length;
    }
    
    function savePlayerResult() {
        const totalCorrect = gameState.challenges.filter(c => c.is_correct).length;
        gameState.player.playCount += 1;
        gameState.player.bestScore = Math.max(gameState.player.bestScore, totalCorrect);
        localStorage.setItem('detectiveGamePlayer', JSON.stringify(gameState.player));
    }

    // --- Part 1 Logic ---
    function startSetup(isReplay = false) {
        if (!isReplay) {
            const name = DOM.playerNameInput.value.trim();
            const className = DOM.playerClassInput.value.trim();
            
            if (!name || !className) {
                alert('Vui l√≤ng nh·∫≠p H·ªç v√† t√™n v√† L·ªõp c·ªßa b·∫°n!');
                return;
            }
            
            gameState.player.name = name;
            gameState.player.className = className;
        }
        
        // Reset game state for a new session
        gameState.currentChallengeIndex = 0;
        gameState.startTime = new Date();
        gameState.challenges = JSON.parse(JSON.stringify(GAME_DATA)); // Deep copy
        shuffleArray(gameState.challenges); // X√°o tr·ªôn th·ª© t·ª± c√°c c√¢u h·ªèi
        
        // Chu·∫©n b·ªã d·ªØ li·ªáu b√™n trong t·ª´ng th·ª≠ th√°ch (vd: x√°o tr·ªôn ƒë√°p √°n)
        gameState.challenges.forEach(challenge => {
            if (challenge.type === 'multiple-choice') {
                shuffleArray(challenge.options);
            } else if (challenge.type === 'drag-drop') {
                shuffleArray(challenge.items);
            }
            challenge.user_answer = null;
            challenge.user_pairs = {};
            challenge.user_order = [];
            challenge.is_correct = false;
        });

        DOM.infoScreen.style.display = 'none';
        DOM.resultsScreen.style.display = 'none';
        DOM.gameScreen.style.display = 'flex';
        
        renderChallenge();
    }
    
    DOM.startBtn.addEventListener('click', () => startSetup(false));

    // --- Part 2 Logic (Game) ---
    function updateProgress() {
        const total = gameState.challenges.length;
        const current = gameState.currentChallengeIndex;
        const percent = (current / total) * 100;
        
        DOM.progressIndicator.style.width = `${percent}%`;
        DOM.progressIndicator.textContent = `${current}/${total}`;
        
        DOM.currentChallengeNumber.textContent = current + 1; // S·ªë th·ª© t·ª± hi·ªÉn th·ªã lu√¥n l√† challenge hi·ªán t·∫°i + 1
    }

    function renderChallenge() {
        if (gameState.currentChallengeIndex >= gameState.challenges.length) {
            // Ho√†n th√†nh tr√≤ ch∆°i
            gameState.endTime = new Date();
            savePlayerResult();
            showResults();
            return;
        }

        DOM.nextChallengeBtn.style.display = 'none';
        gameState.isChallengeCompleted = false;

        const currentChallenge = gameState.challenges[gameState.currentChallengeIndex];
        
        // C·∫≠p nh·∫≠t t√™n th·ª≠ th√°ch
        DOM.currentChallengeNumber.textContent = gameState.currentChallengeIndex + 1;
        DOM.challengeText.textContent = currentChallenge.question;
        DOM.challengeContent.innerHTML = '';
        updateProgress();

        // Render theo lo·∫°i c√¢u h·ªèi
        switch (currentChallenge.type) {
            case 'multiple-choice':
            case 'true-false':
                renderMultipleChoice(currentChallenge);
                break;
            case 'matching':
                renderMatching(currentChallenge);
                break;
            case 'drag-drop':
                renderDragDrop(currentChallenge);
                break;
        }
    }

    // --- Question Type Renderers ---
    
    // Tr·∫Øc nghi·ªám & ƒê√∫ng/Sai
    function renderMultipleChoice(challenge) {
        const isTrueFalse = challenge.type === 'true-false';
        const container = document.createElement('div');
        container.className = isTrueFalse ? 'options-grid true-false-options' : 'options-grid';

        challenge.options.forEach(optionText => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerHTML = optionText;
            btn.onclick = () => handleMultipleChoice(challenge, optionText, btn);
            container.appendChild(btn);
        });
        
        DOM.challengeContent.appendChild(container);
    }
    
    function handleMultipleChoice(challenge, selectedAnswer, btn) {
        if (gameState.isChallengeCompleted) return;
        
        playSound(DOM.selectSound);
        
        // C·∫≠p nh·∫≠t giao di·ªán: ƒê√°nh d·∫•u l·ª±a ch·ªçn
        document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        
        // L∆∞u k·∫øt qu·∫£ ng∆∞·ªùi ch∆°i
        challenge.user_answer = selectedAnswer;
        challenge.is_correct = (selectedAnswer === challenge.correct_answer);
        
        gameState.isChallengeCompleted = true;
        DOM.nextChallengeBtn.style.display = 'block';
    }

    // N·ªëi c·ªôt (Matching)
    let selectedA = null;

    function renderMatching(challenge) {
        const container = document.createElement('div');
        container.className = 'matching-container';

        const colA = document.createElement('div');
        colA.className = 'column column-a';
        
        const colB = document.createElement('div');
        colB.className = 'column column-b';
        
        // Shuffle B column for randomness
        const shuffledB = shuffleArray(challenge.items_b);

        challenge.items_a.forEach(item => {
            const div = document.createElement('div');
            div.className = 'match-item item-a';
            div.id = item.id;
            div.textContent = item.text;
            div.onclick = () => handleMatching(challenge, item.id, 'A', div);
            colA.appendChild(div);
        });

        shuffledB.forEach(item => {
            const div = document.createElement('div');
            div.className = 'match-item item-b';
            div.id = item.id;
            div.textContent = item.text;
            div.onclick = () => handleMatching(challenge, item.id, 'B', div);
            colB.appendChild(div);
        });

        container.appendChild(colA);
        container.appendChild(colB);
        DOM.challengeContent.appendChild(container);
    }

    function handleMatching(challenge, itemId, column, element) {
        if (gameState.isChallengeCompleted) return;
        playSound(DOM.selectSound);

        if (column === 'A') {
            // B·ªè ch·ªçn m·ª•c A c≈©
            if (selectedA) {
                document.getElementById(selectedA).classList.remove('selected-match');
            }
            
            // Ch·ªçn m·ª•c A m·ªõi
            selectedA = itemId;
            element.classList.add('selected-match');
        } else if (column === 'B' && selectedA) {
            // ƒê√£ c√≥ A ƒë∆∞·ª£c ch·ªçn, ti·∫øn h√†nh n·ªëi
            
            // L∆∞u c·∫∑p n·ªëi (A -> B)
            challenge.user_pairs[selectedA] = itemId;
            
            // ƒê√°nh d·∫•u ƒë√£ n·ªëi tr√™n giao di·ªán
            element.classList.add('matched');
            document.getElementById(selectedA).classList.add('matched');
            
            // Lo·∫°i b·ªè tr·∫°ng th√°i ch·ªçn
            document.getElementById(selectedA).classList.remove('selected-match');
            selectedA = null;
            
            // Ki·ªÉm tra ho√†n th√†nh
            if (Object.keys(challenge.user_pairs).length === challenge.items_a.length) {
                checkMatchingComplete(challenge);
            }
        }
    }

    function checkMatchingComplete(challenge) {
        let isCorrect = true;
        
        for (const [idA, idB] of Object.entries(challenge.correct_pairs)) {
            if (challenge.user_pairs[idA] !== idB) {
                isCorrect = false;
                break;
            }
        }
        
        challenge.is_correct = isCorrect;
        gameState.isChallengeCompleted = true;
        DOM.nextChallengeBtn.style.display = 'block';
    }

    // K√©o th·∫£ (Drag-Drop/Ordering)
    let draggedItem = null;

    function renderDragDrop(challenge) {
        const container = document.createElement('div');
        container.className = 'drag-drop-container';

        // T·∫°o b·∫£n sao c·ªßa m·∫£ng items ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh nguy√™n b·∫£n c·ªßa challenge.items
        const shuffledItems = challenge.items;

        shuffledItems.forEach(item => {
            const div = document.createElement('div');
            div.className = 'drop-item';
            div.id = `item-${item.id}`;
            div.textContent = item.text;
            div.draggable = true;
            
            div.addEventListener('dragstart', (e) => {
                draggedItem = div;
                setTimeout(() => div.classList.add('dragging'), 0);
            });

            div.addEventListener('dragend', () => {
                draggedItem.classList.remove('dragging');
                draggedItem = null;
                // Sau khi th·∫£, c·∫≠p nh·∫≠t th·ª© t·ª± v√† ki·ªÉm tra
                updateDragDropOrder(challenge, container);
            });

            div.addEventListener('dragover', (e) => {
                e.preventDefault(); // Cho ph√©p th·∫£
                const boundingBox = div.getBoundingClientRect();
                const offset = boundingBox.y + boundingBox.height / 2;
                if (e.clientY < offset) {
                    container.insertBefore(draggedItem, div);
                } else {
                    container.insertBefore(draggedItem, div.nextSibling);
                }
            });
            
            div.addEventListener('dragleave', () => {});
            div.addEventListener('drop', (e) => { e.preventDefault(); });
            
            container.appendChild(div);
        });

        DOM.challengeContent.appendChild(container);
    }

    function updateDragDropOrder(challenge, container) {
        const items = Array.from(container.children);
        const userOrder = items.map(item => parseInt(item.id.replace('item-', '')));
        
        challenge.user_order = userOrder;
        
        // Ki·ªÉm tra ƒë√∫ng/sai (Ch·∫•p nh·∫≠n k·∫øt qu·∫£ ngay sau khi th·∫£ l·∫ßn cu·ªëi)
        let isCorrect = challenge.correct_order.length === userOrder.length && 
                        challenge.correct_order.every((val, index) => val === userOrder[index]);
                        
        challenge.is_correct = isCorrect;
        
        // K√≠ch ho·∫°t n√∫t ti·∫øp t·ª•c ngay sau khi thao t√°c
        gameState.isChallengeCompleted = true;
        DOM.nextChallengeBtn.style.display = 'block';
    }

    DOM.nextChallengeBtn.addEventListener('click', () => {
        if (!gameState.isChallengeCompleted) {
            alert('Vui l√≤ng ho√†n th√†nh th·ª≠ th√°ch tr∆∞·ªõc khi ti·∫øp t·ª•c!');
            return;
        }

        gameState.currentChallengeIndex++;
        if (gameState.currentChallengeIndex < gameState.challenges.length) {
            // T·∫°m d·ª´ng 1 ch√∫t ƒë·ªÉ c√≥ hi·ªáu ·ª©ng chuy·ªÉn c·∫£nh
            setTimeout(renderChallenge, 300);
        } else {
            // Ho√†n th√†nh tr√≤ ch∆°i
            gameState.endTime = new Date();
            savePlayerResult();
            showResults();
        }
    });

    // --- Part 3 Logic (Results) ---
    function showResults() {
        DOM.gameScreen.style.display = 'none';
        DOM.infoScreen.style.display = 'none';
        DOM.resultsScreen.style.display = 'flex';
        
        playSound(DOM.resultSound);

        const totalChallenges = gameState.challenges.length;
        const correctChallenges = gameState.challenges.filter(c => c.is_correct).length;
        const percentage = totalChallenges > 0 ? Math.round((correctChallenges / totalChallenges) * 100) : 0;
        const timeTaken = Math.round((gameState.endTime - gameState.startTime) / 1000); // in seconds
        
        // Display Info
        DOM.resName.textContent = gameState.player.name;
        DOM.resClass.textContent = gameState.player.className;
        DOM.resPlayCount.textContent = gameState.player.playCount;
        DOM.resTotal.textContent = totalChallenges;
        DOM.resCorrect.textContent = correctChallenges;
        DOM.resPercentage.textContent = `${percentage}%`;
        DOM.resTime.textContent = `${Math.floor(timeTaken / 60)} ph√∫t ${timeTaken % 60} gi√¢y`;
        
        // Display Comment & Reward
        let commentText = '';
        let rewardIcon = '‚ú®';

        if (percentage === 100) {
            commentText = 'üéâ Tuy·ªát v·ªùi! B·∫°n ƒë√£ ho√†n th√†nh xu·∫•t s·∫Øc 100% nhi·ªám v·ª•. B·∫°n l√† m·ªôt Th√°m t·ª≠ Tin h·ªçc t√†i ba!';
            rewardIcon = 'ü•á';
        } else if (percentage >= 70) {
            commentText = 'üåü Ho√†n th√†nh t·ªët! B·∫°n ƒë√£ thu th·∫≠p ƒë∆∞·ª£c h·∫ßu h·∫øt th√¥ng tin quan tr·ªçng. H√£y th·ª≠ l·∫°i ƒë·ªÉ ƒë·∫°t k·∫øt qu·∫£ ho√†n h·∫£o nh√©!';
            rewardIcon = 'üèÜ';
        } else if (percentage >= 50) {
            commentText = 'üôÇ C·ªë g·∫Øng h∆°n n·ªØa! B·∫°n ƒë√£ ho√†n th√†nh h∆°n m·ªôt n·ª≠a th·ª≠ th√°ch. Vi·ªác thu th·∫≠p th√¥ng tin r·∫•t quan tr·ªçng, h√£y √¥n l·∫°i b√†i ƒë·ªÉ l·∫ßn sau t·ªët h∆°n!';
            rewardIcon = 'üí°';
        } else {
            commentText = 'üò• B·∫°n c·∫ßn luy·ªán t·∫≠p th√™m! Vi·ªác t√¨m ki·∫øm v√† ch·ªçn l·ªçc th√¥ng tin l√† kƒ© nƒÉng r·∫•t quan tr·ªçng. H√£y √¥n l·∫°i B√†i 3 v√† ch∆°i l·∫°i nh√©!';
            rewardIcon = 'üìö';
        }
        
        DOM.comment.textContent = commentText;
        DOM.rewardImage.textContent = rewardIcon;
    }

    DOM.playAgainBtn.addEventListener('click', () => {
        // Ch∆°i l·∫°i: Gi·ªØ th√¥ng tin ng∆∞·ªùi ch∆°i, tƒÉng s·ªë l·∫ßn ch∆°i
        startSetup(true); 
    });
    
    // Chia s·∫ª k·∫øt qu·∫£ (D√πng html2canvas)
    DOM.shareBtn.addEventListener('click', () => {
        const areaToCapture = DOM.printableArea;
        
        // ·∫®n n√∫t Ch∆°i l·∫°i/Chia s·∫ª trong ·∫£nh ch·ª•p (t√πy ch·ªçn)
        DOM.playAgainBtn.style.display = 'none';
        DOM.shareBtn.style.display = 'none';

        html2canvas(areaToCapture, {
            scale: 2, // TƒÉng ch·∫•t l∆∞·ª£ng ·∫£nh
            backgroundColor: null, // Gi·ªØ n·ªÅn trong su·ªët n·∫øu kh√¥ng set background c·ª• th·ªÉ
        }).then(canvas => {
            // Hi·ªÉn th·ªã l·∫°i n√∫t
            DOM.playAgainBtn.style.display = 'inline-block';
            DOM.shareBtn.style.display = 'inline-block';

            // T·∫°o link download
            const image = canvas.toDataURL("image/png");
            const link = document.createElement('a');
            link.href = image;
            link.download = `Ket_qua_tham_tu_Tin_hoc_${gameState.player.name}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    });

    // Load data khi trang ƒë∆∞·ª£c t·∫£i
    loadPlayerData();
</script>
</body>
</html>
