<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Th√°m t·ª≠ Tin h·ªçc: Nhi·ªám v·ª• Th√¥ng tin (Tin h·ªçc 5)</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;700&display=swap');

        :root {
            --color-primary: #3498db; /* Blue */
            --color-secondary: #e74c3c; /* Red */
            --color-accent: #f1c40f; /* Yellow */
            --color-success: #2ecc71; /* Green */
            --color-background: #ecf0f1; /* Light Grey */
            --color-text: #2c3e50; /* Dark Blue */
            --color-card: #ffffff;
            --color-shadow: rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Chakra Petch', sans-serif;
            background: linear-gradient(135deg, #a8dadc 0%, #457b9d 100%);
            color: var(--color-text);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            overflow-y: auto;
            animation: backgroundShift 20s infinite alternate;
        }

        @keyframes backgroundShift {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }

        .container {
            background-color: var(--color-card);
            border-radius: 20px;
            box-shadow: 0 10px 30px var(--color-shadow);
            padding: 30px;
            max-width: 800px;
            width: 100%;
            text-align: center;
            overflow: hidden;
            position: relative;
        }

        h1 {
            color: var(--color-secondary);
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 0 #f1c40f;
        }

        h2 {
            color: var(--color-primary);
            font-size: 1.8em;
            margin-top: 0;
        }

        /* --- PH·∫¶N 1: ƒêI·ªÄN TH√îNG TIN --- */
        #part1 {
            padding: 40px 20px;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 1.1em;
            color: var(--color-primary);
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--color-primary);
            border-radius: 10px;
            box-sizing: border-box;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            border-color: var(--color-secondary);
            outline: none;
        }

        .btn {
            background-color: var(--color-success);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: bold;
            transition: transform 0.2s, background-color 0.2s;
            box-shadow: 0 4px 0 #27ae60;
            text-transform: uppercase;
            margin: 5px;
        }

        .btn:hover {
            background-color: #27ae60;
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #1e8449;
        }

        .btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #1e8449;
        }

        /* --- PH·∫¶N 2: N·ªòI DUNG TR√í CH∆†I --- */
        #part2 {
            display: none;
            padding: 20px 0;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 20px;
            background-color: var(--color-primary);
            color: white;
            border-radius: 10px;
            font-size: 1.1em;
        }

        .challenge-box {
            background-color: #ffeaa7; /* Light Yellow */
            padding: 20px;
            border-radius: 15px;
            border: 3px dashed var(--color-accent);
            margin-bottom: 20px;
        }

        .question-text {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 25px;
            color: #d35400; /* Orange */
            min-height: 50px;
        }

        /* Multiple Choice & True/False */
        .options-list {
            list-style: none;
            padding: 0;
            text-align: left;
            margin: 0 -10px;
        }

        .option-item {
            background-color: #f6f6f6;
            border: 2px solid var(--color-primary);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 10px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s, border-color 0.2s;
            box-shadow: 0 3px 0 var(--color-primary);
            font-size: 1.1em;
            display: flex;
            align-items: center;
        }

        .option-item:hover {
            background-color: #d1e2f3;
            transform: translateY(-1px);
        }

        .option-item.selected {
            background-color: var(--color-accent);
            border-color: var(--color-secondary);
            box-shadow: 0 3px 0 var(--color-secondary);
            transform: scale(1.02);
            color: var(--color-text);
        }

        .option-label {
            font-weight: bold;
            margin-right: 10px;
            color: var(--color-secondary);
        }

        .action-button-group {
            margin-top: 20px;
        }

        /* Drag-Drop & N·ªëi c·ªôt specific styles */
        .drag-drop-container, .matching-container {
            display: flex;
            justify-content: space-around;
            text-align: center;
            gap: 20px;
            margin-top: 20px;
        }

        .drag-list, .match-list-a, .match-list-b {
            flex: 1;
            padding: 10px;
            min-height: 200px;
            border-radius: 10px;
            background-color: #fff;
            border: 2px solid #bdc3c7;
        }
        
        .match-list-a, .match-list-b {
            position: relative;
            z-index: 10;
        }

        .drag-item, .match-item {
            background-color: #f39c12; /* Orange */
            color: white;
            padding: 10px;
            margin: 8px 0;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 3px 0 #e67e22;
            font-weight: bold;
            transition: background-color 0.2s, transform 0.2s;
        }

        .match-item {
            background-color: var(--color-primary);
            box-shadow: 0 3px 0 #2980b9;
        }

        .drag-item:active {
            cursor: grabbing;
        }

        .drop-target {
            background-color: #ecf0f1;
            padding: 15px;
            border: 2px dashed var(--color-text);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        /* N·ªëi c·ªôt Canvas */
        .matching-area-wrapper {
            position: relative;
        }
        
        #matching-canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 5;
            pointer-events: none; /* Allows clicks to pass through to items */
        }
        
        .match-item.selected-for-match {
            border: 4px solid var(--color-secondary);
            transform: scale(1.05);
        }

        /* --- PH·∫¶N 3: K·∫æT QU·∫¢ --- */
        #part3 {
            display: none;
            padding: 40px 20px;
        }

        #result-card {
            background-color: #fff3c9; /* Light Yellow-Orange */
            border: 5px solid var(--color-accent);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .result-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
            text-align: left;
        }

        .stat-item {
            background-color: #f6f6f6;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--color-shadow);
            font-size: 1.1em;
        }

        .stat-label {
            font-weight: bold;
            color: var(--color-primary);
        }

        .stat-value {
            color: var(--color-secondary);
            font-weight: 700;
        }

        #reward-image {
            font-size: 4em;
            margin: 20px 0;
            animation: pulse 1s infinite alternate;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.1); }
        }

        #result-comment {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--color-success);
            margin-top: 15px;
        }
    </style>
</head>
<body>

    <div class="container">
        
        <div id="part1">
            <h1 class="game-title">Th√°m t·ª≠ Tin h·ªçc</h1>
            <h2>Nhi·ªám v·ª• Th√¥ng tin</h2>
            <p>M√¥n Tin h·ªçc 5 - B√†i 3: Th√¥ng tin trong gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ</p>

            <div class="input-group">
                <label for="playerName"><span class="option-label">üìù</span> H·ªç v√† T√™n:</label>
                <input type="text" id="playerName" placeholder="Nh·∫≠p H·ªç v√† T√™n c·ªßa em">
            </div>
            <div class="input-group">
                <label for="playerClass"><span class="option-label">üè´</span> L·ªõp:</label>
                <input type="text" id="playerClass" placeholder="V√≠ d·ª•: 5A1">
            </div>

            <button class="btn" onclick="checkAndStartGame()">B·∫ÆT ƒê·∫¶U <span class="option-label">üöÄ</span></button>
        </div>

        <div id="part2">
            <div class="game-header">
                <div id="challenge-status">Th·ª≠ th√°ch 1/5</div>
                <div id="timer">Th·ªùi gian: 00:00</div>
            </div>
            
            <div class="challenge-box">
                <p class="question-text" id="question-content"></p>
                <div id="question-area">
                    </div>
            </div>

            <div class="action-button-group">
                <button class="btn" id="submitBtn" onclick="submitAnswer()">Ho√†n th√†nh Th·ª≠ th√°ch <span class="option-label">‚úÖ</span></button>
                <button class="btn" id="nextBtn" onclick="nextChallenge()" style="display: none;">Ti·∫øp t·ª•c <span class="option-label">‚û°Ô∏è</span></button>
            </div>

            <div style="margin-top: 15px; font-size: 2em; animation: moveCharacter 5s infinite alternate;">üïµÔ∏è‚Äç‚ôÇÔ∏è</div>
            <div style="font-size: 0.9em; font-style: italic;">(Th√°m t·ª≠ ƒëang suy nghƒ©...)</div>
            <p id="feedback-message" style="margin-top: 10px; font-weight: bold; min-height: 20px;"></p>
        </div>

        <div id="part3">
            <h1>üéâ Ho√†n th√†nh Nhi·ªám v·ª• üéâ</h1>
            <div id="result-card">
                <h2>B√°o c√°o Th√°m t·ª≠ Tin h·ªçc</h2>
                <div id="reward-image"></div>
                
                <div class="result-stats">
                    <div class="stat-item"><span class="stat-label">H·ªç v√† T√™n:</span> <span class="stat-value" id="res-name"></span></div>
                    <div class="stat-item"><span class="stat-label">L·ªõp:</span> <span class="stat-value" id="res-class"></span></div>
                    <div class="stat-item"><span class="stat-label">T·ªïng Th·ª≠ th√°ch:</span> <span class="stat-value" id="res-total"></span></div>
                    <div class="stat-item"><span class="stat-label">ƒê√∫ng:</span> <span class="stat-value" id="res-correct"></span></div>
                    <div class="stat-item"><span class="stat-label">% Ho√†n th√†nh:</span> <span class="stat-value" id="res-percent"></span></div>
                    <div class="stat-item"><span class="stat-label">Th·ªùi gian:</span> <span class="stat-value" id="res-time"></span></div>
                    <div class="stat-item" style="grid-column: span 2;"><span class="stat-label">S·ªë l·∫ßn ch∆°i:</span> <span class="stat-value" id="res-play-count"></span></div>
                </div>

                <p id="result-comment" style="font-size: 1.3em; margin-top: 20px;"></p>

                <p style="font-style: italic; font-size: 0.9em; margin-top: 10px;">Tin h·ªçc 5 - B√†i 3: Th√¥ng tin trong gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ</p>
            </div>
            
            <div class="action-button-group">
                <button class="btn" onclick="restartGame(false)">Ch∆°i L·∫°i <span class="option-label">üîÅ</span></button>
                <button class="btn" onclick="shareResult()">Chia S·∫ª K·∫øt Qu·∫£ <span class="option-label">üñºÔ∏è</span></button>
            </div>
        </div>
    </div>

    <script>
        // Placeholder for sound effects (cannot embed actual files)
        const SOUNDS = {
            click: () => { console.log("Sound: Click"); },
            correct: () => { console.log("Sound: Correct/Success"); },
            incorrect: () => { console.log("Sound: Incorrect/Failure"); },
            finish: () => { console.log("Sound: Game Finish"); }
        };

        const LESSON_TITLE = "Tin h·ªçc 5 - B√†i 3: Th√¥ng tin trong gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ";
        const TOTAL_CHALLENGES = 5;

        // --- D·ªØ li·ªáu Tr√≤ ch∆°i (JSON Array) ---
        const questionsData = [
            // Th·ª≠ th√°ch 1: Tr·∫Øc nghi·ªám (Multiple Choice) - Nh·∫≠n bi·∫øt
            {
                type: 'multiple-choice',
                question: 'Th√¥ng tin c√≥ vai tr√≤ quan tr·ªçng nh·∫•t trong vi·ªác g√¨?',
                options: [
                    { text: 'A. L∆∞u tr·ªØ d·ªØ li·ªáu.', isCorrect: false },
                    { text: 'B. ƒê∆∞a ra quy·∫øt ƒë·ªãnh ch√≠nh x√°c v√† k·ªãp th·ªùi.', isCorrect: true },
                    { text: 'C. Gi√∫p m√°y t√≠nh ho·∫°t ƒë·ªông.', isCorrect: false },
                    { text: 'D. Trao ƒë·ªïi v·ªõi b·∫°n b√®.', isCorrect: false }
                ],
                userAnswer: null
            },
            // Th·ª≠ th√°ch 2: ƒê√∫ng / Sai (True/False) - Th√¥ng hi·ªÉu
            {
                type: 'true-false',
                question: 'ƒê·ªÉ gi·∫£i quy·∫øt m·ªôt v·∫•n ƒë·ªÅ, ta c·∫ßn thu th·∫≠p m·ªçi th√¥ng tin, kh√¥ng c·∫ßn ph√¢n lo·∫°i th√¥ng tin c·∫ßn thi·∫øt hay kh√¥ng c·∫ßn thi·∫øt.',
                options: [
                    { text: 'ƒê√∫ng', isCorrect: false },
                    { text: 'Sai', isCorrect: true }
                ],
                userAnswer: null
            },
            // Th·ª≠ th√°ch 3: K√©o ‚Äì th·∫£ (Gh√©p ƒë√¥i/Ph√¢n lo·∫°i) - Nh·∫≠n bi·∫øt
            {
                type: 'drag-drop',
                question: 'K√©o th·∫£ c√°c thu·∫≠t ng·ªØ v√†o ƒë√∫ng kh√°i ni·ªám t∆∞∆°ng ·ª©ng.',
                targets: [
                    { id: 't1', text: 'Th√¥ng tin', correctDropId: 'd1', currentDropId: null },
                    { id: 't2', text: 'D·ªØ li·ªáu', correctDropId: 'd2', currentDropId: null },
                    { id: 't3', text: 'X·ª≠ l√≠ th√¥ng tin', correctDropId: 'd3', currentDropId: null },
                ],
                drops: [
                    { id: 'd1', text: 'D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c x·ª≠ l√≠ v√† c√≥ √Ω nghƒ©a.', currentDragId: null },
                    { id: 'd2', text: 'S·ª± ki·ªán, s·ª± vi·ªác c√≥ s·∫µn (ch∆∞a x·ª≠ l√≠).', currentDragId: null },
                    { id: 'd3', text: 'Bi·∫øn d·ªØ li·ªáu th√†nh th√¥ng tin c√≥ √≠ch.', currentDragId: null },
                ],
                userAnswer: null
            },
            // Th·ª≠ th√°ch 4: Tr·∫Øc nghi·ªám (Multiple Choice) - V·∫≠n d·ª•ng
            {
                type: 'multiple-choice',
                question: 'Em c·∫ßn mua qu√† sinh nh·∫≠t cho b·∫°n. Th√¥ng tin n√†o sau ƒë√¢y l√† KH√îNG c·∫ßn thi·∫øt ƒë·ªÉ ra quy·∫øt ƒë·ªãnh?',
                options: [
                    { text: 'A. S·ªü th√≠ch, m√≥n ƒë·ªì b·∫°n ƒëang c·∫ßn.', isCorrect: false },
                    { text: 'B. S·ªë ti·ªÅn em c√≥ th·ªÉ chi ti√™u.', isCorrect: false },
                    { text: 'C. ƒê·ªãa ch·ªâ c·ª≠a h√†ng b√°n qu√†.', isCorrect: false },
                    { text: 'D. M√†u s·∫Øc c·ªßa ƒë√¥i gi√†y b·∫°n mang h√¥m nay.', isCorrect: true }
                ],
                userAnswer: null
            },
            // Th·ª≠ th√°ch 5: N·ªëi c·ªôt (Matching) - Th√¥ng hi·ªÉu
            {
                type: 'matching',
                question: 'N·ªëi c√°c B∆∞·ªõc gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ (C·ªôt A) v·ªõi M·ª•c ti√™u c·ªßa b∆∞·ªõc ƒë√≥ (C·ªôt B).',
                matchPairs: [
                    { id: 'm1', aText: '1. X√°c ƒë·ªãnh v·∫•n ƒë·ªÅ', bText: 'C·∫ßn gi·∫£i quy·∫øt vi·ªác g√¨, m·ª•c ti√™u l√† g√¨.', isMatched: false, correctBId: 'b1' },
                    { id: 'm2', aText: '2. Thu th·∫≠p th√¥ng tin', bText: 'T√¨m ki·∫øm c√°c s·ª± ki·ªán li√™n quan.', isMatched: false, correctBId: 'b2' },
                    { id: 'm3', aText: '3. X·ª≠ l√≠ th√¥ng tin', bText: 'Ph√¢n t√≠ch, ƒë√°nh gi√° th√¥ng tin.', isMatched: false, correctBId: 'b3' },
                    { id: 'm4', aText: '4. Ra quy·∫øt ƒë·ªãnh', bText: 'Ch·ªçn ph∆∞∆°ng √°n t·ªët nh·∫•t.', isMatched: false, correctBId: 'b4' },
                ],
                // ƒê·ªÉ render, ta c·∫ßn t√°ch A v√† B ra v√† shuffle B
                colA: [
                    { id: 'a1', text: '1. X√°c ƒë·ªãnh v·∫•n ƒë·ªÅ', correctMatchId: 'b1', currentMatchId: null },
                    { id: 'a2', text: '2. Thu th·∫≠p th√¥ng tin', correctMatchId: 'b2', currentMatchId: null },
                    { id: 'a3', text: '3. X·ª≠ l√≠ th√¥ng tin', correctMatchId: 'b3', currentMatchId: null },
                    { id: 'a4', text: '4. Ra quy·∫øt ƒë·ªãnh', correctMatchId: 'b4', currentMatchId: null }
                ],
                colB: [
                    { id: 'b1', text: 'C·∫ßn gi·∫£i quy·∫øt vi·ªác g√¨, m·ª•c ti√™u l√† g√¨.', correctMatchId: 'a1', currentMatchId: null },
                    { id: 'b2', text: 'T√¨m ki·∫øm c√°c s·ª± ki·ªán li√™n quan.', correctMatchId: 'a2', currentMatchId: null },
                    { id: 'b3', text: 'Ph√¢n t√≠ch, ƒë√°nh gi√° th√¥ng tin.', correctMatchId: 'a3', currentMatchId: null },
                    { id: 'b4', text: 'Ch·ªçn ph∆∞∆°ng √°n t·ªët nh·∫•t.', correctMatchId: 'a4', currentMatchId: null }
                ],
                userAnswer: null
            }
        ];

        // --- Bi·∫øn Tr·∫°ng th√°i Game ---
        let gameState = {
            playerName: '',
            playerClass: '',
            questions: [],
            currentChallenge: 0, // 0-indexed
            startTime: null,
            endTime: null,
            correctCount: 0,
            playCount: 0,
        };

        let gameHistory = []; // L∆∞u tr·ªØ l·ªãch s·ª≠ ng∆∞·ªùi ch∆°i

        // --- H√†m Ti·ªán √≠ch ---

        // H√†m x√°o tr·ªôn m·∫£ng (Fisher-Yates)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // --- Qu·∫£n l√≠ L·ªãch s·ª≠ Ng∆∞·ªùi ch∆°i ---

        function loadGameHistory() {
            try {
                const history = localStorage.getItem('gameHistory');
                if (history) {
                    gameHistory = JSON.parse(history);
                }
            } catch (e) {
                console.error("Could not load game history", e);
            }
        }

        function saveGameHistory() {
            try {
                localStorage.setItem('gameHistory', JSON.stringify(gameHistory));
            } catch (e) {
                console.error("Could not save game history", e);
            }
        }

        function updatePlayerHistory(playerName, playerClass) {
            const existingPlayerIndex = gameHistory.findIndex(p => p.name === playerName && p.class === playerClass);

            if (existingPlayerIndex > -1) {
                gameHistory[existingPlayerIndex].playCount += 1;
                gameState.playCount = gameHistory[existingPlayerIndex].playCount;
            } else {
                gameState.playCount = 1;
                gameHistory.push({
                    name: playerName,
                    class: playerClass,
                    playCount: 1,
                    highScores: []
                });
            }
            saveGameHistory();
        }

        function updatePlayCountForRestart() {
             const existingPlayerIndex = gameHistory.findIndex(p => p.name === gameState.playerName && p.class === gameState.playerClass);
             if (existingPlayerIndex > -1) {
                gameHistory[existingPlayerIndex].playCount += 1;
                gameState.playCount = gameHistory[existingPlayerIndex].playCount;
            }
            saveGameHistory();
        }

        function logScore() {
            const timeInSeconds = (gameState.endTime - gameState.startTime) / 1000;
            const existingPlayer = gameHistory.find(p => p.name === gameState.playerName && p.class === gameState.playerClass);

            if (existingPlayer) {
                 existingPlayer.highScores.push({
                    score: gameState.correctCount,
                    total: TOTAL_CHALLENGES,
                    time: timeInSeconds,
                    date: new Date().toISOString(),
                    playCount: existingPlayer.playCount
                });
            }
            saveGameHistory();
        }


        // --- Qu·∫£n l√≠ lu·ªìng Game ---

        function checkAndStartGame() {
            const name = document.getElementById('playerName').value.trim();
            const class_ = document.getElementById('playerClass').value.trim();

            if (name === "" || class_ === "") {
                alert("Vui l√≤ng nh·∫≠p H·ªç v√† T√™n c√πng v·ªõi L·ªõp ƒë·ªÉ b·∫Øt ƒë·∫ßu tr√≤ ch∆°i!");
                return;
            }

            gameState.playerName = name;
            gameState.playerClass = class_;
            loadGameHistory();
            updatePlayerHistory(name, class_);
            
            startGame();
        }

        function startGame() {
            // Thi·∫øt l·∫≠p tr·∫°ng th√°i m·ªõi
            gameState.currentChallenge = 0;
            gameState.correctCount = 0;
            gameState.startTime = Date.now();
            gameState.endTime = null;
            gameState.questions = JSON.parse(JSON.stringify(questionsData)); // Deep copy

            // X√°o tr·ªôn th·ª© t·ª± c√°c c√¢u h·ªèi
            shuffleArray(gameState.questions);

            // X√°o tr·ªôn n·ªôi dung b√™n trong t·ª´ng c√¢u h·ªèi (options, match columns)
            gameState.questions.forEach(q => {
                if (q.type === 'multiple-choice' || q.type === 'true-false') {
                    shuffleArray(q.options);
                } else if (q.type === 'matching') {
                    shuffleArray(q.colB);
                }
            });

            // Hi·ªÉn th·ªã ph·∫ßn 2
            document.getElementById('part1').style.display = 'none';
            document.getElementById('part3').style.display = 'none';
            document.getElementById('part2').style.display = 'block';
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('submitBtn').style.display = 'block';
            document.getElementById('feedback-message').textContent = '';

            startTimer();
            showChallenge(gameState.currentChallenge);
        }
        
        function restartGame(skipPart1) {
            if (!skipPart1) {
                // Quay l·∫°i ph·∫ßn nh·∫≠p th√¥ng tin ƒë·ªÉ thay ƒë·ªïi t√™n/l·ªõp ho·∫∑c ch∆°i l·∫°i ho√†n to√†n
                document.getElementById('part2').style.display = 'none';
                document.getElementById('part3').style.display = 'none';
                document.getElementById('part1').style.display = 'block';
            } else {
                // Ch∆°i l·∫°i ngay l·∫≠p t·ª©c (d√†nh cho n√∫t Ch∆°i l·∫°i ·ªü m√†n h√¨nh k·∫øt qu·∫£)
                stopTimer();
                updatePlayCountForRestart();
                startGame();
            }
        }


        function showChallenge(index) {
            if (index >= TOTAL_CHALLENGES) {
                finishGame();
                return;
            }

            const challenge = gameState.questions[index];
            const questionArea = document.getElementById('question-area');
            const challengeNumber = index + 1;

            document.getElementById('challenge-status').textContent = `Th·ª≠ th√°ch ${challengeNumber}/${TOTAL_CHALLENGES}`;
            document.getElementById('question-content').textContent = challenge.question;
            document.getElementById('submitBtn').style.display = 'block';
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('feedback-message').textContent = '';
            questionArea.innerHTML = ''; // Clear previous content

            // Render d·ª±a tr√™n lo·∫°i c√¢u h·ªèi
            switch (challenge.type) {
                case 'multiple-choice':
                case 'true-false':
                    renderMultipleChoice(challenge, questionArea);
                    break;
                case 'drag-drop':
                    renderDragDrop(challenge, questionArea);
                    break;
                case 'matching':
                    renderMatching(challenge, questionArea);
                    break;
                default:
                    questionArea.innerHTML = '<p>L·ªói: Lo·∫°i th·ª≠ th√°ch kh√¥ng x√°c ƒë·ªãnh.</p>';
            }
        }

        function submitAnswer() {
            SOUNDS.click();
            const challenge = gameState.questions[gameState.currentChallenge];
            const isCorrect = checkAnswer(challenge);

            // L∆∞u k·∫øt qu·∫£ (ch·∫•p nh·∫≠n d√π ƒë√∫ng hay sai)
            if (isCorrect) {
                gameState.correctCount++;
                SOUNDS.correct();
                document.getElementById('feedback-message').textContent = "B·∫°n ƒë√£ ho√†n th√†nh Th·ª≠ th√°ch! ‚úÖ";
                document.getElementById('feedback-message').style.color = var(--color-success);
            } else {
                SOUNDS.incorrect();
                document.getElementById('feedback-message').textContent = "B·∫°n ƒë√£ ho√†n th√†nh Th·ª≠ th√°ch! ‚ùå";
                document.getElementById('feedback-message').style.color = var(--color-secondary);
            }

            // V√¥ hi·ªáu h√≥a vi·ªác ch·ªçn/th·ª±c hi·ªán l·∫°i
            disableCurrentChallenge(challenge.type);

            // Ch·ªâ b√°o ƒë√£ ch·ªçn g√¨ (ƒë√£ th·ª±c hi·ªán trong h√†m checkAnswer)
            document.getElementById('submitBtn').style.display = 'none';
            document.getElementById('nextBtn').style.display = 'block';
        }

        function nextChallenge() {
            gameState.currentChallenge++;
            showChallenge(gameState.currentChallenge);
        }
        
        function disableCurrentChallenge(type) {
            const questionArea = document.getElementById('question-area');
            if (type === 'multiple-choice' || type === 'true-false') {
                questionArea.querySelectorAll('.option-item').forEach(item => item.onclick = null);
            } else if (type === 'drag-drop') {
                questionArea.querySelectorAll('.drag-item').forEach(item => item.draggable = false);
            } else if (type === 'matching') {
                questionArea.querySelectorAll('.match-item').forEach(item => item.onclick = null);
            }
        }

        function checkAnswer(challenge) {
            switch (challenge.type) {
                case 'multiple-choice':
                case 'true-false':
                    const selected = challenge.options.find(opt => opt.text === challenge.userAnswer);
                    if (selected) {
                        return selected.isCorrect;
                    }
                    return false;
                case 'drag-drop':
                    // Check if every target's currentDragId matches the correctDropId
                    return challenge.targets.every(target => target.currentDropId === target.correctDropId);
                case 'matching':
                     // Check if every item in Col A has its currentMatchId matching its correctMatchId
                    return challenge.colA.every(itemA => itemA.currentMatchId === itemA.correctMatchId);
                default:
                    return false;
            }
        }

        function finishGame() {
            stopTimer();
            SOUNDS.finish();
            gameState.endTime = Date.now();
            logScore();
            
            // ·∫®n ph·∫ßn 2, hi·ªán ph·∫ßn 3
            document.getElementById('part2').style.display = 'none';
            document.getElementById('part3').style.display = 'block';

            const timeInSeconds = Math.floor((gameState.endTime - gameState.startTime) / 1000);
            const minutes = Math.floor(timeInSeconds / 60);
            const seconds = timeInSeconds % 60;
            const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            const percent = ((gameState.correctCount / TOTAL_CHALLENGES) * 100).toFixed(0);

            // C·∫≠p nh·∫≠t k·∫øt qu·∫£
            document.getElementById('res-name').textContent = gameState.playerName;
            document.getElementById('res-class').textContent = gameState.playerClass;
            document.getElementById('res-total').textContent = TOTAL_CHALLENGES;
            document.getElementById('res-correct').textContent = gameState.correctCount;
            document.getElementById('res-percent').textContent = `${percent}%`;
            document.getElementById('res-time').textContent = timeString;
            document.getElementById('res-play-count').textContent = gameState.playCount;
            
            // Nh·∫≠n x√©t v√† Ph·∫ßn th∆∞·ªüng
            let comment = '';
            let rewardIcon = '‚≠ê';
            let commentColor = var(--color-text);

            if (percent == 100) {
                comment = 'Xu·∫•t s·∫Øc! B·∫°n l√† m·ªôt Th√°m t·ª≠ Tin h·ªçc t√†i ba! 100% ch√≠nh x√°c!';
                rewardIcon = 'üëë';
                commentColor = var(--color-success);
            } else if (percent >= 50) {
                comment = 'Ho√†n th√†nh T·ªët! B·∫°n ƒë√£ t√¨m ƒë∆∞·ª£c h·∫ßu h·∫øt manh m·ªëi! C·ªë g·∫Øng l·∫ßn sau nh√©!';
                rewardIcon = 'üåü';
                commentColor = var(--color-primary);
            } else {
                comment = 'B·∫°n c·∫ßn xem l·∫°i c√°c ki·∫øn th·ª©c v·ªÅ Th√¥ng tin. ƒê·ª´ng n·∫£n l√≤ng, ch∆°i l·∫°i th√¥i n√†o!';
                rewardIcon = 'üïµÔ∏è';
                commentColor = var(--color-secondary);
            }
            
            document.getElementById('reward-image').textContent = rewardIcon;
            document.getElementById('result-comment').textContent = comment;
            document.getElementById('result-comment').style.color = commentColor;
        }


        // --- Qu·∫£n l√≠ Th·ªùi gian ---
        let timerInterval;

        function startTimer() {
            let elapsedSeconds = 0;
            const timerElement = document.getElementById('timer');
            
            stopTimer(); // Clear any existing interval

            timerInterval = setInterval(() => {
                elapsedSeconds = Math.floor((Date.now() - gameState.startTime) / 1000);
                const minutes = Math.floor(elapsedSeconds / 60);
                const seconds = elapsedSeconds % 60;
                timerElement.textContent = `Th·ªùi gian: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }
        
        // --- Render C√¢u h·ªèi Tr·∫Øc nghi·ªám / ƒê√∫ng Sai ---

        function renderMultipleChoice(challenge, container) {
            const optionsList = document.createElement('ul');
            optionsList.className = 'options-list';

            challenge.options.forEach((option, index) => {
                const item = document.createElement('li');
                item.className = 'option-item';
                item.dataset.index = index;
                item.innerHTML = `<span class="option-label">${String.fromCharCode(65 + index)}.</span> ${option.text}`;
                
                item.onclick = () => {
                    selectOption(item, challenge);
                };
                optionsList.appendChild(item);
            });

            container.appendChild(optionsList);
        }
        
        function selectOption(selectedItem, challenge) {
            SOUNDS.click();
            // B·ªè ch·ªçn t·∫•t c·∫£
            selectedItem.parentNode.querySelectorAll('.option-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Ch·ªçn m·ª•c hi·ªán t·∫°i
            selectedItem.classList.add('selected');
            
            // L∆∞u ƒë√°p √°n
            const selectedText = selectedItem.textContent.trim().substring(3).trim(); // B·ªè A., B., ...
            challenge.userAnswer = selectedText;
            document.getElementById('feedback-message').textContent = `ƒê√£ ch·ªçn: ${selectedItem.textContent.trim()}`;
            document.getElementById('feedback-message').style.color = var(--color-primary);
        }

        // --- Render C√¢u h·ªèi K√©o-th·∫£ ---

        function renderDragDrop(challenge, container) {
            const dragDropContainer = document.createElement('div');
            dragDropContainer.className = 'drag-drop-container';

            // C·ªôt Target (√î tr·ªëng ƒë·ªÉ k√©o v√†o)
            const targetList = document.createElement('div');
            targetList.className = 'drop-area';
            targetList.innerHTML = '<h3>Thu·∫≠t ng·ªØ</h3>';
            challenge.targets.forEach(target => {
                const dropZone = document.createElement('div');
                dropZone.className = 'drop-target';
                dropZone.id = `target-${target.id}`;
                dropZone.innerHTML = `<strong>${target.text}:</strong> <div class="dropped-item-box" data-correct-id="${target.correctDropId}"></div>`;
                targetList.appendChild(dropZone);
            });

            // C·ªôt Drop (C√°c m·ª•c ƒë·ªÉ k√©o)
            const dropList = document.createElement('div');
            dropList.className = 'drag-area';
            dropList.innerHTML = '<h3>Kh√°i ni·ªám</h3>';
            challenge.drops.forEach(drop => {
                const dragItem = document.createElement('div');
                dragItem.className = 'drag-item';
                dragItem.id = `drag-${drop.id}`;
                dragItem.textContent = drop.text;
                dragItem.draggable = true;
                dragItem.addEventListener('dragstart', handleDragStart);
                dropList.appendChild(dragItem);
            });

            dragDropContainer.appendChild(targetList);
            dragDropContainer.appendChild(dropList);
            container.appendChild(dragDropContainer);

            // K√≠ch ho·∫°t Drag & Drop Listeners
            container.querySelectorAll('.drop-target .dropped-item-box').forEach(box => {
                box.addEventListener('dragover', handleDragOver);
                box.addEventListener('drop', handleDrop);
            });

            // C·∫≠p nh·∫≠t tr·∫°ng th√°i c√¢u h·ªèi khi k√©o th·∫£
            function handleDragStart(e) {
                e.dataTransfer.setData('text/plain', e.target.id);
                e.target.classList.add('dragging');
            }

            function handleDragOver(e) {
                e.preventDefault(); // Cho ph√©p th·∫£
            }

            function handleDrop(e) {
                e.preventDefault();
                const dragId = e.dataTransfer.getData('text/plain');
                const draggedElement = document.getElementById(dragId);
                const dropBox = e.target.closest('.dropped-item-box');
                if (!dropBox) return;

                // X√≥a m·ª•c kh·ªèi √¥ c≈© (n·∫øu c√≥)
                const oldDropBox = document.querySelector(`.dropped-item-box[data-drag-id="${dragId}"]`);
                if (oldDropBox) {
                    oldDropBox.innerHTML = '';
                    oldDropBox.removeAttribute('data-drag-id');
                }
                
                // C·∫≠p nh·∫≠t DOM
                dropBox.innerHTML = '';
                dropBox.appendChild(draggedElement);
                dropBox.dataset.dragId = dragId;
                draggedElement.classList.remove('dragging');

                // C·∫≠p nh·∫≠t tr·∫°ng th√°i game
                const dropZoneId = dropBox.parentNode.id.replace('target-', ''); // e.g., 't1'
                const droppedItemId = dragId.replace('drag-', ''); // e.g., 'd1'

                const target = challenge.targets.find(t => t.id === dropZoneId);
                if (target) {
                    target.currentDropId = droppedItemId;
                }
                SOUNDS.click();
                document.getElementById('feedback-message').textContent = `ƒê√£ gh√©p: ${target.text} v·ªõi ${draggedElement.textContent.trim()}`;
                document.getElementById('feedback-message').style.color = var(--color-primary);
            }
        }

        // --- Render C√¢u h·ªèi N·ªëi c·ªôt ---
        
        let matchingState = {
            selectedA: null, // {id: 'a1', element: element}
            selectedB: null
        };
        let canvas, ctx, colA_elements, colB_elements;

        function renderMatching(challenge, container) {
            const wrapper = document.createElement('div');
            wrapper.className = 'matching-area-wrapper';
            wrapper.style.position = 'relative';

            const matchingContainer = document.createElement('div');
            matchingContainer.className = 'matching-container';

            // C·ªôt A
            const colA_list = document.createElement('div');
            colA_list.className = 'match-list-a';
            colA_list.innerHTML = '<h3>C·ªôt A (B∆∞·ªõc)</h3>';
            challenge.colA.forEach(item => {
                const matchItem = document.createElement('div');
                matchItem.className = 'match-item item-a';
                matchItem.id = item.id;
                matchItem.textContent = item.text;
                matchItem.onclick = (e) => handleMatchClick(e, 'A', challenge);
                colA_list.appendChild(matchItem);
            });

            // C·ªôt B
            const colB_list = document.createElement('div');
            colB_list.className = 'match-list-b';
            colB_list.innerHTML = '<h3>C·ªôt B (M·ª•c ti√™u)</h3>';
            challenge.colB.forEach(item => {
                const matchItem = document.createElement('div');
                matchItem.className = 'match-item item-b';
                matchItem.id = item.id;
                matchItem.textContent = item.text;
                matchItem.onclick = (e) => handleMatchClick(e, 'B', challenge);
                colB_list.appendChild(matchItem);
            });

            matchingContainer.appendChild(colA_list);
            matchingContainer.appendChild(colB_list);
            wrapper.appendChild(matchingContainer);
            container.appendChild(wrapper);

            // Th√™m Canvas
            canvas = document.createElement('canvas');
            canvas.id = 'matching-canvas';
            wrapper.insertBefore(canvas, matchingContainer);
            ctx = canvas.getContext('2d');
            
            // Thi·∫øt l·∫≠p k√≠ch th∆∞·ªõc canvas
            const rect = matchingContainer.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
            canvas.style.width = rect.width + 'px';
            canvas.style.height = rect.height + 'px';

            // L∆∞u c√°c element ƒë·ªÉ v·∫Ω
            colA_elements = Array.from(colA_list.querySelectorAll('.item-a'));
            colB_elements = Array.from(colB_list.querySelectorAll('.item-b'));
            
            // V·∫Ω l·∫°i c√°c ƒë∆∞·ªùng n·ªëi ƒë√£ c√≥ (n·∫øu c√≥)
            drawMatches(challenge);
        }

        function drawMatches(challenge) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            ctx.strokeStyle = var(--color-primary);
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.setLineDash([]);
            
            const matchContainerRect = document.querySelector('.matching-container').getBoundingClientRect();
            
            challenge.colA.forEach(itemA => {
                const itemB = challenge.colB.find(item => item.id === itemA.currentMatchId);
                
                if (itemB) {
                    const elemA = document.getElementById(itemA.id);
                    const elemB = document.getElementById(itemB.id);

                    if (elemA && elemB) {
                        const rectA = elemA.getBoundingClientRect();
                        const rectB = elemB.getBoundingClientRect();

                        // T√≠nh to√°n t·ªça ƒë·ªô trong Canvas
                        const x1 = rectA.right - matchContainerRect.left;
                        const y1 = (rectA.top + rectA.bottom) / 2 - matchContainerRect.top;
                        const x2 = rectB.left - matchContainerRect.left;
                        const y2 = (rectB.top + rectB.bottom) / 2 - matchContainerRect.top;
                        
                        // V·∫Ω ƒë∆∞·ªùng
                        ctx.beginPath();
                        ctx.moveTo(x1, y1);
                        ctx.lineTo(x2, y2);
                        ctx.stroke();

                        // V·∫Ω m≈©i t√™n (ƒë∆°n gi·∫£n)
                        const angle = Math.atan2(y2 - y1, x2 - x1);
                        drawArrowhead(ctx, x2, y2, angle);
                    }
                }
            });
        }

        function drawArrowhead(ctx, x, y, angle) {
            const size = 10;
            ctx.save();
            ctx.translate(x, y);
            ctx.rotate(angle);
            ctx.fillStyle = ctx.strokeStyle;
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.lineTo(-size, -size / 2);
            ctx.lineTo(-size, size / 2);
            ctx.closePath();
            ctx.fill();
            ctx.restore();
        }

        function handleMatchClick(e, column, challenge) {
            SOUNDS.click();
            const clickedItem = e.target.closest('.match-item');
            if (!clickedItem) return;

            // X√≥a tr·∫°ng th√°i ƒëang ch·ªçn c≈©
            document.querySelectorAll('.match-item').forEach(item => item.classList.remove('selected-for-match'));

            if (column === 'A') {
                if (matchingState.selectedA && matchingState.selectedA.id === clickedItem.id) {
                    // Nh·∫•p l·∫°i ƒë·ªÉ b·ªè ch·ªçn
                    matchingState.selectedA = null;
                } else {
                    matchingState.selectedA = { id: clickedItem.id, element: clickedItem };
                    clickedItem.classList.add('selected-for-match');
                    if (matchingState.selectedB) {
                        // N·∫øu c√≥ B ƒëang ch·ªçn, th·ª±c hi·ªán n·ªëi
                        makeMatch(challenge);
                    }
                }
            } else { // Column B
                if (matchingState.selectedB && matchingState.selectedB.id === clickedItem.id) {
                    // Nh·∫•p l·∫°i ƒë·ªÉ b·ªè ch·ªçn
                    matchingState.selectedB = null;
                } else {
                    matchingState.selectedB = { id: clickedItem.id, element: clickedItem };
                    clickedItem.classList.add('selected-for-match');
                    if (matchingState.selectedA) {
                        // N·∫øu c√≥ A ƒëang ch·ªçn, th·ª±c hi·ªán n·ªëi
                        makeMatch(challenge);
                    }
                }
            }
        }

        function makeMatch(challenge) {
            if (!matchingState.selectedA || !matchingState.selectedB) return;

            const itemAId = matchingState.selectedA.id;
            const itemBId = matchingState.selectedB.id;
            const itemA = challenge.colA.find(item => item.id === itemAId);
            const itemB = challenge.colB.find(item => item.id === itemBId);

            // Ki·ªÉm tra xem B ƒë√£ ƒë∆∞·ª£c n·ªëi v·ªõi A n√†o ch∆∞a
            const alreadyMatchedA = challenge.colA.find(item => item.currentMatchId === itemBId);
            if (alreadyMatchedA) {
                // H·ªßy n·ªëi c≈©
                alreadyMatchedA.currentMatchId = null;
                itemA.currentMatchId = null; // D√π sao c≈©ng c·∫ßn reset A
            }
            
            // C·∫≠p nh·∫≠t n·ªëi m·ªõi: A -> B
            itemA.currentMatchId = itemBId;

            // X√≥a tr·∫°ng th√°i ch·ªçn
            document.querySelectorAll('.match-item').forEach(item => item.classList.remove('selected-for-match'));
            matchingState.selectedA = null;
            matchingState.selectedB = null;

            // V·∫Ω l·∫°i ƒë∆∞·ªùng n·ªëi
            drawMatches(challenge);
            
            // C·∫≠p nh·∫≠t th√¥ng b√°o
            const itemAText = document.getElementById(itemAId).textContent;
            const itemBText = document.getElementById(itemBId).textContent;
            document.getElementById('feedback-message').textContent = `ƒê√£ n·ªëi: ${itemAText} v·ªõi ${itemBText}`;
            document.getElementById('feedback-message').style.color = var(--color-primary);

            // C·∫≠p nh·∫≠t c√¢u tr·∫£ l·ªùi ng∆∞·ªùi d√πng
            challenge.userAnswer = challenge.colA.map(item => ({ idA: item.id, idB: item.currentMatchId }));
        }


        // --- Chia s·∫ª K·∫øt qu·∫£ (html2canvas) ---

        function shareResult() {
            // ·∫®n c√°c n√∫t ƒëi·ªÅu khi·ªÉn tr∆∞·ªõc khi ch·ª•p
            const actionButtons = document.querySelector('.action-button-group');
            actionButtons.style.display = 'none';

            // Ch·ª•p ph·∫ßn k·∫øt qu·∫£ (ho·∫∑c c·∫£ container)
            const captureArea = document.getElementById('result-card').closest('.container');
            
            html2canvas(captureArea, { 
                scale: 2, // TƒÉng ch·∫•t l∆∞·ª£ng ·∫£nh
                allowTaint: true, // Cho ph√©p ·∫£nh t·ª´ b√™n ngo√†i (n·∫øu c√≥)
                useCORS: true // K√≠ch ho·∫°t CORS
            }).then(canvas => {
                // T·∫°o ·∫£nh PNG
                const image = canvas.toDataURL('image/png');
                
                // T·∫£i xu·ªëng
                const link = document.createElement('a');
                link.href = image;
                link.download = `KetQua_ThamTuTinHoc_${gameState.playerName.replace(/\s/g, '_')}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Hi·ªán l·∫°i c√°c n√∫t ƒëi·ªÅu khi·ªÉn
                actionButtons.style.display = 'block';
            }).catch(error => {
                console.error('L·ªói khi ch·ª•p m√†n h√¨nh:', error);
                alert('Kh√¥ng th·ªÉ ch·ª•p ·∫£nh k·∫øt qu·∫£. Vui l√≤ng th·ª≠ l·∫°i.');
                // Hi·ªán l·∫°i c√°c n√∫t ƒëi·ªÅu khi·ªÉn ngay c·∫£ khi b·ªã l·ªói
                actionButtons.style.display = 'block';
            });
        }

    </script>

</body>
</html>
