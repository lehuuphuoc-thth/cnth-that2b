<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thám tử Tin học: Nhiệm vụ thu thập thông tin</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');

        :root {
            --color-primary: #4CAF50; /* Green */
            --color-secondary: #FFC107; /* Amber */
            --color-background: #E8F5E9; /* Light Green */
            --color-card: #FFFFFF;
            --color-text: #333333;
            --color-correct: #8BC34A;
            --color-wrong: #FF5722;
            --color-blue: #2196F3;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, var(--color-background) 0%, #B9F6CA 100%);
            color: var(--color-text);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            overflow-y: auto;
        }

        .game-container {
            width: 100%;
            max-width: 900px;
            background: var(--color-card);
            border-radius: 20px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
            padding: 30px;
            position: relative;
            min-height: 600px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        h1, h2 {
            text-align: center;
            color: var(--color-primary);
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        /* --- Global Button Style --- */
        button {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 0 var(--color-primary);
            background: var(--color-primary);
            color: white;
            text-transform: uppercase;
        }

        button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 6px 0 var(--color-primary);
        }

        button:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 var(--color-primary);
        }
        
        /* --- Phần 1: Điền thông tin --- */
        #info-screen {
            text-align: center;
            padding: 50px 20px;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
            max-width: 400px;
            margin: 0 auto 20px auto;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--color-blue);
        }

        .input-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--color-blue);
            border-radius: 8px;
            font-size: 1em;
            box-sizing: border-box;
        }

        #start-btn {
            background: var(--color-blue);
            box-shadow: 0 4px 0 #1565C0;
        }
        #start-btn:hover {
            box-shadow: 0 6px 0 #1565C0;
        }
        #start-btn:active {
            box-shadow: 0 2px 0 #1565C0;
        }

        /* --- Phần 2: Nội dung trò chơi --- */
        #game-screen {
            display: none;
            position: relative;
            padding: 20px;
        }

        .progress-bar {
            height: 25px;
            background-color: #f3f3f3;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
            border: 2px solid var(--color-primary);
        }

        .progress {
            height: 100%;
            width: 0%;
            background-color: var(--color-primary);
            transition: width 0.5s ease-in-out;
            border-radius: 8px;
            line-height: 20px;
            text-align: center;
            color: white;
            font-weight: bold;
        }

        .challenge-info {
            text-align: center;
            margin-bottom: 20px;
        }

        .challenge-box {
            background: #fff;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            min-height: 300px;
        }

        .question-text {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 25px;
            color: var(--color-blue);
        }
        
        /* --- Dạng câu hỏi: Multiple Choice, True/False --- */
        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .option-btn {
            background: #FFECB3; /* Light secondary */
            color: var(--color-text);
            padding: 15px;
            border: 2px solid var(--color-secondary);
            font-size: 1.1em;
            text-align: left;
            border-radius: 10px;
            transition: all 0.2s;
            box-shadow: 0 3px 0 var(--color-secondary);
        }

        .option-btn:hover {
            background: #FFE082;
        }

        .option-btn.selected {
            border-color: var(--color-blue);
            background: #BBDEFB; /* Light Blue */
            box-shadow: 0 3px 0 var(--color-blue);
            transform: scale(1.02);
            font-weight: bold;
        }
        
        /* True/False specific */
        .true-false-options {
            grid-template-columns: 1fr 1fr;
            max-width: 500px;
            margin: 0 auto;
        }
        
        /* Next Button */
        #next-challenge-btn {
            display: block;
            margin: 20px auto 0;
            width: 50%;
            background: var(--color-primary);
            box-shadow: 0 4px 0 #388E3C;
        }
        #next-challenge-btn:hover {
            box-shadow: 0 6px 0 #388E3C;
        }
        #next-challenge-btn:active {
            box-shadow: 0 2px 0 #388E3C;
        }
        
        /* --- Dạng câu hỏi: Nối cột (Matching) --- */
        .matching-container {
            display: flex;
            justify-content: space-around;
            gap: 20px;
            user-select: none;
        }

        .column {
            flex-basis: 45%;
            padding: 10px;
            min-height: 200px;
        }

        .match-item {
            background: #B2DFDB; /* Teal light */
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.1s;
            border: 2px solid #009688;
            font-weight: bold;
            box-shadow: 0 2px 0 #00897B;
        }

        .match-item:hover {
            background: #80CBC4;
        }

        .match-item.selected-match {
            border: 3px dashed var(--color-wrong); /* Red dashed for selection */
            background: #FFCDD2; /* Red light for selection */
            box-shadow: none;
        }
        
        .match-item.matched {
             border: 3px solid var(--color-correct); /* Green for matched */
             background: #DCEDC8; /* Light Green */
             cursor: default;
             pointer-events: none;
        }
        
        /* Matching lines with SVG - not implemented in pure JS for simplicity, using visual match */
        /* For simple implementation, we'll only use visual feedback and logical pairing */
        
        /* --- Dạng câu hỏi: Kéo thả (Ordering/Sắp xếp) --- */
        .drag-drop-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 600px;
            margin: 0 auto;
        }

        .drop-item {
            background: #E1F5FE; /* Blue light */
            padding: 15px;
            border-radius: 8px;
            cursor: grab;
            transition: all 0.2s;
            border: 2px solid var(--color-blue);
            font-weight: bold;
            box-shadow: 0 2px 0 #0288D1;
        }

        .drop-item:hover {
            background: #B3E5FC;
        }

        .dragging {
            opacity: 0.5;
            transform: scale(1.05);
        }
        
        /* --- Phần 3: Kết quả --- */
        #results-screen {
            display: none;
            text-align: center;
            padding: 30px;
        }

        .results-box {
            background: #fff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            margin: 0 auto;
        }

        .result-item {
            margin-bottom: 10px;
            font-size: 1.1em;
            text-align: left;
            border-bottom: 1px dashed #CCC;
            padding-bottom: 5px;
        }

        .result-item span {
            font-weight: bold;
            color: var(--color-primary);
            float: right;
        }

        #comment {
            font-size: 1.4em;
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            font-style: italic;
            background: #FFF9C4; /* Yellow light */
            color: #FBC02D; /* Darker Yellow */
        }

        #reward-image {
            font-size: 4em;
            margin: 20px 0;
            color: gold;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }
        
        /* Specific result button styles */
        #play-again-btn {
            background: var(--color-primary);
            box-shadow: 0 4px 0 #388E3C;
        }
        #play-again-btn:hover {
            box-shadow: 0 6px 0 #388E3C;
        }
        #play-again-btn:active {
            box-shadow: 0 2px 0 #388E3C;
        }

        #share-btn {
            background: var(--color-blue);
            box-shadow: 0 4px 0 #1565C0;
        }
        #share-btn:hover {
            box-shadow: 0 6px 0 #1565C0;
        }
        #share-btn:active {
            box-shadow: 0 2px 0 #1565C0;
        }
        
        /* Tùy chỉnh cho màn hình chụp ảnh */
        .printable-area {
             background: linear-gradient(135deg, #E8F5E9 0%, #B9F6CA 100%);
             padding: 30px;
             border-radius: 20px;
             box-shadow: none; /* Remove shadow for clean image */
        }
    </style>
</head>
<body>

    <div class="game-container">
        
        <audio id="select-sound" src="https://www.soundjay.com/buttons/button-2.mp3" preload="auto"></audio>
        <audio id="result-sound" src="https://www.soundjay.com/misc/success-bell-edit.mp3" preload="auto"></audio>
        
        <div id="info-screen">
            <h1>THÁM TỬ TIN HỌC 🕵️‍♂️</h1>
            <h2>Nhiệm vụ thu thập thông tin</h2>
            <p>Hoàn thành 6 thử thách để tìm ra lời giải cho vấn đề!</p>

            <div class="input-group">
                <label for="player-name">Họ và tên:</label>
                <input type="text" id="player-name" placeholder="Nhập Họ và tên của em" required>
            </div>
            <div class="input-group">
                <label for="player-class">Lớp:</label>
                <input type="text" id="player-class" placeholder="Ví dụ: 5A1" required>
            </div>

            <button id="start-btn">BẮT ĐẦU NHIỆM VỤ</button>
        </div>

        <div id="game-screen" style="display: none;">
            <div class="challenge-info">
                <div class="progress-bar">
                    <div class="progress" id="progress-indicator"></div>
                </div>
                <h2>Thử thách <span id="current-challenge-number">1</span> / <span id="total-challenges"></span></h2>
            </div>
            
            <div class="challenge-box">
                <p class="question-text" id="challenge-text"></p>
                
                <div id="challenge-content">
                    </div>
                
            </div>
            
            <button id="next-challenge-btn" style="display: none;">TIẾP TỤC</button>
        </div>

        <div id="results-screen" style="display: none;">
            <div class="results-box printable-area" id="printable-area">
                <h1 style="color: var(--color-wrong);">BÁO CÁO KẾT QUẢ NHIỆM VỤ</h1>
                <h3 style="color: var(--color-blue);">Tin học 5 - Bài học:  Thông tin trong giải quyết vấn đề</h3>
                
                <div id="reward-image"></div>
                
                <p id="comment"></p>

                <div class="result-item">Họ tên: <span id="res-name"></span></div>
                <div class="result-item">Lớp: <span id="res-class"></span></div>
                <div class="result-item">Số lần chơi: <span id="res-play-count"></span></div>
                <div class="result-item">Tổng thử thách: <span id="res-total"></span></div>
                <div class="result-item">Số thử thách đúng: <span id="res-correct"></span></div>
                <div class="result-item">% hoàn thành đúng: <span id="res-percentage"></span></div>
                <div class="result-item">Thời gian hoàn thành: <span id="res-time"></span></div>
            </div>
            
            <div class="action-buttons">
                <button id="play-again-btn">CHƠI LẠI</button>
                <button id="share-btn">CHIA SẺ KẾT QUẢ</button>
            </div>
        </div>

    </div>

<script>
    // Dữ liệu trò chơi: Mảng các Thử thách (Câu hỏi)
    const GAME_DATA = [
        {
            id: 1,
            type: 'multiple-choice', // Trắc nghiệm nhiều lựa chọn
            question: 'Trong quá trình giải quyết vấn đề, bước đầu tiên và quan trọng nhất giúp ta hiểu rõ vấn đề là gì?',
            options: [
                'A. Thử nghiệm ngay các giải pháp có sẵn.',
                'B. **Thu thập thông tin và tìm hiểu vấn đề.**',
                'C. Kêu gọi giúp đỡ mà không cần tìm hiểu.',
                'D. Bỏ qua vấn đề vì quá khó.'
            ],
            correct_answer: 'B. **Thu thập thông tin và tìm hiểu vấn đề.**',
            user_answer: null,
            is_correct: false
        },
        {
            id: 2,
            type: 'true-false', // Đúng/Sai
            question: 'Khi giải quyết vấn đề, ta nên thu thập mọi thông tin ta tìm được, vì càng nhiều thông tin thì vấn đề sẽ càng dễ giải quyết hơn.',
            correct_answer: 'Sai', // Cần TÌM và CHỌN thông tin PHÙ HỢP
            options: ['Đúng', 'Sai'],
            user_answer: null,
            is_correct: false
        },
        {
            id: 3,
            type: 'matching', // Nối cột
            question: 'Hãy nối tầm quan trọng của việc thu thập thông tin (Cột A) với giải thích phù hợp (Cột B).',
            items_a: [
                { id: 'a1', text: '1. Giúp hiểu rõ gốc rễ của vấn đề.' },
                { id: 'a2', text: '2. Giúp đưa ra quyết định giải pháp.' },
                { id: 'a3', text: '3. Giúp tiết kiệm thời gian và công sức.' }
            ],
            items_b: [
                { id: 'b1', text: 'A. Có cơ sở để lựa chọn cách làm đúng.' },
                { id: 'b2', text: 'B. Nhờ biết được nguyên nhân cốt lõi.' },
                { id: 'b3', text: 'C. Tránh phải làm lại hoặc làm sai nhiều lần.' }
            ],
            correct_pairs: { 'a1': 'b2', 'a2': 'b1', 'a3': 'b3' }, // Định nghĩa cặp đúng: idA: idB
            user_pairs: {},
            is_correct: false
        },
        {
            id: 4,
            type: 'multiple-choice',
            question: 'Để giải quyết vấn đề học tập một cách đáng tin cậy, nguồn thông tin nào sau đây là phù hợp nhất?',
            options: [
                'A. Lời đồn từ bạn bè trong giờ giải lao.',
                'B. Video hướng dẫn trên mạng xã hội không rõ nguồn.',
                'C. **Sách giáo khoa, lời giải thích của thầy cô, báo cáo khoa học.**',
                'D. Một ý kiến bất kỳ từ người lạ trên đường.'
            ],
            correct_answer: 'C. **Sách giáo khoa, lời giải thích của thầy cô, báo cáo khoa học.**',
            user_answer: null,
            is_correct: false
        },
        {
            id: 5,
            type: 'drag-drop', // Kéo thả (Sắp xếp)
            question: 'Hãy sắp xếp các bước cơ bản sau trong quá trình giải quyết vấn đề theo thứ tự đúng.',
            items: [
                { id: 1, text: 'Đánh giá kết quả sau khi thực hiện.' },
                { id: 2, text: 'Lập kế hoạch hành động cụ thể.' },
                { id: 3, text: 'Tìm hiểu và thu thập thông tin về vấn đề.' },
                { id: 4, text: 'Thực hiện giải pháp theo kế hoạch.' }
            ],
            correct_order: [3, 2, 4, 1], // Thứ tự ID đúng
            user_order: [],
            is_correct: false
        },
        {
            id: 6,
            type: 'true-false',
            question: 'Khi làm việc nhóm để giải quyết vấn đề, chỉ cần một người thu thập thông tin là đủ, những người khác chỉ cần đợi kết quả.',
            correct_answer: 'Sai', // Cần sự hợp tác, mỗi người góp một phần
            options: ['Đúng', 'Sai'],
            user_answer: null,
            is_correct: false
        }
    ];

    let gameState = {
        player: { name: '', className: '', playCount: 0, bestScore: 0 },
        currentChallengeIndex: 0,
        startTime: null,
        endTime: null,
        challenges: [], // Sẽ chứa mảng GAME_DATA đã xáo trộn
        isChallengeCompleted: false,
    };
    
    // Khởi tạo các phần tử DOM
    const DOM = {
        infoScreen: document.getElementById('info-screen'),
        gameScreen: document.getElementById('game-screen'),
        resultsScreen: document.getElementById('results-screen'),
        playerNameInput: document.getElementById('player-name'),
        playerClassInput: document.getElementById('player-class'),
        startBtn: document.getElementById('start-btn'),
        
        // Game UI
        currentChallengeNumber: document.getElementById('current-challenge-number'),
        totalChallenges: document.getElementById('total-challenges'),
        progressIndicator: document.getElementById('progress-indicator'),
        challengeText: document.getElementById('challenge-text'),
        challengeContent: document.getElementById('challenge-content'),
        nextChallengeBtn: document.getElementById('next-challenge-btn'),
        
        // Results UI
        printableArea: document.getElementById('printable-area'),
        resName: document.getElementById('res-name'),
        resClass: document.getElementById('res-class'),
        resPlayCount: document.getElementById('res-play-count'),
        resTotal: document.getElementById('res-total'),
        resCorrect: document.getElementById('res-correct'),
        resPercentage: document.getElementById('res-percentage'),
        resTime: document.getElementById('res-time'),
        comment: document.getElementById('comment'),
        rewardImage: document.getElementById('reward-image'),
        playAgainBtn: document.getElementById('play-again-btn'),
        shareBtn: document.getElementById('share-btn'),

        // Audio
        selectSound: document.getElementById('select-sound'),
        resultSound: document.getElementById('result-sound'),
    };
    
    // --- Utils ---
    /** Hàm xáo trộn mảng (Fisher-Yates) */
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function playSound(element) {
        element.currentTime = 0;
        element.play().catch(e => console.log("Audio play prevented:", e));
    }
    
    function loadPlayerData() {
        const storedPlayer = localStorage.getItem('detectiveGamePlayer');
        if (storedPlayer) {
            gameState.player = JSON.parse(storedPlayer);
            DOM.playerNameInput.value = gameState.player.name;
            DOM.playerClassInput.value = gameState.player.className;
        }
        DOM.totalChallenges.textContent = GAME_DATA.length;
    }
    
    function savePlayerResult() {
        const totalCorrect = gameState.challenges.filter(c => c.is_correct).length;
        gameState.player.playCount += 1;
        gameState.player.bestScore = Math.max(gameState.player.bestScore, totalCorrect);
        localStorage.setItem('detectiveGamePlayer', JSON.stringify(gameState.player));
    }

    // --- Part 1 Logic ---
    function startSetup(isReplay = false) {
        if (!isReplay) {
            const name = DOM.playerNameInput.value.trim();
            const className = DOM.playerClassInput.value.trim();
            
            if (!name || !className) {
                alert('Vui lòng nhập Họ và tên và Lớp của bạn!');
                return;
            }
            
            gameState.player.name = name;
            gameState.player.className = className;
        }
        
        // Reset game state for a new session
        gameState.currentChallengeIndex = 0;
        gameState.startTime = new Date();
        gameState.challenges = JSON.parse(JSON.stringify(GAME_DATA)); // Deep copy
        shuffleArray(gameState.challenges); // Xáo trộn thứ tự các câu hỏi
        
        // Chuẩn bị dữ liệu bên trong từng thử thách (vd: xáo trộn đáp án)
        gameState.challenges.forEach(challenge => {
            if (challenge.type === 'multiple-choice') {
                shuffleArray(challenge.options);
            } else if (challenge.type === 'drag-drop') {
                shuffleArray(challenge.items);
            }
            challenge.user_answer = null;
            challenge.user_pairs = {};
            challenge.user_order = [];
            challenge.is_correct = false;
        });

        DOM.infoScreen.style.display = 'none';
        DOM.resultsScreen.style.display = 'none';
        DOM.gameScreen.style.display = 'flex';
        
        renderChallenge();
    }
    
    DOM.startBtn.addEventListener('click', () => startSetup(false));

    // --- Part 2 Logic (Game) ---
    function updateProgress() {
        const total = gameState.challenges.length;
        const current = gameState.currentChallengeIndex;
        const percent = (current / total) * 100;
        
        DOM.progressIndicator.style.width = `${percent}%`;
        DOM.progressIndicator.textContent = `${current}/${total}`;
        
        DOM.currentChallengeNumber.textContent = current + 1; // Số thứ tự hiển thị luôn là challenge hiện tại + 1
    }

    function renderChallenge() {
        if (gameState.currentChallengeIndex >= gameState.challenges.length) {
            // Hoàn thành trò chơi
            gameState.endTime = new Date();
            savePlayerResult();
            showResults();
            return;
        }

        DOM.nextChallengeBtn.style.display = 'none';
        gameState.isChallengeCompleted = false;

        const currentChallenge = gameState.challenges[gameState.currentChallengeIndex];
        
        // Cập nhật tên thử thách
        DOM.currentChallengeNumber.textContent = gameState.currentChallengeIndex + 1;
        DOM.challengeText.textContent = currentChallenge.question;
        DOM.challengeContent.innerHTML = '';
        updateProgress();

        // Render theo loại câu hỏi
        switch (currentChallenge.type) {
            case 'multiple-choice':
            case 'true-false':
                renderMultipleChoice(currentChallenge);
                break;
            case 'matching':
                renderMatching(currentChallenge);
                break;
            case 'drag-drop':
                renderDragDrop(currentChallenge);
                break;
        }
    }

    // --- Question Type Renderers ---
    
    // Trắc nghiệm & Đúng/Sai
    function renderMultipleChoice(challenge) {
        const isTrueFalse = challenge.type === 'true-false';
        const container = document.createElement('div');
        container.className = isTrueFalse ? 'options-grid true-false-options' : 'options-grid';

        challenge.options.forEach(optionText => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerHTML = optionText;
            btn.onclick = () => handleMultipleChoice(challenge, optionText, btn);
            container.appendChild(btn);
        });
        
        DOM.challengeContent.appendChild(container);
    }
    
    function handleMultipleChoice(challenge, selectedAnswer, btn) {
        if (gameState.isChallengeCompleted) return;
        
        playSound(DOM.selectSound);
        
        // Cập nhật giao diện: Đánh dấu lựa chọn
        document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        
        // Lưu kết quả người chơi
        challenge.user_answer = selectedAnswer;
        challenge.is_correct = (selectedAnswer === challenge.correct_answer);
        
        gameState.isChallengeCompleted = true;
        DOM.nextChallengeBtn.style.display = 'block';
    }

    // Nối cột (Matching)
    let selectedA = null;

    function renderMatching(challenge) {
        const container = document.createElement('div');
        container.className = 'matching-container';

        const colA = document.createElement('div');
        colA.className = 'column column-a';
        
        const colB = document.createElement('div');
        colB.className = 'column column-b';
        
        // Shuffle B column for randomness
        const shuffledB = shuffleArray(challenge.items_b);

        challenge.items_a.forEach(item => {
            const div = document.createElement('div');
            div.className = 'match-item item-a';
            div.id = item.id;
            div.textContent = item.text;
            div.onclick = () => handleMatching(challenge, item.id, 'A', div);
            colA.appendChild(div);
        });

        shuffledB.forEach(item => {
            const div = document.createElement('div');
            div.className = 'match-item item-b';
            div.id = item.id;
            div.textContent = item.text;
            div.onclick = () => handleMatching(challenge, item.id, 'B', div);
            colB.appendChild(div);
        });

        container.appendChild(colA);
        container.appendChild(colB);
        DOM.challengeContent.appendChild(container);
    }

    function handleMatching(challenge, itemId, column, element) {
        if (gameState.isChallengeCompleted) return;
        playSound(DOM.selectSound);

        if (column === 'A') {
            // Bỏ chọn mục A cũ
            if (selectedA) {
                document.getElementById(selectedA).classList.remove('selected-match');
            }
            
            // Chọn mục A mới
            selectedA = itemId;
            element.classList.add('selected-match');
        } else if (column === 'B' && selectedA) {
            // Đã có A được chọn, tiến hành nối
            
            // Lưu cặp nối (A -> B)
            challenge.user_pairs[selectedA] = itemId;
            
            // Đánh dấu đã nối trên giao diện
            element.classList.add('matched');
            document.getElementById(selectedA).classList.add('matched');
            
            // Loại bỏ trạng thái chọn
            document.getElementById(selectedA).classList.remove('selected-match');
            selectedA = null;
            
            // Kiểm tra hoàn thành
            if (Object.keys(challenge.user_pairs).length === challenge.items_a.length) {
                checkMatchingComplete(challenge);
            }
        }
    }

    function checkMatchingComplete(challenge) {
        let isCorrect = true;
        
        for (const [idA, idB] of Object.entries(challenge.correct_pairs)) {
            if (challenge.user_pairs[idA] !== idB) {
                isCorrect = false;
                break;
            }
        }
        
        challenge.is_correct = isCorrect;
        gameState.isChallengeCompleted = true;
        DOM.nextChallengeBtn.style.display = 'block';
    }

    // Kéo thả (Drag-Drop/Ordering)
    let draggedItem = null;

    function renderDragDrop(challenge) {
        const container = document.createElement('div');
        container.className = 'drag-drop-container';

        // Tạo bản sao của mảng items để đảm bảo tính nguyên bản của challenge.items
        const shuffledItems = challenge.items;

        shuffledItems.forEach(item => {
            const div = document.createElement('div');
            div.className = 'drop-item';
            div.id = `item-${item.id}`;
            div.textContent = item.text;
            div.draggable = true;
            
            div.addEventListener('dragstart', (e) => {
                draggedItem = div;
                setTimeout(() => div.classList.add('dragging'), 0);
            });

            div.addEventListener('dragend', () => {
                draggedItem.classList.remove('dragging');
                draggedItem = null;
                // Sau khi thả, cập nhật thứ tự và kiểm tra
                updateDragDropOrder(challenge, container);
            });

            div.addEventListener('dragover', (e) => {
                e.preventDefault(); // Cho phép thả
                const boundingBox = div.getBoundingClientRect();
                const offset = boundingBox.y + boundingBox.height / 2;
                if (e.clientY < offset) {
                    container.insertBefore(draggedItem, div);
                } else {
                    container.insertBefore(draggedItem, div.nextSibling);
                }
            });
            
            div.addEventListener('dragleave', () => {});
            div.addEventListener('drop', (e) => { e.preventDefault(); });
            
            container.appendChild(div);
        });

        DOM.challengeContent.appendChild(container);
    }

    function updateDragDropOrder(challenge, container) {
        const items = Array.from(container.children);
        const userOrder = items.map(item => parseInt(item.id.replace('item-', '')));
        
        challenge.user_order = userOrder;
        
        // Kiểm tra đúng/sai (Chấp nhận kết quả ngay sau khi thả lần cuối)
        let isCorrect = challenge.correct_order.length === userOrder.length && 
                        challenge.correct_order.every((val, index) => val === userOrder[index]);
                        
        challenge.is_correct = isCorrect;
        
        // Kích hoạt nút tiếp tục ngay sau khi thao tác
        gameState.isChallengeCompleted = true;
        DOM.nextChallengeBtn.style.display = 'block';
    }

    DOM.nextChallengeBtn.addEventListener('click', () => {
        if (!gameState.isChallengeCompleted) {
            alert('Vui lòng hoàn thành thử thách trước khi tiếp tục!');
            return;
        }

        gameState.currentChallengeIndex++;
        if (gameState.currentChallengeIndex < gameState.challenges.length) {
            // Tạm dừng 1 chút để có hiệu ứng chuyển cảnh
            setTimeout(renderChallenge, 300);
        } else {
            // Hoàn thành trò chơi
            gameState.endTime = new Date();
            savePlayerResult();
            showResults();
        }
    });

    // --- Part 3 Logic (Results) ---
    function showResults() {
        DOM.gameScreen.style.display = 'none';
        DOM.infoScreen.style.display = 'none';
        DOM.resultsScreen.style.display = 'flex';
        
        playSound(DOM.resultSound);

        const totalChallenges = gameState.challenges.length;
        const correctChallenges = gameState.challenges.filter(c => c.is_correct).length;
        const percentage = totalChallenges > 0 ? Math.round((correctChallenges / totalChallenges) * 100) : 0;
        const timeTaken = Math.round((gameState.endTime - gameState.startTime) / 1000); // in seconds
        
        // Display Info
        DOM.resName.textContent = gameState.player.name;
        DOM.resClass.textContent = gameState.player.className;
        DOM.resPlayCount.textContent = gameState.player.playCount;
        DOM.resTotal.textContent = totalChallenges;
        DOM.resCorrect.textContent = correctChallenges;
        DOM.resPercentage.textContent = `${percentage}%`;
        DOM.resTime.textContent = `${Math.floor(timeTaken / 60)} phút ${timeTaken % 60} giây`;
        
        // Display Comment & Reward
        let commentText = '';
        let rewardIcon = '✨';

        if (percentage === 100) {
            commentText = '🎉 Tuyệt vời! Bạn đã hoàn thành xuất sắc 100% nhiệm vụ. Bạn là một Thám tử Tin học tài ba!';
            rewardIcon = '🥇';
        } else if (percentage >= 70) {
            commentText = '🌟 Hoàn thành tốt! Bạn đã thu thập được hầu hết thông tin quan trọng. Hãy thử lại để đạt kết quả hoàn hảo nhé!';
            rewardIcon = '🏆';
        } else if (percentage >= 50) {
            commentText = '🙂 Cố gắng hơn nữa! Bạn đã hoàn thành hơn một nửa thử thách. Việc thu thập thông tin rất quan trọng, hãy ôn lại bài để lần sau tốt hơn!';
            rewardIcon = '💡';
        } else {
            commentText = '😥 Bạn cần luyện tập thêm! Việc tìm kiếm và chọn lọc thông tin là kĩ năng rất quan trọng. Hãy ôn lại Bài 3 và chơi lại nhé!';
            rewardIcon = '📚';
        }
        
        DOM.comment.textContent = commentText;
        DOM.rewardImage.textContent = rewardIcon;
    }

    DOM.playAgainBtn.addEventListener('click', () => {
        // Chơi lại: Giữ thông tin người chơi, tăng số lần chơi
        startSetup(true); 
    });
    
    // Chia sẻ kết quả (Dùng html2canvas)
    DOM.shareBtn.addEventListener('click', () => {
        const areaToCapture = DOM.printableArea;
        
        // Ẩn nút Chơi lại/Chia sẻ trong ảnh chụp (tùy chọn)
        DOM.playAgainBtn.style.display = 'none';
        DOM.shareBtn.style.display = 'none';

        html2canvas(areaToCapture, {
            scale: 2, // Tăng chất lượng ảnh
            backgroundColor: null, // Giữ nền trong suốt nếu không set background cụ thể
        }).then(canvas => {
            // Hiển thị lại nút
            DOM.playAgainBtn.style.display = 'inline-block';
            DOM.shareBtn.style.display = 'inline-block';

            // Tạo link download
            const image = canvas.toDataURL("image/png");
            const link = document.createElement('a');
            link.href = image;
            link.download = `Ket_qua_tham_tu_Tin_hoc_${gameState.player.name}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    });

    // Load data khi trang được tải
    loadPlayerData();
</script>
</body>
</html>
