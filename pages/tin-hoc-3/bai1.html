<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHUY·∫æN PHI√äU L∆ØU QUY·∫æT ƒê·ªäNH - Tin h·ªçc 3</title>
    <style>
        /* CSS cho tr√≤ ch∆°i */
        :root {
            --primary-color: #4CAF50; /* Xanh l√° c√¢y */
            --secondary-color: #FF9800; /* Cam */
            --background-color: #E8F5E9; /* N·ªÅn xanh nh·∫°t */
            --card-color: #FFFFFF;
            --correct-color: #4CAF50;
            --incorrect-color: #F44336;
            --button-hover: #388E3C;
            --font-family: 'Arial', sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            text-align: center;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text x="50%" y="50%" font-size="20" fill="%23b9f6ca" text-anchor="middle" dominant-baseline="central">üí°</text></svg>');
            background-size: 50px 50px;
        }

        .game-container {
            background-color: var(--card-color);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 30px;
            width: 90%;
            max-width: 800px;
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        h1 {
            color: var(--primary-color);
            margin-bottom: 5px;
            font-size: 2em;
        }

        h2 {
            color: var(--secondary-color);
            margin-bottom: 20px;
            font-size: 1.2em;
        }

        .input-group, .challenge-area {
            margin-bottom: 20px;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        input[type="text"] {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 15px;
            border: 2px solid var(--primary-color);
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            border-color: var(--secondary-color);
            outline: none;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.1s;
            box-shadow: 0 4px 0 var(--button-hover);
            margin: 5px;
        }

        button:hover {
            background-color: var(--button-hover);
        }

        button:active {
            transform: translateY(4px);
            box-shadow: 0 0 0;
        }

        .question-box {
            background-color: #F1F8E9;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 1px solid var(--primary-color);
            animation: slideIn 0.4s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .question-text {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .options-container {
            display: grid;
            gap: 10px;
        }
        
        /* Multiple Choice Option Styling */
        .option-btn {
            background-color: #E3F2FD;
            border: 2px solid #90CAF9;
            color: #333;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
            text-align: left;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .option-btn:hover:not(.selected) {
            background-color: #BBDEFB;
            border-color: #2196F3;
        }

        .option-btn.selected {
            background-color: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
            font-weight: bold;
        }
        
        /* True/False Option Styling */
        .tf-option-btn {
            display: inline-block;
            width: 48%;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: bold;
            margin: 5px 1%;
        }

        /* Matching (N·ªëi C·ªôt) Styling */
        .matching-container {
            display: flex;
            justify-content: space-around;
            text-align: center;
        }

        .column {
            width: 45%;
            padding: 10px;
            border: 1px dashed #BDBDBD;
            border-radius: 10px;
        }

        .match-item {
            padding: 15px;
            margin: 8px 0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s, box-shadow 0.2s;
            color: #333;
            border: 1px solid #CFD8DC;
        }

        .column-A .match-item { background-color: #FFE0B2; }
        .column-B .match-item { background-color: #BBDEFB; }

        .column-A .match-item.selected { 
            background-color: var(--secondary-color); 
            color: white;
            box-shadow: 0 0 10px var(--secondary-color);
        }

        .column-A .match-item.matched, .column-B .match-item.matched {
            background-color: #A5D6A7; /* Xanh nh·∫°t ƒë√£ n·ªëi */
            color: #333;
            opacity: 0.8; 
            cursor: default;
        }
        
        .column-A .match-item.matched-incorrect, .column-B .match-item.matched-incorrect {
            background-color: #FFCDD2; /* ƒê·ªè nh·∫°t n·ªëi sai */
            color: #333;
            opacity: 0.8;
            cursor: default;
        }

        /* Result Screen Styling */
        #result-screen {
            background-color: #FFFDE7;
            padding: 30px;
            border: 5px dashed var(--secondary-color);
            border-radius: 20px;
        }

        #result-screen h3 {
            color: var(--correct-color);
            font-size: 2.5em;
            margin-top: 0;
        }

        .trophy {
            font-size: 4em;
            margin: 10px 0;
            display: block;
            animation: pulse 1s infinite alternate;
        }

        @keyframes pulse {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }

        .review-comment {
            font-style: italic;
            font-size: 1.2em;
            color: #6A1B9A;
            margin: 15px 0 25px 0;
            padding: 10px;
            background-color: #F3E5F5;
            border-radius: 10px;
        }

        .stat-line {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px dotted #CCC;
            font-size: 1.1em;
        }

        .stat-line span:first-child { font-weight: bold; color: #555; }
        .stat-line span:last-child { color: var(--primary-color); font-weight: bold; }

        #share-image {
            display: none; /* ·∫®n th·∫ª n√†y, ch·ªâ hi·ªán th·ªã ·∫£nh ch·ª•p m√†n h√¨nh */
        }
        
        #progress-bar {
            height: 15px;
            background-color: #ddd;
            border-radius: 10px;
            margin-top: 15px;
            overflow: hidden;
        }

        #progress-bar-fill {
            height: 100%;
            width: 0%;
            background-color: var(--secondary-color);
            transition: width 0.3s;
        }

    </style>
</head>
<body>

<div class="game-container" id="game-container">
    <div id="start-screen">
        <h1>CHUY·∫æN PHI√äU L∆ØU QUY·∫æT ƒê·ªäNH üß†</h1>
        <h2>Tin h·ªçc 3 - B√†i 1: Th√¥ng tin v√† quy·∫øt ƒë·ªãnh</h2>

        <div class="input-group">
            <label for="player-name">H·ªç v√† t√™n h·ªçc sinh:</label>
            <input type="text" id="player-name" placeholder="Nh·∫≠p t√™n c·ªßa em">
        </div>
        <div class="input-group">
            <label for="player-class">L·ªõp:</label>
            <input type="text" id="player-class" placeholder="Nh·∫≠p t√™n l·ªõp">
        </div>
        
        <p style="font-size:0.9em; color:#777;">*L∆∞u √Ω: Em ch·ªâ ƒë∆∞·ª£c ch·ªçn ƒë√°p √°n m·ªôt l·∫ßn duy nh·∫•t cho m·ªói th·ª≠ th√°ch!</p>
        <button onclick="startGame()">B·∫ÆT ƒê·∫¶U PHI√äU L∆ØU! ‚ú®</button>
    </div>

    <div id="game-screen" style="display: none;">
        <h2 id="challenge-title">Th·ª≠ th√°ch 1/6</h2>
        <div id="progress-bar">
            <div id="progress-bar-fill"></div>
        </div>
        <div class="question-box">
            <p class="question-text" id="question-text"></p>
            <div id="options-area" class="options-container">
                </div>
            <div style="margin-top: 15px; color: #666; font-style: italic;" id="selection-status"></div>
            <button id="next-button" onclick="nextChallenge()" style="display:none; background-color: #03A9F4; box-shadow: 0 4px 0 #0288D1;">TH·ª¨ TH√ÅCH TI·∫æP THEO</button>
        </div>
        
        <p style="text-align: center; color: var(--primary-color); font-weight: bold;">
            ƒê√£ ho√†n th√†nh: <span id="challenges-completed">0</span>/<span id="challenges-total"></span>
        </p>
    </div>

    <div id="result-screen" style="display: none;">
        <h3>K·∫æT QU·∫¢ PHI√äU L∆ØU</h3>
        <span class="trophy" id="trophy-icon"></span>
        <div id="result-info" style="margin-bottom: 20px;">
            <div class="stat-line"><span class="label">H·ªç v√† t√™n:</span> <span id="result-name"></span></div>
            <div class="stat-line"><span class="label">L·ªõp:</span> <span id="result-class"></span></div>
            <div class="stat-line"><span class="label">S·ªë l·∫ßn ch∆°i:</span> <span id="result-times-played"></span></div>
            <div class="stat-line"><span class="label">T·ªïng th·ªùi gian:</span> <span id="result-time"></span></div>
            <div class="stat-line"><span class="label">S·ªë th·ª≠ th√°ch ƒë√∫ng:</span> <span id="result-correct-count"></span></div>
            <div class="stat-line"><span class="label">T·ªïng th·ª≠ th√°ch:</span> <span id="result-total-count"></span></div>
            <div class="stat-line"><span class="label">% Ho√†n th√†nh ƒë√∫ng:</span> <span id="result-percentage"></span></div>
        </div>
        
        <div class="review-comment" id="result-review"></div>
        
        <button onclick="restartGame()">CH∆†I L·∫†I üí™</button>
        <button onclick="shareResult()" style="background-color: #2196F3; box-shadow: 0 4px 0 #1976D2;">CHIA S·∫∫ K·∫æT QU·∫¢ üì∏</button>
        <img id="share-image" src="" alt="K·∫øt qu·∫£ tr√≤ ch∆°i">
    </div>
</div>

<script>
    // D·ªØ li·ªáu c√¢u h·ªèi (6 c√¢u/th·ª≠ th√°ch)
    const initialQuestions = [
        {
            id: 1,
            type: 'multiple-choice',
            question: 'Khi em nh√¨n th·∫•y **ƒë√®n giao th√¥ng chuy·ªÉn sang m√†u ƒë·ªè** (Th√¥ng tin), em quy·∫øt ƒë·ªãnh **d·ª´ng l·∫°i** (Quy·∫øt ƒë·ªãnh). ƒê√¢u l√† **Th√¥ng tin** em ƒë√£ nh·∫≠n ƒë∆∞·ª£c?',
            options: ['Em d·ª´ng l·∫°i', 'ƒê√®n giao th√¥ng chuy·ªÉn sang m√†u ƒë·ªè', 'Em ƒëi ti·∫øp', 'Xe c·ªô ƒë√¥ng ƒë√∫c'],
            answer: 'ƒê√®n giao th√¥ng chuy·ªÉn sang m√†u ƒë·ªè'
        },
        {
            id: 2,
            type: 'true-false',
            question: 'Th√¥ng tin c√≥ vai tr√≤ **kh√¥ng** quan tr·ªçng trong vi·ªác ra quy·∫øt ƒë·ªãnh c·ªßa con ng∆∞·ªùi.',
            options: ['ƒê√∫ng', 'Sai'],
            answer: 'Sai'
        },
        {
            id: 3,
            type: 'multiple-choice',
            question: 'B·∫°n An xem d·ª± b√°o th·ªùi ti·∫øt th·∫•y **tr·ªùi s·∫Ω m∆∞a** (Th√¥ng tin) n√™n ƒë√£ **mang √°o m∆∞a** (Quy·∫øt ƒë·ªãnh). ƒê√¢u l√† **Quy·∫øt ƒë·ªãnh** c·ªßa b·∫°n An?',
            options: ['Xem d·ª± b√°o th·ªùi ti·∫øt', 'Tr·ªùi s·∫Ω m∆∞a', 'Mang √°o m∆∞a', 'C·∫∑p s√°ch n·∫∑ng'],
            answer: 'Mang √°o m∆∞a'
        },
        {
            id: 4,
            type: 'matching',
            question: 'H√£y n·ªëi c√°c **Th√¥ng tin** ·ªü c·ªôt A v·ªõi c√°c **Quy·∫øt ƒë·ªãnh** t∆∞∆°ng ·ª©ng ·ªü c·ªôt B ƒë·ªÉ ho√†n th√†nh th·ª≠ th√°ch!',
            columnsA: ['Nghe ti·∫øng c√≤i **Xe c·ª©u th∆∞∆°ng**', 'Th·∫•y bi·ªÉn b√°o **C·∫§M X·∫¢ R√ÅC**'],
            columnsB: ['D·ª´ng l·∫°i v√† nh∆∞·ªùng ƒë∆∞·ªùng', 'Kh√¥ng v·ª©t r√°c xu·ªëng ƒë∆∞·ªùng'],
            correctMatches: {
                'Nghe ti·∫øng c√≤i **Xe c·ª©u th∆∞∆°ng**': 'D·ª´ng l·∫°i v√† nh∆∞·ªùng ƒë∆∞·ªùng',
                'Th·∫•y bi·ªÉn b√°o **C·∫§M X·∫¢ R√ÅC**': 'Kh√¥ng v·ª©t r√°c xu·ªëng ƒë∆∞·ªùng'
            },
        },
        {
            id: 5,
            type: 'multiple-choice',
            question: 'Bi·ªÉn b√°o **"C·∫§M L·∫†I G·∫¶N, NGUY HI·ªÇM ƒêI·ªÜN GI·∫¨T"** truy·ªÅn t·∫£i th√¥ng tin b·∫±ng h√¨nh th·ª©c n√†o?',
            options: ['√Çm thanh', 'VƒÉn b·∫£n v√† H√¨nh ·∫£nh', 'Kh·ª©u gi√°c', 'C·∫£m gi√°c'],
            answer: 'VƒÉn b·∫£n v√† H√¨nh ·∫£nh'
        },
        {
            id: 6,
            type: 'multiple-choice',
            question: 'M·∫π d·∫∑n em **"N·∫øu ƒë√®n ƒë·ªè b·∫≠t s√°ng (Th√¥ng tin), con ph·∫£i d·ª´ng l·∫°i (Quy·∫øt ƒë·ªãnh)"**. ƒêi·ªÅu ki·ªán ƒë·ªÉ em **d·ª´ng l·∫°i** l√† g√¨?',
            options: ['M·∫π d·∫∑n', 'ƒê√®n ƒë·ªè b·∫≠t s√°ng', 'Em ƒëang ƒëi nhanh', 'Con ƒë∆∞·ªùng r·ªông'],
            answer: 'ƒê√®n ƒë·ªè b·∫≠t s√°ng'
        }
    ];

    // Bi·∫øn tr·∫°ng th√°i tr√≤ ch∆°i
    let playerName = '';
    let playerClass = '';
    let questions = [];
    let currentChallengeIndex = 0;
    let correctCount = 0;
    let timesPlayed = parseInt(localStorage.getItem('timesPlayed')) || 0;
    let startTime;
    let timerInterval;
    let selectedMatchA = null; // Bi·∫øn to√†n c·ª•c ƒë·ªÉ x·ª≠ l√Ω Matching

    // √Çm thanh (C·∫ßn thay th·∫ø b·∫±ng file .mp3 th·ª±c t·∫ø)
    const audioCorrect = { play: () => console.log('Playing correct sound placeholder') }; // Placeholder
    const audioIncorrect = { play: () => console.log('Playing incorrect sound placeholder') }; // Placeholder
    const audioEnd = { play: () => console.log('Playing end game sound placeholder') }; // Placeholder

    // --- C√ÅC H√ÄM TI·ªÜN √çCH ---

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    function startTimer() {
        startTime = Date.now();
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {}, 1000); // Gi·ªØ interval ƒë·ªÉ t√≠nh th·ªùi gian
    }

    function stopTimer() {
        clearInterval(timerInterval);
        return (Date.now() - startTime) / 1000;
    }

    // --- KH·ªûI ƒê·ªòNG V√Ä T√ÅI T·∫†O TR√í CH∆†I ---

    function startGame() {
        const nameInput = document.getElementById('player-name').value.trim();
        const classInput = document.getElementById('player-class').value.trim();

        if (nameInput === '' || classInput === '') {
            alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß H·ªç v√† t√™n v√† L·ªõp.');
            return;
        }

        playerName = nameInput;
        playerClass = classInput;
        timesPlayed++;
        localStorage.setItem('timesPlayed', timesPlayed);
        localStorage.setItem('playerName', playerName);
        localStorage.setItem('playerClass', playerClass);

        questions = JSON.parse(JSON.stringify(initialQuestions));
        shuffleArray(questions);

        // Kh·ªüi t·∫°o c√°c bi·∫øn tr·∫°ng th√°i c·∫ßn thi·∫øt cho tr√≤ ch∆°i m·ªõi
        questions.forEach(q => q.isAnswered = false);

        currentChallengeIndex = 0;
        correctCount = 0;
        selectedMatchA = null;

        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('game-screen').style.display = 'block';
        document.getElementById('challenges-total').textContent = questions.length;

        startTimer();
        loadChallenge(currentChallengeIndex);
    }

    function restartGame() {
        // T·∫£i l·∫°i th√¥ng tin ng∆∞·ªùi ch∆°i c≈© v√† b·∫Øt ƒë·∫ßu game m·ªõi
        const nameInput = document.getElementById('player-name');
        const classInput = document.getElementById('player-class');
        
        playerName = localStorage.getItem('playerName') || '';
        playerClass = localStorage.getItem('playerClass') || '';
        
        nameInput.value = playerName;
        classInput.value = playerClass;

        document.getElementById('result-screen').style.display = 'none';
        document.getElementById('start-screen').style.display = 'block';
    }


    // --- HI·ªÇN TH·ªä C√ÇU H·ªéI ---

    function loadChallenge(index) {
        if (index >= questions.length) {
            showResult();
            return;
        }
        
        const challenge = questions[index];
        const optionsArea = document.getElementById('options-area');
        const questionText = document.getElementById('question-text');
        const selectionStatus = document.getElementById('selection-status');
        const nextButton = document.getElementById('next-button');

        // C·∫≠p nh·∫≠t giao di·ªán
        document.getElementById('challenge-title').textContent = `Th·ª≠ th√°ch ${index + 1}/${questions.length}`;
        document.getElementById('challenges-completed').textContent = index;
        const progress = (index / questions.length) * 100;
        document.getElementById('progress-bar-fill').style.width = `${progress}%`;

        questionText.innerHTML = challenge.question;
        optionsArea.innerHTML = '';
        optionsArea.classList.remove('matching-layout'); // ƒê·∫£m b·∫£o layout m·∫∑c ƒë·ªãnh
        selectionStatus.textContent = '';
        nextButton.style.display = 'none';

        if (challenge.type === 'multiple-choice' || challenge.type === 'true-false') {
            optionsArea.classList.add('options-container'); // B·∫≠t grid layout
            loadMultipleChoice(challenge, optionsArea);
        } else if (challenge.type === 'matching') {
            optionsArea.classList.remove('options-container'); // T·∫Øt grid layout cho matching
            optionsArea.classList.add('matching-layout');
            loadMatching(challenge, optionsArea);
        }
    }

    function loadMultipleChoice(challenge, optionsArea) {
        let optionsToDisplay = [...challenge.options];
        if(challenge.type === 'multiple-choice') {
            shuffleArray(optionsToDisplay);
        }
        
        optionsToDisplay.forEach((option, idx) => {
            const btn = document.createElement('div');
            btn.classList.add('option-btn');
            if (challenge.type === 'true-false') {
                btn.classList.add('tf-option-btn');
            }
            btn.innerHTML = option;
            btn.dataset.value = option;
            btn.onclick = () => selectOption(btn, challenge);
            optionsArea.appendChild(btn);
        });
    }

    function loadMatching(challenge, optionsArea) {
        let shuffledA = [...challenge.columnsA];
        let shuffledB = [...challenge.columnsB];
        shuffleArray(shuffledA);
        shuffleArray(shuffledB);

        const matchingHTML = `
            <div class="matching-container">
                <div class="column column-A">
                    <h3>C·ªôt A (Th√¥ng tin)</h3>
                    ${shuffledA.map((item, idx) => `<div class="match-item" data-column="A" data-original-value="${item.replace(/<[^>]*>?/gm, '')}" data-index="${idx}">${item}</div>`).join('')}
                </div>
                <div class="column column-B">
                    <h3>C·ªôt B (Quy·∫øt ƒë·ªãnh)</h3>
                    ${shuffledB.map((item, idx) => `<div class="match-item" data-column="B" data-original-value="${item.replace(/<[^>]*>?/gm, '')}" data-index="${idx}">${item}</div>`).join('')}
                </div>
            </div>
        `;
        optionsArea.innerHTML = matchingHTML;
        
        // Kh·ªüi t·∫°o tr·∫°ng th√°i Matching
        challenge.matchState = {
            correctPairs: 0,
            incorrectPairs: 0,
            totalPairs: challenge.columnsA.length,
            isAnswered: false,
        };
        
        document.querySelectorAll('.match-item').forEach(item => {
            item.onclick = (e) => handleMatchClick(e.currentTarget, challenge);
        });
    }

    // --- X·ª¨ L√ù TR·∫¢ L·ªúI ---

    function handleMatchClick(item, challenge) {
        if (challenge.matchState.isAnswered || item.classList.contains('matched') || item.classList.contains('matched-incorrect')) return;

        const column = item.dataset.column;
        
        // X·ª≠ l√Ω C·ªôt A (Ch·ªçn Th√¥ng tin)
        if (column === 'A') {
            if (selectedMatchA) {
                selectedMatchA.classList.remove('selected');
            }
            selectedMatchA = item;
            selectedMatchA.classList.add('selected');
            document.getElementById('selection-status').textContent = `ƒê√£ ch·ªçn: ${item.textContent.trim()} (C·ªôt A). Nh·∫•p v√†o c·ªôt B ƒë·ªÉ n·ªëi.`;
            // audioCorrect.play().catch(() => {});
        } 
        // X·ª≠ l√Ω C·ªôt B (N·ªëi v·ªõi Quy·∫øt ƒë·ªãnh)
        else if (column === 'B' && selectedMatchA) {
            const valA = selectedMatchA.dataset.originalValue;
            const valB = item.dataset.originalValue;

            let isCorrect = (challenge.correctMatches[valA] === valB);
            
            // ƒê√°nh d·∫•u c·∫∑p ƒë√£ ch·ªçn v√† v√¥ hi·ªáu h√≥a
            selectedMatchA.classList.remove('selected');
            selectedMatchA.onclick = null;
            item.onclick = null;
            
            if (isCorrect) {
                challenge.matchState.correctPairs++;
                selectedMatchA.classList.add('matched');
                item.classList.add('matched');
                // audioCorrect.play().catch(() => {});
            } else {
                challenge.matchState.incorrectPairs++;
                selectedMatchA.classList.add('matched-incorrect');
                item.classList.add('matched-incorrect');
                // audioIncorrect.play().catch(() => {});
            }

            selectedMatchA = null; // Reset ch·ªçn A
            
            const totalAnswered = challenge.matchState.correctPairs + challenge.matchState.incorrectPairs;

            // Ki·ªÉm tra ho√†n th√†nh th·ª≠ th√°ch
            if (totalAnswered === challenge.matchState.totalPairs) {
                challenge.isAnswered = true;
                const finalResult = (challenge.matchState.correctPairs === challenge.matchState.totalPairs);
                
                checkAnswer(challenge, finalResult);
                
                // Hi·ªÉn th·ªã n√∫t chuy·ªÉn ti·∫øp
                document.getElementById('next-button').style.display = 'block';
                document.getElementById('selection-status').textContent = `Ho√†n th√†nh th·ª≠ th√°ch. K·∫øt qu·∫£: ${challenge.matchState.correctPairs}/${challenge.matchState.totalPairs} c·∫∑p ƒë√∫ng.`;
            } else {
                document.getElementById('selection-status').textContent = `ƒê√£ n·ªëi ${totalAnswered}/${challenge.matchState.totalPairs} c·∫∑p. Ti·∫øp t·ª•c n·ªëi c√°c c·∫∑p c√≤n l·∫°i.`;
            }
        }
    }


    function selectOption(btn, challenge) {
        if (challenge.isAnswered) return;
        challenge.isAnswered = true;

        const allOptions = document.querySelectorAll('.option-btn');
        allOptions.forEach(opt => {
            opt.classList.remove('selected');
            opt.onclick = null; // V√¥ hi·ªáu h√≥a c√°c l·ª±a ch·ªçn
        });

        btn.classList.add('selected');
        document.getElementById('selection-status').textContent = `Em ƒë√£ ch·ªçn: ${btn.textContent.trim()}`;
        document.getElementById('next-button').style.display = 'block';

        const isCorrect = (btn.dataset.value === challenge.answer);
        checkAnswer(challenge, isCorrect);
    }

    function checkAnswer(challenge, isCorrect) {
        if (isCorrect) {
            correctCount++;
            // audioCorrect.play().catch(() => {});
        } else {
            // audioIncorrect.play().catch(() => {});
        }
        // L∆∞u tr·ªØ k·∫øt qu·∫£
        challenge.isCorrect = isCorrect;
    }

    function nextChallenge() {
        if (currentChallengeIndex < questions.length - 1) {
            currentChallengeIndex++;
            loadChallenge(currentChallengeIndex);
        } else {
            showResult();
        }
    }

    // --- HI·ªÇN TH·ªä K·∫æT QU·∫¢ ---

    function formatTime(totalSeconds) {
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = Math.floor(totalSeconds % 60);
        return `${minutes} ph√∫t ${seconds} gi√¢y`;
    }

    function showResult() {
        const totalSeconds = stopTimer();
        // audioEnd.play().catch(() => {});

        document.getElementById('game-screen').style.display = 'none';
        document.getElementById('result-screen').style.display = 'block';

        const percentage = Math.round((correctCount / questions.length) * 100);

        // Hi·ªÉn th·ªã th√¥ng tin
        document.getElementById('result-name').textContent = playerName;
        document.getElementById('result-class').textContent = playerClass;
        document.getElementById('result-times-played').textContent = timesPlayed;
        document.getElementById('result-correct-count').textContent = correctCount;
        document.getElementById('result-total-count').textContent = questions.length;
        document.getElementById('result-percentage').textContent = `${percentage}%`;
        document.getElementById('result-time').textContent = formatTime(totalSeconds);

        // ƒê√°nh gi√° v√† ph·∫ßn th∆∞·ªüng
        let reviewText = '';
        let trophyIcon = '‚ùì'; // M·∫∑c ƒë·ªãnh
        if (percentage === 100) {
            reviewText = 'CH√öC M·ª™NG! üéâ Em ƒë√£ ho√†n th√†nh xu·∫•t s·∫Øc t·∫•t c·∫£ th·ª≠ th√°ch. Em ƒë√£ n·∫Øm v·ªØng vai tr√≤ c·ªßa Th√¥ng tin v√† Quy·∫øt ƒë·ªãnh!';
            trophyIcon = 'üèÜ';
        } else if (percentage >= 70) {
            reviewText = 'R·∫•t T·ªët! üëç Em ƒë√£ ho√†n th√†nh t·ªët, ch·ªâ c·∫ßn √¥n luy·ªán th√™m m·ªôt ch√∫t ƒë·ªÉ ƒë·∫°t ƒëi·ªÉm tuy·ªát ƒë·ªëi. Em ƒë√£ hi·ªÉu r√µ b√†i h·ªçc.';
            trophyIcon = 'üåü';
        } else if (percentage >= 50) {
            reviewText = 'C·ªë g·∫Øng l√™n! Em ƒë√£ ho√†n th√†nh ƒë∆∞·ª£c m·ªôt n·ª≠a s·ªë th·ª≠ th√°ch. H√£y ch∆°i l·∫°i ƒë·ªÉ n·∫Øm ch·∫Øc ki·∫øn th·ª©c h∆°n nh√©.';
            trophyIcon = 'üìö';
        } else {
            reviewText = 'Ch∆∞a ho√†n th√†nh. Em c·∫ßn xem l·∫°i B√†i 1: Th√¥ng tin v√† quy·∫øt ƒë·ªãnh ƒë·ªÉ hi·ªÉu r√µ h∆°n v·ªÅ c√°ch ra quy·∫øt ƒë·ªãnh nh√©.';
            trophyIcon = '‚úèÔ∏è';
        }

        document.getElementById('result-review').textContent = reviewText;
        document.getElementById('trophy-icon').textContent = trophyIcon;
    }

    function shareResult() {
            // S·ª≠ d·ª•ng html2canvas ƒë·ªÉ ch·ª•p k·∫øt qu·∫£
            const resultScreen = document.getElementById('result-screen');
            const resultContainer = resultScreen.closest('.container');

            // ·∫®n c√°c n√∫t h√†nh ƒë·ªông tr∆∞·ªõc khi ch·ª•p
            const actions = resultScreen.querySelector('.result-actions');
            actions.style.display = 'none';

            html2canvas(resultContainer, {
                scale: 2, // TƒÉng ch·∫•t l∆∞·ª£ng ·∫£nh
                backgroundColor: '#E8F5E9', // ƒê·∫£m b·∫£o n·ªÅn m√†u c·ªßa result-screen
                useCORS: true
            }).then(canvas => {
                // Hi·ªÉn th·ªã l·∫°i c√°c n√∫t sau khi ch·ª•p
                actions.style.display = 'flex'; 

                const imageURL = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.href = imageURL;
                link.download = `Ket_qua_Hanh_Trinh_Cong_Nghe_${playerName.replace(/\s/g, '_')}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                alert("ƒê√£ t·∫£i h√¨nh ·∫£nh k·∫øt qu·∫£ v·ªÅ m√°y!");
            }).catch(error => {
                console.error("L·ªói khi ch·ª•p ·∫£nh:", error);
                actions.style.display = 'flex'; 
                alert("Kh√¥ng th·ªÉ ch·ª•p ·∫£nh k·∫øt qu·∫£. Vui l√≤ng th·ª≠ l·∫°i.");
            });
        }

    // Kh·ªüi t·∫°o tr·∫°ng th√°i ban ƒë·∫ßu khi t·∫£i trang
    document.addEventListener('DOMContentLoaded', () => {
        const nameInput = document.getElementById('player-name');
        const classInput = document.getElementById('player-class');
        
        playerName = localStorage.getItem('playerName') || '';
        playerClass = localStorage.getItem('playerClass') || '';
        timesPlayed = parseInt(localStorage.getItem('timesPlayed')) || 0;
        
        nameInput.value = playerName;
        classInput.value = playerClass;
        
        document.getElementById('challenges-total').textContent = initialQuestions.length;
    });

</script>
</body>
</html>