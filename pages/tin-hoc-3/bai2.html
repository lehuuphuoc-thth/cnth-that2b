<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tin h·ªçc 3 - B√†i 2: Gi·∫£i C·ª©u Th√¥ng Tin</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        /* CSS cho tr√≤ ch∆°i */
        :root {
            --primary-color: #4CAF50; /* M√†u xanh l√° c√¢y - ch·ªß ƒë·∫°o */
            --secondary-color: #FFC107; /* M√†u v√†ng - l√†m n·ªïi b·∫≠t */
            --background-color: #E8F5E9; /* N·ªÅn nh·∫π */
            --card-color: #FFFFFF;
            --correct-color: #8BC34A; /* Xanh l√° nh·∫°t */
            --incorrect-color: #F44336; /* ƒê·ªè */
            --text-color: #333;
            --font-family: 'Arial', sans-serif;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
            40% {transform: translateY(-10px);}
            60% {transform: translateY(-5px);}
        }

        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            /* Thay ƒë·ªïi URL ·∫£nh n·ªÅn th√†nh m√†u s·∫Øc ƒë∆°n gi·∫£n ƒë·ªÉ tr√°nh l·ªói hi·ªÉn th·ªã base64 qu√° d√†i */
            background: linear-gradient(135deg, #a8e6cf 0%, #dcedc1 100%);
        }

        .game-container {
            background-color: var(--card-color);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 30px;
            max-width: 800px;
            width: 100%;
            text-align: center;
            transition: all 0.5s ease-in-out;
            position: relative;
        }

        h1 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 2.2em;
        }

        /* --- Ph·∫ßn 1: ƒêi·ªÅn th√¥ng tin --- */
        #info-section input {
            width: calc(100% - 20px);
            padding: 12px;
            margin: 10px 0;
            border: 2px solid var(--primary-color);
            border-radius: 10px;
            font-size: 1.1em;
            box-sizing: border-box;
        }

        .btn {
            background-color: var(--secondary-color);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 20px;
            transition: background-color 0.3s, transform 0.1s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn:hover {
            background-color: #FFB300;
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        /* --- Ph·∫ßn 2: Tr√≤ ch∆°i --- */
        #game-section {
            text-align: left;
        }

        #challenge-counter {
            font-size: 1.5em;
            color: var(--primary-color);
            margin-bottom: 15px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #challenge-text {
            background-color: #F1F8E9;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-left: 5px solid var(--primary-color);
        }

        .options-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .option-btn {
            background-color: #f0f0f0;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
            text-align: left;
            transition: background-color 0.2s, border-color 0.2s;
        }

        .option-btn:hover:not(.selected):not([disabled]) {
            background-color: #e0e0e0;
            border-color: var(--secondary-color);
        }

        .option-btn.selected {
            background-color: #DCE775;
            border-color: #C0CA33;
            font-weight: bold;
        }
        
        /* M√†u s·∫Øc ch·ªâ hi·ªÉn th·ªã sau khi chuy·ªÉn sang m√†n h√¨nh k·∫øt qu·∫£ */
        .option-btn[disabled].correct {
            background-color: var(--correct-color);
            border-color: #689F38;
            color: white;
        }

        .option-btn[disabled].incorrect {
            background-color: var(--incorrect-color);
            border-color: #D32F2F;
            color: white;
        }

        /* D·∫°ng N·ªëi c·ªôt (Matching) */
        .matching-area {
            position: relative;
            padding: 20px 0;
            display: flex;
            justify-content: space-around;
            min-height: 300px;
        }
        
        .matching-column {
            width: 45%;
        }
        
        .match-item {
            background-color: var(--secondary-color);
            color: white;
            padding: 10px;
            margin: 8px 0;
            border-radius: 8px;
            font-size: 1em;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: border 0.2s, box-shadow 0.2s;
            cursor: pointer;
            text-align: center;
        }
        
        .match-item.column-B {
             background-color: #AED581; /* M√†u kh√°c cho c·ªôt B */
             color: var(--text-color);
        }
        
        .match-item.selected {
            border: 3px solid var(--primary-color);
            box-shadow: 0 0 10px var(--primary-color);
        }
        
        .line-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .connection-line {
            stroke: var(--primary-color);
            stroke-width: 3;
            marker-end: url(#arrowhead);
        }


        /* --- Ph·∫ßn 3: K·∫øt qu·∫£ --- */
        #result-section {
            padding: 30px;
            background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            position: relative;
            margin-top: 20px;
        }

        #result-info p {
            font-size: 1.2em;
            margin: 10px 0;
            text-align: left;
        }

        #result-info span {
            font-weight: bold;
            color: var(--primary-color);
            float: right;
        }

        #review-text {
            font-size: 1.5em;
            font-weight: bold;
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            background-color: var(--secondary-color);
            color: white;
            animation: bounce 1s infinite;
        }

        #award-image {
            width: 100px;
            height: 100px;
            margin: 20px auto;
            background-color: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            color: white;
        }
        
        .hidden {
            display: none;
        }
        
        /* Tr·∫°ng th√°i nh√¢n v·∫≠t */
        .character-status {
            margin-top: 15px;
            font-size: 1.1em;
            color: #666;
        }
        
        .character-status span {
            color: var(--primary-color);
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div class="game-container" id="game-area">
        <h1>Gi·∫£i C·ª©u Th√¥ng Tin üí°</h1>

        <div id="info-section">
            <p>Xin ch√†o, m·ªùi em nh·∫≠p th√¥ng tin ƒë·ªÉ b·∫Øt ƒë·∫ßu h√†nh tr√¨nh!</p>
            <input type="text" id="player-name" placeholder="H·ªç v√† t√™n c·ªßa em" required>
            <input type="text" id="player-class" placeholder="L·ªõp (V√≠ d·ª•: 3A1)" required>
            <button class="btn" onclick="startGame()">B·∫Øt ƒë·∫ßu</button>
        </div>

        <div id="game-section" class="hidden">
            <div id="challenge-counter">
                <span>Th·ª≠ th√°ch: <span id="current-challenge-number">1</span> / 6</span>
                <span id="player-status">Ch√†o <span id="display-name"></span>!</span>
            </div>
            
            <div id="challenge-text"></div>
            
            <div id="question-area">
                </div>
            
            <div class="character-status">
                Tr·∫°ng th√°i: ƒê√£ ho√†n th√†nh <span id="correct-count-display">0</span> th·ª≠ th√°ch
            </div>

            <button class="btn hidden" id="next-button" onclick="nextChallenge()">Ti·∫øp t·ª•c üöÄ</button>
        </div>

        <div id="result-section" class="hidden">
            <h2>üéâ HO√ÄN TH√ÄNH TH·ª¨ TH√ÅCH üéâ</h2>
            <div id="result-info">
                <p>H·ªç t√™n: <span id="res-name"></span></p>
                <p>L·ªõp: <span id="res-class"></span></p>
                <p>S·ªë l·∫ßn ch∆°i: <span id="res-play-count"></span></p>
                <p>T·ªïng th·ª≠ th√°ch: <span id="res-total-challenges"></span></p>
                <p>S·ªë th·ª≠ th√°ch ƒë√∫ng: <span id="res-correct-challenges"></span></p>
                <p>% ho√†n th√†nh ƒë√∫ng: <span id="res-percentage"></span></p>
                <p>Th·ªùi gian ho√†n th√†nh: <span id="res-time"></span></p>
            </div>
            <div id="review-text"></div>
            <div id="award-image">üèÜ</div>
            <button class="btn" onclick="restartGame()">Ch∆°i l·∫°i</button>
            <button class="btn" onclick="shareResult()">Chia s·∫ª k·∫øt qu·∫£ üì∏</button>
        </div>
        
        <audio id="sfx-correct" src="https://www.soundjay.com/buttons/button-2.mp3" preload="auto"></audio>
        <audio id="sfx-incorrect" src="https://www.soundjay.com/buttons/button-3.mp3" preload="auto"></audio>
        <audio id="sfx-complete" src="https://www.soundjay.com/misc/fanfare.mp3" preload="auto"></audio>

    </div>

    <script>
        // JavaScript cho tr√≤ ch∆°i
        const gameData = [
            {
                id: 1,
                type: 'multiple-choice',
                question: "Qu√° tr√¨nh x·ª≠ l√≠ th√¥ng tin c·ªßa con ng∆∞·ªùi g·ªìm m·∫•y b∆∞·ªõc?",
                options: [
                    { text: "2 b∆∞·ªõc: Ti·∫øp nh·∫≠n v√† X·ª≠ l√≠.", isCorrect: false },
                    { text: "3 b∆∞·ªõc: Ti·∫øp nh·∫≠n, X·ª≠ l√≠, v√† Xu·∫•t th√¥ng tin.", isCorrect: true },
                    { text: "4 b∆∞·ªõc: Nghe, Nh√¨n, Suy nghƒ© v√† N√≥i.", isCorrect: false },
                    { text: "Ch·ªâ g·ªìm 1 b∆∞·ªõc l√† Suy nghƒ©.", isCorrect: false }
                ],
                answered: false,
                isCorrect: null
            },
            {
                id: 2,
                type: 'true-false',
                question: "B∆∞·ªõc cu·ªëi c√πng trong qu√° tr√¨nh x·ª≠ l√≠ th√¥ng tin c·ªßa con ng∆∞·ªùi l√† l∆∞u tr·ªØ th√¥ng tin. ƒê√∫ng hay Sai?",
                answer: false,
                answered: false,
                isCorrect: null,
                explanation: "B∆∞·ªõc cu·ªëi c√πng l√† Xu·∫•t th√¥ng tin (V√≠ d·ª•: n√≥i, vi·∫øt, h√†nh ƒë·ªông). L∆∞u tr·ªØ kh√¥ng ph·∫£i l√† m·ªôt b∆∞·ªõc c∆° b·∫£n trong qu√° tr√¨nh x·ª≠ l√≠ th√¥ng tin m√† ta ƒë√£ h·ªçc."
            },
            {
                id: 3,
                type: 'matching',
                question: "Em h√£y gh√©p t√™n b∆∞·ªõc x·ª≠ l√≠ th√¥ng tin (C·ªôt A) v·ªõi h√†nh ƒë·ªông t∆∞∆°ng ·ª©ng c·ªßa con ng∆∞·ªùi (C·ªôt B).",
                matches: [
                    { left: "Ti·∫øp nh·∫≠n th√¥ng tin", right: "Tai nghe ti·∫øng c√≤i xe" },
                    { left: "X·ª≠ l√≠ th√¥ng tin", right: "B·ªô n√£o ph√¢n t√≠ch √¢m thanh, ƒë∆∞a ra quy·∫øt ƒë·ªãnh" },
                    { left: "Xu·∫•t th√¥ng tin", right: "Tay b√≥p th·∫Øng xe" }
                ],
                answered: false,
                isCorrect: null,
                correctConnections: {} // D√πng ƒë·ªÉ l∆∞u tr·ªØ k·∫øt n·ªëi ƒë√∫ng sau khi shuffle
            },
            {
                id: 4,
                type: 'multiple-choice',
                question: "Trong m√°y t√≠nh, b∆∞·ªõc 'X·ª≠ l√≠' th√¥ng tin ƒë∆∞·ª£c th·ª±c hi·ªán b·ªüi b·ªô ph·∫≠n n√†o?",
                options: [
                    { text: "B√†n ph√≠m v√† chu·ªôt.", isCorrect: false },
                    { text: "M√†n h√¨nh v√† loa.", isCorrect: false },
                    { text: "B·ªô x·ª≠ l√≠ trung t√¢m (CPU).", isCorrect: true },
                    { text: "B·ªô nh·ªõ ngo√†i (USB, ·ªî c·ª©ng).", isCorrect: false }
                ],
                answered: false,
                isCorrect: null
            },
            {
                id: 5,
                type: 'true-false',
                question: "M√°y t√≠nh ch·ªâ x·ª≠ l√≠ ƒë∆∞·ª£c th√¥ng tin l√† h√¨nh ·∫£nh v√† √¢m thanh. ƒê√∫ng hay Sai?",
                answer: false,
                answered: false,
                isCorrect: null,
                explanation: "M√°y t√≠nh c√≥ th·ªÉ x·ª≠ l√≠ nhi·ªÅu lo·∫°i th√¥ng tin kh√°c nh∆∞ vƒÉn b·∫£n, s·ªë li·ªáu, video,..."
            },
            {
                id: 6,
                type: 'multiple-choice',
                question: "Khi em nh√¨n th·∫•y ƒë√®n giao th√¥ng chuy·ªÉn sang m√†u ƒë·ªè v√† d·ª´ng l·∫°i. H√†nh ƒë·ªông 'd·ª´ng l·∫°i' thu·ªôc b∆∞·ªõc n√†o trong qu√° tr√¨nh x·ª≠ l√≠ th√¥ng tin?",
                options: [
                    { text: "Ti·∫øp nh·∫≠n th√¥ng tin (th·ªã gi√°c).", isCorrect: false },
                    { text: "X·ª≠ l√≠ th√¥ng tin (b·ªô n√£o).", isCorrect: false },
                    { text: "Xu·∫•t th√¥ng tin (h√†nh ƒë·ªông).", isCorrect: true },
                    { text: "L∆∞u tr·ªØ th√¥ng tin (ghi nh·ªõ lu·∫≠t giao th√¥ng).", isCorrect: false }
                ],
                answered: false,
                isCorrect: null
            }
        ];

        let questions = []; // Danh s√°ch c√¢u h·ªèi ƒë√£ x√°o tr·ªôn
        let currentChallengeIndex = 0;
        let correctChallenges = 0;
        let startTime;
        let playerInfo = {};
        let selectedItemA = null; // Bi·∫øn global cho N·ªëi c·ªôt (Matching)
        
        // D·ªØ li·ªáu ng∆∞·ªùi ch∆°i (gi·∫£ l·∫≠p l∆∞u tr·ªØ JSON)
        let playerRecords = JSON.parse(localStorage.getItem('gameRecords')) || {};

        // === H√†m ti·ªán √≠ch ===

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function playSound(type) {
            const audio = document.getElementById(`sfx-${type}`);
            if (audio) {
                audio.currentTime = 0;
                audio.play();
            }
        }
        
        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes} ph√∫t ${seconds} gi√¢y`;
        }
        
        function savePlayerRecord() {
            const playerId = playerInfo.name + playerInfo.class;
            if (!playerRecords[playerId]) {
                playerRecords[playerId] = {
                    name: playerInfo.name,
                    class: playerInfo.class,
                    playCount: 0
                };
            }
            playerRecords[playerId].playCount += 1;
            playerInfo.playCount = playerRecords[playerId].playCount;
            localStorage.setItem('gameRecords', JSON.stringify(playerRecords));
        }

        // === Ph·∫ßn 1 & B·∫Øt ƒë·∫ßu tr√≤ ch∆°i (C·∫¨P NH·∫¨T: X·ª≠ l√Ω Reset tr·∫°ng th√°i) ===

        function loadExistingPlayer(name, playerClass) {
             const playerId = name + playerClass;
             if (playerRecords[playerId]) {
                 playerInfo.playCount = playerRecords[playerId].playCount;
                 return true;
             }
             return false;
        }
        
        function startGame(isReplay = false) {
            if (!isReplay) {
                const name = document.getElementById('player-name').value.trim();
                const playerClass = document.getElementById('player-class').value.trim();

                if (!name || !playerClass) {
                    alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß H·ªç v√† t√™n, L·ªõp.');
                    return;
                }
                
                playerInfo = { name, class: playerClass };
                loadExistingPlayer(name, playerClass);
            }
            
            savePlayerRecord(); // L∆∞u th√¥ng tin ng∆∞·ªùi ch∆°i v√† tƒÉng s·ªë l·∫ßn ch∆°i
            
            document.getElementById('info-section').classList.add('hidden');
            document.getElementById('result-section').classList.add('hidden');
            document.getElementById('game-section').classList.remove('hidden');

            document.getElementById('display-name').textContent = playerInfo.name;
            
            // --- RESET TO√ÄN B·ªò TR·∫†NG TH√ÅI TR√í CH∆†I ---
            // ƒê·∫£m b·∫£o t·∫°o l·∫°i m·ªôt b·∫£n sao m·ªõi c·ªßa gameData v√† reset c√°c thu·ªôc t√≠nh dynamic
            questions = shuffleArray(gameData.map(q => ({ 
                ...q, 
                answered: false, 
                isCorrect: null,
                connections: {}, // Reset cho matching
                domElements: null
            }))); 
            
            currentChallengeIndex = 0;
            correctChallenges = 0;
            selectedItemA = null; // R·∫•t quan tr·ªçng cho Matching
            startTime = Date.now();
            // ------------------------------------------

            // X·ª≠ l√≠ c√¢u h·ªèi k√©o th·∫£ (Matching) - Thi·∫øt l·∫≠p l·∫°i map ƒë√°p √°n ƒë√∫ng
            questions.forEach(q => {
                 if (q.type === 'matching') {
                     q.correctConnections = {};
                     q.matches.forEach(m => {
                         q.correctConnections[m.left] = m.right;
                     });
                 }
            });

            loadChallenge();
        }
        
        function restartGame() {
            // L·∫•y l·∫°i th√¥ng tin c≈© v√† tƒÉng s·ªë l·∫ßn ch∆°i, b·ªè qua Ph·∫ßn 1
            startGame(true);
        }

        // === Ph·∫ßn 2: N·ªôi dung tr√≤ ch∆°i ===

        function loadChallenge() {
            if (currentChallengeIndex >= questions.length) {
                finishGame();
                return;
            }

            const challenge = questions[currentChallengeIndex];
            
            document.getElementById('next-button').classList.add('hidden');
            document.getElementById('current-challenge-number').textContent = currentChallengeIndex + 1;
            document.getElementById('correct-count-display').textContent = correctChallenges;
            document.getElementById('challenge-text').textContent = challenge.question;
            
            const questionArea = document.getElementById('question-area');
            questionArea.innerHTML = '';
            
            // Load giao di·ªán theo lo·∫°i c√¢u h·ªèi
            switch (challenge.type) {
                case 'multiple-choice':
                    loadMultipleChoice(challenge, questionArea);
                    break;
                case 'true-false':
                    loadTrueFalse(challenge, questionArea);
                    break;
                case 'matching':
                    loadMatching(challenge, questionArea);
                    break;
            }
        }

        // --- D·∫°ng Tr·∫Øc nghi·ªám (Multiple Choice / True False) ---
        
        function loadMultipleChoice(challenge, container) {
            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'options-container';
            
            const shuffledOptions = shuffleArray([...challenge.options]);
            
            shuffledOptions.forEach((option, index) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = `${String.fromCharCode(65 + index)}. ${option.text}`;
                // *** QUAN TR·ªåNG: Kh√¥ng thi·∫øt l·∫≠p disabled t·ª´ ƒë·∫ßu ***
                btn.onclick = () => selectOption(btn, option.isCorrect); 
                optionsContainer.appendChild(btn);
            });
            container.appendChild(optionsContainer);
        }

        function loadTrueFalse(challenge, container) {
            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'options-container';

            const trueBtn = document.createElement('button');
            trueBtn.className = 'option-btn';
            trueBtn.textContent = 'A. ƒê√∫ng';
            trueBtn.onclick = () => selectOption(trueBtn, challenge.answer === true);

            const falseBtn = document.createElement('button');
            falseBtn.className = 'option-btn';
            falseBtn.textContent = 'B. Sai';
            falseBtn.onclick = () => selectOption(falseBtn, challenge.answer === false);
            
            const options = shuffleArray([trueBtn, falseBtn]);

            options.forEach(btn => optionsContainer.appendChild(btn));
            container.appendChild(optionsContainer);
        }

        function selectOption(selectedBtn, isCorrect) {
            if (questions[currentChallengeIndex].answered) return;

            const options = selectedBtn.parentNode.querySelectorAll('.option-btn');
            // V√¥ hi·ªáu h√≥a T·∫§T C·∫¢ n√∫t sau khi ch·ªçn ƒë·ªÉ ng∆∞·ªùi ch∆°i kh√¥ng ch·ªçn l·∫°i
            options.forEach(btn => {
                btn.disabled = true;
                // B√°o ƒë√£ ch·ªçn
                if (btn === selectedBtn) {
                     btn.classList.add('selected'); 
                }
            }); 
            
            // L∆∞u k·∫øt qu·∫£
            questions[currentChallengeIndex].answered = true;
            questions[currentChallengeIndex].isCorrect = isCorrect;
            
            if (isCorrect) {
                 correctChallenges++;
                 playSound('correct');
            } else {
                 playSound('incorrect');
            }

            document.getElementById('next-button').classList.remove('hidden');
        }
        
        // --- D·∫°ng N·ªëi c·ªôt (Matching) ---
        
        function loadMatching(challenge, container) {
            // Reset selectedItemA m·ªói khi load challenge
            selectedItemA = null; 
            
            const matchingArea = document.createElement('div');
            matchingArea.className = 'matching-area';
            
            const colA = document.createElement('div');
            colA.className = 'matching-column column-A';
            
            const colB = document.createElement('div');
            colB.className = 'matching-column column-B';
            
            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute('class', 'line-svg');
            // K√≠ch th∆∞·ªõc ban ƒë·∫ßu, s·∫Ω ƒëi·ªÅu ch·ªânh l·∫°i trong drawMatchingLine
            svg.setAttribute('viewBox', '0 0 800 300'); 
            svg.innerHTML = `
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="${getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim()}" />
                    </marker>
                </defs>
            `;

            matchingArea.appendChild(svg);
            
            // Chu·∫©n b·ªã d·ªØ li·ªáu
            const matches = challenge.matches;
            const leftTexts = matches.map(m => m.left);
            const rightTexts = matches.map(m => m.right);
            
            const shuffledRightTexts = shuffleArray([...rightTexts]);
            
            // L∆∞u tr·ªØ DOM elements v√† tr·∫°ng th√°i k·∫øt n·ªëi
            challenge.connections = {}; // {leftText: rightText}
            challenge.domElements = { colA, colB, svg, lineElements: {} };

            // T·∫°o c√°c item c·ªôt A
            leftTexts.forEach(text => {
                const item = document.createElement('div');
                item.className = 'match-item column-A';
                item.textContent = text;
                item.dataset.value = text;
                item.onclick = () => selectMatchItem(item, 'A');
                colA.appendChild(item);
            });

            // T·∫°o c√°c item c·ªôt B
            shuffledRightTexts.forEach(text => {
                const item = document.createElement('div');
                item.className = 'match-item column-B';
                item.textContent = text;
                item.dataset.value = text;
                item.onclick = () => selectMatchItem(item, 'B');
                colB.appendChild(item);
            });

            matchingArea.appendChild(colA);
            matchingArea.appendChild(colB);
            container.appendChild(matchingArea);
            
            // C·∫ßn delay ƒë·ªÉ ƒë·∫£m b·∫£o DOM ƒë∆∞·ª£c render, sau ƒë√≥ t√≠nh to√°n l·∫°i v·ªã tr√≠ SVG
            setTimeout(() => {
                const rect = container.getBoundingClientRect();
                svg.setAttribute('viewBox', `0 0 ${rect.width} ${rect.height}`);
                svg.style.width = rect.width + 'px';
                svg.style.height = rect.height + 'px';
            }, 50); 
        }
        
        function selectMatchItem(item, columnType) {
            const challenge = questions[currentChallengeIndex];
            if (challenge.answered) return;
            
            // L·∫•y l·∫°i danh s√°ch item ƒë·ªÉ d·ªÖ thao t√°c
            const colAItems = Array.from(challenge.domElements.colA.querySelectorAll('.match-item'));
            const colBItems = Array.from(challenge.domElements.colB.querySelectorAll('.match-item'));


            if (columnType === 'A') {
                if (selectedItemA) {
                    selectedItemA.classList.remove('selected');
                }
                selectedItemA = item;
                selectedItemA.classList.add('selected');
                playSound('correct'); 
            } else if (columnType === 'B' && selectedItemA) {
                // Ki·ªÉm tra n·∫øu item B ƒë√£ ƒë∆∞·ª£c n·ªëi
                if (item.dataset.connected) {
                     alert('√î n√†y ƒë√£ ƒë∆∞·ª£c n·ªëi. Vui l√≤ng ch·ªçn √¥ kh√°c.');
                     return;
                }
                
                // X√≥a k·∫øt n·ªëi c≈© c·ªßa item A (n·∫øu item A ƒë√£ t·ª´ng n·ªëi v·ªõi m·ªôt item B kh√°c)
                if (selectedItemA.dataset.connected) {
                    const oldBValue = challenge.connections[selectedItemA.dataset.value];
                    const oldBItem = colBItems.find(i => i.dataset.value === oldBValue);
                    if (oldBItem) oldBItem.dataset.connected = ''; // B·ªè tr·∫°ng th√°i n·ªëi c·ªßa B c≈©
                    
                    if (challenge.domElements.lineElements[selectedItemA.dataset.value]) {
                        challenge.domElements.lineElements[selectedItemA.dataset.value].remove();
                        delete challenge.domElements.lineElements[selectedItemA.dataset.value];
                    }
                    selectedItemA.dataset.connected = '';
                }
                
                // Thi·∫øt l·∫≠p k·∫øt n·ªëi m·ªõi
                challenge.connections[selectedItemA.dataset.value] = item.dataset.value;
                selectedItemA.dataset.connected = 'true';
                item.dataset.connected = 'true';
                
                // V·∫Ω ƒë∆∞·ªùng n·ªëi
                drawMatchingLine(selectedItemA, item, challenge);
                
                // B·ªè ch·ªçn A v√† ki·ªÉm tra ho√†n th√†nh
                selectedItemA.classList.remove('selected');
                selectedItemA = null; // R·∫•t quan tr·ªçng
                playSound('correct'); 
                
                checkMatchingComplete();
            }
        }
        
        function drawMatchingLine(itemA, itemB, challenge) {
            const svg = challenge.domElements.svg;
            const container = svg.parentElement;
            
            // C·∫ßn ƒë·∫£m b·∫£o t·ªça ƒë·ªô ƒë∆∞·ª£c t√≠nh ch√≠nh x√°c sau khi render
            const rect = container.getBoundingClientRect();
            
            // T√≠nh to√°n t·ªça ƒë·ªô (trong kh√¥ng gian c·ªßa container)
            const itemARect = itemA.getBoundingClientRect();
            const itemBRect = itemB.getBoundingClientRect();

            // L·∫•y t·ªça ƒë·ªô t∆∞∆°ng ƒë·ªëi v·ªõi container
            const startX = itemARect.right - rect.left;
            const startY = itemARect.top + itemARect.height / 2 - rect.top;
            
            const endX = itemBRect.left - rect.left;
            const endY = itemBRect.top + itemBRect.height / 2 - rect.top;

            // T·∫°o ƒë∆∞·ªùng n·ªëi
            const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
            line.setAttribute('x1', startX);
            line.setAttribute('y1', startY);
            line.setAttribute('x2', endX - 10); // L√πi l·∫°i ƒë·ªÉ ch·ª´a ch·ªó cho m≈©i t√™n
            line.setAttribute('y2', endY);
            line.setAttribute('class', 'connection-line');
            line.setAttribute('marker-end', 'url(#arrowhead)');

            // Th√™m v√†o SVG v√† l∆∞u l·∫°i
            svg.appendChild(line);
            challenge.domElements.lineElements[itemA.dataset.value] = line;
        }

        function checkMatchingComplete() {
            const challenge = questions[currentChallengeIndex];
            if (Object.keys(challenge.connections).length === challenge.matches.length) {
                
                let allCorrect = true;
                for (const left in challenge.connections) {
                    if (challenge.correctConnections[left] !== challenge.connections[left]) {
                        allCorrect = false;
                        break;
                    }
                }
                
                questions[currentChallengeIndex].answered = true;
                questions[currentChallengeIndex].isCorrect = allCorrect;
                
                if (allCorrect) {
                     correctChallenges++;
                     playSound('correct');
                } else {
                     playSound('incorrect');
                }
                
                // V√¥ hi·ªáu h√≥a c√°c n√∫t (b·∫±ng c√°ch lo·∫°i b·ªè s·ª± ki·ªán onclick)
                challenge.domElements.colA.querySelectorAll('.match-item').forEach(item => item.onclick = null);
                challenge.domElements.colB.querySelectorAll('.match-item').forEach(item => item.onclick = null);
                
                document.getElementById('next-button').classList.remove('hidden');
            }
        }
        
        // --- Chuy·ªÉn sang th·ª≠ th√°ch ti·∫øp theo ---

        function nextChallenge() {
            currentChallengeIndex++;
            loadChallenge();
        }

        // === Ph·∫ßn 3: K·∫øt qu·∫£ v√† L∆∞u tr·ªØ ===

        function finishGame() {
            const endTime = Date.now();
            const totalTime = endTime - startTime;
            
            // ·∫®n Game, hi·ªán Result
            document.getElementById('game-section').classList.add('hidden');
            document.getElementById('result-section').classList.remove('hidden');

            const totalChallenges = questions.length;
            const percentage = ((correctChallenges / totalChallenges) * 100).toFixed(0) + '%';
            
            let reviewText;
            let reviewColor;

            if (correctChallenges === totalChallenges) {
                reviewText = "Tuy·ªát v·ªùi! Em ƒë√£ ho√†n th√†nh xu·∫•t s·∫Øc t·∫•t c·∫£ th·ª≠ th√°ch! üíØ";
                reviewColor = 'var(--correct-color)';
            } else if (correctChallenges >= totalChallenges * 0.5) {
                reviewText = "R·∫•t t·ªët! Em ƒë√£ n·∫Øm v·ªØng ki·∫øn th·ª©c, h√£y c·ªë g·∫Øng th√™m ƒë·ªÉ ƒë·∫°t 100% nh√©! üëç";
                reviewColor = 'var(--secondary-color)';
            } else {
                reviewText = "Em c·∫ßn √¥n t·∫≠p th√™m v·ªÅ b√†i h·ªçc n√†y. ƒê·ª´ng n·∫£n l√≤ng, ch∆°i l·∫°i nh√©! üìö";
                reviewColor = 'var(--incorrect-color)';
            }

            // Hi·ªÉn th·ªã k·∫øt qu·∫£
            document.getElementById('res-name').textContent = playerInfo.name;
            document.getElementById('res-class').textContent = playerInfo.class;
            document.getElementById('res-play-count').textContent = playerInfo.playCount;
            document.getElementById('res-total-challenges').textContent = totalChallenges;
            document.getElementById('res-correct-challenges').textContent = correctChallenges;
            document.getElementById('res-percentage').textContent = percentage;
            document.getElementById('res-time').textContent = formatTime(totalTime);
            document.getElementById('review-text').textContent = reviewText;
            document.getElementById('review-text').style.backgroundColor = reviewColor;
            
            // Hi·ªáu ·ª©ng √¢m thanh ho√†n th√†nh
            playSound('complete');
        }

        function shareResult() {
            const resultSection = document.getElementById('result-section');
            html2canvas(resultSection, {
                scale: 2, 
                backgroundColor: null 
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `KetQua_GiaiCuuTT_${playerInfo.name}_${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            }).catch(error => {
                console.error("L·ªói khi ch·ª•p ·∫£nh: ", error);
                alert("ƒê√£ x·∫£y ra l·ªói khi t·∫°o ·∫£nh k·∫øt qu·∫£.");
            });
        }
    </script>

</body>
</html>