<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Cập nhật thời gian trên Google Sheets</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 760px; margin: 24px auto; line-height: 1.5; }
    h2 { margin-bottom: 8px; }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
    label { display: block; font-weight: bold; margin-top: 12px; }
    input { width: 100%; padding: 8px; margin-top: 6px; }
    button { margin-top: 16px; padding: 10px 14px; cursor: pointer; }
    .row { display: flex; gap: 12px; }
    .row > div { flex: 1; }
    #status { margin-top: 10px; color: #555; }
    #currentValue { margin-top: 8px; font-size: 14px; color: #222; background: #f7f7f7; padding: 8px; border-radius: 4px; }
    #result { margin-top: 8px; font-size: 14px; color: #0a7; }
    #error { margin-top: 8px; font-size: 14px; color: #c00; }
  </style>
</head>
<body>
  <h2>Quản lý “Thời gian cập nhật” trên Google Sheets</h2>
  <div class="card">
    <div class="row">
      <div>
        <label>Spreadsheet ID</label>
        <input id="spreadsheetId" placeholder="VD: 1AbCdEfGh... (lấy từ URL Google Sheet)" />
      </div>
      <div>
        <label>Tên sheet</label>
        <input id="sheetName" placeholder="VD: Sheet1" value="Sheet1" />
      </div>
      <div>
        <label>Ô cần đọc/ghi</label>
        <input id="cell" placeholder="VD: B2" value="B2" />
      </div>
    </div>

    <div class="row">
      <div>
        <button id="btnLoad">Tải giá trị hiện tại</button>
      </div>
      <div>
        <button id="btnUpdate">Cập nhật thời gian hiện tại</button>
      </div>
    </div>

    <div id="status"></div>
    <div id="currentValue"></div>
    <div id="result"></div>
    <div id="error"></div>
  </div>

  <script>
    // Đổi các endpoint dưới đây cho phù hợp backend của bạn
    const API_BASE = "http://localhost:3000"; // ví dụ backend Node đang chạy ở đây
    const GET_ENDPOINT = `${API_BASE}/api/get-time`;
    const UPDATE_ENDPOINT = `${API_BASE}/api/update-time`;

    const spreadsheetIdEl = document.getElementById("spreadsheetId");
    const sheetNameEl = document.getElementById("sheetName");
    const cellEl = document.getElementById("cell");
    const statusEl = document.getElementById("status");
    const currentValueEl = document.getElementById("currentValue");
    const resultEl = document.getElementById("result");
    const errorEl = document.getElementById("error");
    const btnLoad = document.getElementById("btnLoad");
    const btnUpdate = document.getElementById("btnUpdate");

    function clearMessages() {
      statusEl.textContent = "";
      resultEl.textContent = "";
      errorEl.textContent = "";
    }

    function validateInputs() {
      const spreadsheetId = spreadsheetIdEl.value.trim();
      const sheetName = sheetNameEl.value.trim();
      const cell = cellEl.value.trim();
      if (!spreadsheetId || !sheetName || !cell) {
        throw new Error("Vui lòng nhập đủ Spreadsheet ID, tên sheet và ô.");
      }
      return { spreadsheetId, sheetName, cell };
    }

    btnLoad.addEventListener("click", async () => {
      clearMessages();
      try {
        const { spreadsheetId, sheetName, cell } = validateInputs();
        statusEl.textContent = "⏳ Đang tải giá trị...";
        const url = new URL(GET_ENDPOINT);
        url.searchParams.set("spreadsheetId", spreadsheetId);
        url.searchParams.set("sheetName", sheetName);
        url.searchParams.set("cell", cell);

        const res = await fetch(url.toString(), { method: "GET" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        currentValueEl.textContent = `Giá trị hiện tại (${sheetName}!${cell}): ${data.value ?? "(trống)"}`;
        statusEl.textContent = "✅ Đã tải xong.";
      } catch (err) {
        errorEl.textContent = `Lỗi khi tải: ${err.message}`;
        statusEl.textContent = "";
      }
    });

    btnUpdate.addEventListener("click", async () => {
      clearMessages();
      try {
        const { spreadsheetId, sheetName, cell } = validateInputs();
        // Thời gian hiện tại theo múi giờ VN
        const nowVN = new Date().toLocaleString("vi-VN", { timeZone: "Asia/Ho_Chi_Minh" });

        statusEl.textContent = "⏳ Đang cập nhật thời gian...";
        const res = await fetch(UPDATE_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            spreadsheetId,
            sheetName,
            cell,
            value: nowVN
          })
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        resultEl.textContent = `✅ Đã cập nhật: ${data.updatedRange || `${sheetName}!${cell}`} = ${nowVN}`;
        statusEl.textContent = "✔️ Hoàn tất.";
        // Cập nhật hiển thị giá trị hiện tại
        currentValueEl.textContent = `Giá trị hiện tại (${sheetName}!${cell}): ${nowVN}`;
      } catch (err) {
        errorEl.textContent = `Lỗi khi cập nhật: ${err.message}`;
        statusEl.textContent = "";
      }
    });
  </script>
</body>
</html>