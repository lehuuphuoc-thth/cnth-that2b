<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Th√°m Hi·ªÉm X·ª© S·ªü M√°y T√≠nh - Tin H·ªçc 4</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #4CAF50; /* Xanh l√° c√¢y */
            --secondary-color: #FFC107; /* V√†ng */
            --accent-color: #2196F3; /* Xanh d∆∞∆°ng */
            --background-color: #E8F5E9; /* N·ªÅn xanh nh·∫°t */
            --text-color: #333;
            --correct-color: #8BC34A; /* Xanh l√° nh·∫°t */
            --wrong-color: #F44336; /* ƒê·ªè */
            --font-family: 'Arial', sans-serif;
        }

        /* Th√™m font th√¢n thi·ªán */
        @font-face {
            font-family: 'SVN-Avo';
            src: url('https://fonts.gstatic.com/s/robotoslab/v11/BngMUXZYXl2fK_AIT0qBv-7y5R0_M-x9H.woff2') format('woff2'); 
            font-weight: 400;
            font-style: normal;
        }

        body {
            font-family: var(--font-family);
            background: linear-gradient(135deg, var(--background-color) 0%, #BBDEFB 100%);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: auto;
            position: relative;
        }

        .container {
            background-color: #FFFFFF;
            border-radius: 25px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
            padding: 30px;
            width: 90%;
            max-width: 800px;
            text-align: center;
            box-sizing: border-box;
            position: relative;
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            color: var(--primary-color);
            font-size: 2.2em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        h2 {
            color: var(--accent-color);
            font-size: 1.8em;
            margin-bottom: 15px;
        }

        /* N√∫t chung */
        .btn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 12px 25px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 1.1em;
            margin: 10px 5px;
            cursor: pointer;
            border-radius: 50px;
            transition: all 0.3s ease;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .btn:hover {
            background-color: #FFD54F;
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* Input Form */
        #start-screen input {
            padding: 12px;
            margin: 10px 0;
            width: calc(100% - 24px);
            max-width: 350px;
            border: 2px solid #B3E5FC;
            border-radius: 10px;
            font-size: 1.1em;
            transition: border-color 0.3s;
        }

        #start-screen input:focus {
            border-color: var(--accent-color);
            outline: none;
        }

        /* Game Content */
        #game-content {
            min-height: 350px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .challenge-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 20px;
            background-color: #E1F5FE;
            border-radius: 15px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .question-text {
            font-size: 1.4em;
            margin-bottom: 25px;
            color: #00897B;
            padding: 10px;
            border-bottom: 2px dashed #B2DFDB;
        }

        /* Multiple Choice & True/False */
        .options-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .option-btn {
            background-color: #E0F2F1;
            color: var(--text-color);
            border: 2px solid #B2DFDB;
            padding: 15px 20px;
            width: 100%;
            max-width: 300px;
            text-align: left;
            font-size: 1.1em;
            cursor: pointer;
            border-radius: 15px;
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .option-btn:hover:not([disabled]) {
            background-color: #B2DFDB;
            transform: scale(1.02);
        }

        /* Hi·ªáu ·ª©ng khi ch·ªçn ƒë√°p √°n */
        .option-btn[disabled].correct {
            background-color: var(--correct-color);
            color: white;
            border-color: var(--correct-color);
            animation: pulseCorrect 0.5s;
        }

        .option-btn[disabled].wrong {
            background-color: var(--wrong-color);
            color: white;
            border-color: var(--wrong-color);
        }

        @keyframes pulseCorrect {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* N·ªëi c·ªôt (Matching) */
        .matching-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            text-align: left;
            user-select: none; /* NgƒÉn ch·∫∑n ch·ªçn vƒÉn b·∫£n */
        }

        .matching-column {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .match-item {
            background-color: #FFF3E0;
            border: 2px solid #FFCC80;
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1em;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            min-height: 50px; /* ƒê·∫£m b·∫£o chi·ªÅu cao */
            display: flex;
            align-items: center;
        }

        .match-item.selected {
            background-color: var(--secondary-color);
            color: white;
            border-color: #FFB300;
            transform: scale(1.05);
        }

        .match-item.matched {
            background-color: var(--correct-color);
            color: white;
            border-color: #689F38;
            cursor: default;
        }

        .match-item.incorrect-match {
            background-color: var(--wrong-color);
            color: white;
            border-color: #D32F2F;
            cursor: default;
        }

        .matching-message {
            grid-column: 1 / 3;
            font-weight: bold;
            color: var(--primary-color);
            margin-top: 10px;
            padding: 10px;
            border: 1px dashed;
            border-radius: 10px;
        }

        /* K·∫øt qu·∫£ */
        #result-screen {
            padding: 20px;
            border: 3px dashed var(--accent-color);
            border-radius: 20px;
            background-color: #F1F8E9;
        }

        #result-info p {
            font-size: 1.2em;
            margin: 8px 0;
            font-weight: 500;
        }

        #result-info strong {
            color: var(--primary-color);
        }

        #trophy {
            font-size: 4em;
            color: var(--secondary-color);
            margin: 20px 0;
            animation: bounce 1s infinite alternate;
        }

        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-10px); }
        }

        #comment {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--accent-color);
            margin: 15px 0 25px;
        }
        
        /* Chuy·ªÉn m√†n h√¨nh */
        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        /* ƒêi·ªÅu khi·ªÉn √¢m thanh */
        .audio-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 10;
        }

        .audio-controls button {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #ccc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.2em;
            cursor: pointer;
            margin-left: 5px;
            transition: background 0.3s;
        }

        .audio-controls button:hover {
            background: rgba(255, 255, 255, 1);
        }

        /* Thanh ti·∫øn ƒë·ªô */
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #eee;
            border-radius: 10px;
            margin-top: 10px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .progress-fill {
            height: 100%;
            background-color: var(--primary-color);
            width: 0;
            transition: width 0.5s ease-out;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="audio-controls">
        <button id="bgm-toggle" title="Nh·∫°c n·ªÅn">üéµ</button>
        <button id="sfx-toggle" title="√Çm thanh hi·ªáu ·ª©ng">üîä</button>
    </div>

    <div class="container" id="game-container">
        <h1>TH√ÅM HI·ªÇM X·ª® S·ªû M√ÅY T√çNH üöÄ</h1>
        <p style="font-style: italic; color: #666;">Tin h·ªçc 4 - B√†i 1: Ph·∫ßn c·ª©ng v√† Ph·∫ßn m·ªÅm m√°y t√≠nh</p>
        
        <div id="start-screen" class="screen active">
            <h2>Ch√†o m·ª´ng Nh√† th√°m hi·ªÉm!</h2>
            <p>H√£y ƒëi·ªÅn th√¥ng tin ƒë·ªÉ b·∫Øt ƒë·∫ßu h√†nh tr√¨nh chinh ph·ª•c **7 TH·ª¨ TH√ÅCH**!</p>
            <input type="text" id="player-name" placeholder="H·ªç v√† t√™n c·ªßa em" required><br>
            <input type="text" id="player-class" placeholder="L·ªõp c·ªßa em" required><br>
            <button class="btn" onclick="startGame()">B·∫ÆT ƒê·∫¶U TH·ª¨ TH√ÅCH ‚ú®</button>
        </div>

        <div id="quiz-screen" class="screen">
            <div class="challenge-header">
                <span id="challenge-counter">Th·ª≠ th√°ch 1 / 7</span>
                <span id="timer-display">Th·ªùi gian: 00:00</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div id="game-content">
                </div>
            <button class="btn" id="next-challenge-btn" style="display: none; background-color: var(--accent-color);">Th·ª≠ th√°ch ti·∫øp theo ‚ñ∂Ô∏è</button>
        </div>

        <div id="result-screen" class="screen">
            <h2>K·∫æT QU·∫¢ TH√ÅM HI·ªÇM</h2>
            <div id="trophy">üèÜ</div>
            <div id="result-info">
                <p>H·ªç t√™n: <strong id="res-name"></strong></p>
                <p>L·ªõp: <strong id="res-class"></strong></p>
                <p>S·ªë l·∫ßn ch∆°i: <strong id="res-play-count"></strong></p>
                <p>T·ªïng th·ª≠ th√°ch: <strong>7</strong></p>
                <p>S·ªë th·ª≠ th√°ch ƒë√∫ng: <strong id="res-correct"></strong></p>
                <p>Ph·∫ßn trƒÉm ho√†n th√†nh ƒë√∫ng: <strong id="res-percent"></strong></p>
                <p>Th·ªùi gian ho√†n th√†nh: <strong id="res-time"></strong></p>
            </div>
            <p id="comment"></p>
            <div class="result-actions" style="display: flex; justify-content: center;">
                <button class="btn" onclick="replayGame()">CH∆†I L·∫†I üîÅ</button>
                <button class="btn" onclick="shareResult()">CHIA S·∫∫ K·∫æT QU·∫¢ üì∏</button>
            </div>
        </div>

    </div>

    <audio id="bgm" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" loop></audio>
    <audio id="sfx-correct" src="https://s.cdpn.io/3/success.mp3"></audio>
    <audio id="sfx-wrong" src="https://s.cdpn.io/3/error.mp3"></audio>
    <audio id="sfx-complete" src="https://s.cdpn.io/3/cheering.mp3"></audio>

    <script>
        // D·ªØ li·ªáu c√¢u h·ªèi (JSON) - ƒê√É C·∫¨P NH·∫¨T 7 C√ÇU
        const allQuestions = [
            {
                id: 1,
                type: 'multiple-choice',
                question: "B·ªô ph·∫≠n n√†o sau ƒë√¢y ƒë∆∞·ª£c g·ªçi l√† **Ph·∫ßn c·ª©ng (Hardware)** c·ªßa m√°y t√≠nh?",
                options: [
                    { text: "Ph·∫ßn m·ªÅm Microsoft Word", isCorrect: false },
                    { text: "B√†n ph√≠m, M√†n h√¨nh, Th√¢n m√°y", isCorrect: true },
                    { text: "Tr√≤ ch∆°i ƒëi·ªán t·ª≠", isCorrect: false },
                    { text: "H·ªá ƒëi·ªÅu h√†nh Windows", isCorrect: false }
                ]
            },
            {
                id: 2,
                type: 'true-false',
                question: "**Ph·∫ßn m·ªÅm (Software)** l√† c√°c ch∆∞∆°ng tr√¨nh m√°y t√≠nh gi√∫p ng∆∞·ªùi d√πng v√† m√°y t√≠nh l√†m vi·ªác v·ªõi nhau.",
                correctAnswer: true, 
                options: [
                    { text: "ƒê√öNG", value: true },
                    { text: "SAI", value: false }
                ]
            },
            {
                id: 3,
                type: 'multiple-choice',
                question: "B·ªô ph·∫≠n n√†o c√≥ ch·ª©c nƒÉng ch√≠nh l√† **nh·∫≠p** d·ªØ li·ªáu v√†o m√°y t√≠nh?",
                options: [
                    { text: "M√†n h√¨nh", isCorrect: false },
                    { text: "Loa", isCorrect: false },
                    { text: "B√†n ph√≠m v√† Chu·ªôt", isCorrect: true },
                    { text: "Th√¢n m√°y", isCorrect: false }
                ]
            },
            {
                id: 4,
                type: 'matching',
                question: "Ph√¢n lo·∫°i c√°c m·ª•c sau v√†o nh√≥m **Ph·∫ßn c·ª©ng** hay **Ph·∫ßn m·ªÅm**.",
                matches: [
                    { colA: "Chu·ªôt m√°y t√≠nh", colB: "Ph·∫ßn c·ª©ng" },
                    { colA: "H·ªá ƒëi·ªÅu h√†nh (Windows)", colB: "Ph·∫ßn m·ªÅm" },
                    { colA: "M√†n h√¨nh", colB: "Ph·∫ßn c·ª©ng" },
                    { colA: "Ph·∫ßn m·ªÅm V·∫Ω (Paint)", colB: "Ph·∫ßn m·ªÅm" }
                ],
            },
            // --- 3 C√ÇU H·ªéI M·ªöI ---
            {
                id: 5,
                type: 'multiple-choice',
                question: "B·ªô ph·∫≠n n√†o ƒë∆∞·ª£c v√≠ nh∆∞ **'b·ªô n√£o'** c·ªßa m√°y t√≠nh, c√≥ ch·ª©c nƒÉng ch√≠nh l√† **x·ª≠ l√≠ th√¥ng tin**?",
                options: [
                    { text: "M√†n h√¨nh (Screen)", isCorrect: false },
                    { text: "B·ªô x·ª≠ l√≠ trung t√¢m (CPU) b√™n trong Th√¢n m√°y", isCorrect: true },
                    { text: "·ªî ƒëƒ©a c·ª©ng (Hard Drive)", isCorrect: false },
                    { text: "M√°y in (Printer)", isCorrect: false }
                ]
            },
            {
                id: 6,
                type: 'multiple-choice',
                question: "Trong c√°c m·ª•c sau, ƒë√¢u l√† m·ªôt v√≠ d·ª• v·ªÅ **Ph·∫ßn m·ªÅm ·ª®ng d·ª•ng**?",
                options: [
                    { text: "D√¢y c√°p n·ªëi m√°y t√≠nh", isCorrect: false },
                    { text: "Chu·ªôt m√°y t√≠nh", isCorrect: false },
                    { text: "Ph·∫ßn m·ªÅm so·∫°n th·∫£o vƒÉn b·∫£n Word", isCorrect: true },
                    { text: "M√°y qu√©t (Scanner)", isCorrect: false }
                ]
            },
            {
                id: 7,
                type: 'true-false',
                question: "M√†n h√¨nh, Loa v√† M√°y in l√† c√°c thi·∫øt b·ªã d√πng ƒë·ªÉ **xu·∫•t (Output)** th√¥ng tin ra kh·ªèi m√°y t√≠nh.",
                correctAnswer: true, 
                options: [
                    { text: "ƒê√öNG", value: true },
                    { text: "SAI", value: false }
                ]
            }
        ];

        // Bi·∫øn tr·∫°ng th√°i tr√≤ ch∆°i
        let playerName = "";
        let playerClass = "";
        let playCount = 0;
        let shuffledQuestions = [];
        let currentQuestionIndex = 0;
        let correctChallenges = 0;
        let startTime = null;
        let timerInterval = null;
        let isGameStarted = false;
        
        // ƒêi·ªÅu khi·ªÉn √¢m thanh
        let isSFXEnabled = true;
        let isBGMEnabled = true;
        const bgm = document.getElementById('bgm');
        const sfxCorrect = document.getElementById('sfx-correct');
        const sfxWrong = document.getElementById('sfx-wrong');
        const sfxComplete = document.getElementById('sfx-complete');

        // --- H√ÄM H·ªñ TR·ª¢ CHUNG ---

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function switchScreen(activeScreenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(activeScreenId).classList.add('active');
        }

        // --- X·ª¨ L√ù √ÇM THANH ---

        document.getElementById('bgm-toggle').addEventListener('click', toggleBGM);
        document.getElementById('sfx-toggle').addEventListener('click', toggleSFX);

        function toggleBGM() {
            isBGMEnabled = !isBGMEnabled;
            document.getElementById('bgm-toggle').textContent = isBGMEnabled ? 'üéµ' : 'üîá';
            if (isBGMEnabled && isGameStarted) {
                bgm.play().catch(e => console.log("L·ªói play BGM:", e));
            } else {
                bgm.pause();
            }
        }

        function toggleSFX() {
            isSFXEnabled = !isSFXEnabled;
            document.getElementById('sfx-toggle').textContent = isSFXEnabled ? 'üîä' : 'üîá';
        }

        function playSFX(type) {
            if (!isSFXEnabled) return;
            let audio;
            if (type === 'correct') audio = sfxCorrect;
            else if (type === 'wrong') audio = sfxWrong;
            else if (type === 'complete') audio = sfxComplete;
            
            if (audio) {
                audio.currentTime = 0; 
                audio.play().catch(e => console.log("L·ªói play SFX:", e));
            }
        }

        // --- PH·∫¶N 1: B·∫ÆT ƒê·∫¶U TR√í CH∆†I ---

        function startGame() {
            const nameInput = document.getElementById('player-name');
            const classInput = document.getElementById('player-class');

            // C·∫≠p nh·∫≠t th√¥ng tin ng∆∞·ªùi ch∆°i 
            if (playCount === 0 || !playerName) {
                playerName = nameInput.value.trim();
                playerClass = classInput.value.trim();
            }
            
            if (!playerName || !playerClass) {
                alert("Vui l√≤ng nh·∫≠p H·ªç v√† t√™n v√† L·ªõp ƒë·ªÉ b·∫Øt ƒë·∫ßu!");
                return;
            }

            playCount++;
            isGameStarted = true;
            correctChallenges = 0;
            currentQuestionIndex = 0;
            startTime = new Date();

            // X√°o tr·ªôn c√¢u h·ªèi
            shuffledQuestions = [...allQuestions];
            shuffleArray(shuffledQuestions);

            // B·∫Øt ƒë·∫ßu ƒë·∫øm gi·ªù v√† nh·∫°c n·ªÅn
            startTimer();
            if (isBGMEnabled) bgm.play().catch(e => console.log("L·ªói play BGM khi start:", e));

            switchScreen('quiz-screen');
            loadChallenge();
        }

        function startTimer() {
            clearInterval(timerInterval);
            const timerDisplay = document.getElementById('timer-display');
            
            function updateTimer() {
                const now = new Date();
                const diff = Math.floor((now - startTime) / 1000);
                const minutes = String(Math.floor(diff / 60)).padStart(2, '0');
                const seconds = String(diff % 60).padStart(2, '0');
                timerDisplay.textContent = `Th·ªùi gian: ${minutes}:${seconds}`;
            }

            timerInterval = setInterval(updateTimer, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            const now = new Date();
            const diff = Math.floor((now - startTime) / 1000);
            const minutes = String(Math.floor(diff / 60)).padStart(2, '0');
            const seconds = String(diff % 60).padStart(2, '0');
            return `${minutes}:${seconds}`;
        }

        // --- PH·∫¶N 2: N·ªòI DUNG TR√í CH∆†I ---

        function loadChallenge() {
            if (currentQuestionIndex >= shuffledQuestions.length) {
                finishGame();
                return;
            }

            const totalChallenges = shuffledQuestions.length;
            const currentChallengeNumber = currentQuestionIndex + 1;
            const questionData = shuffledQuestions[currentQuestionIndex];
            const contentDiv = document.getElementById('game-content');
            const nextBtn = document.getElementById('next-challenge-btn');
            
            // C·∫≠p nh·∫≠t thanh ti·∫øn ƒë·ªô v√† s·ªë th·ª≠ th√°ch
            document.getElementById('challenge-counter').textContent = `Th·ª≠ th√°ch ${currentChallengeNumber} / ${totalChallenges}`;
            const percent = (currentQuestionIndex / totalChallenges) * 100;
            document.getElementById('progress-fill').style.width = `${percent}%`;

            nextBtn.style.display = 'none';
            contentDiv.innerHTML = `<p class="question-text">${questionData.question}</p>`;

            if (questionData.type === 'multiple-choice' || questionData.type === 'true-false') {
                renderMultipleChoice(questionData, contentDiv);
            } else if (questionData.type === 'matching') {
                renderMatching(questionData, contentDiv);
            }
        }

        // X·ª≠ l√Ω Tr·∫Øc nghi·ªám v√† ƒê√∫ng/Sai
        function renderMultipleChoice(data, container) {
            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'options-container';

            // X√°o tr·ªôn v·ªã tr√≠ ƒë√°p √°n 
            let options = [...data.options];
            if (data.type === 'multiple-choice') {
                shuffleArray(options);
            }

            options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'option-btn';
                button.innerHTML = `<span>${String.fromCharCode(65 + index)}. </span> ${option.text || option.value}`;
                button.onclick = () => handleAnswer(data, index, options, button);
                optionsContainer.appendChild(button);
            });

            container.appendChild(optionsContainer);
        }

        function handleAnswer(questionData, selectedIndex, options, selectedButton) {
            // NgƒÉn ch·∫∑n tr·∫£ l·ªùi l·∫°i
            const buttons = selectedButton.closest('.options-container').querySelectorAll('.option-btn');
            buttons.forEach(btn => btn.disabled = true);
            
            let answeredCorrectly = false;
            let selectedText = selectedButton.textContent.substring(3).trim();

            if (questionData.type === 'multiple-choice') {
                answeredCorrectly = options[selectedIndex].isCorrect;
            } else if (questionData.type === 'true-false') {
                const selectedValue = selectedText === 'ƒê√öNG';
                answeredCorrectly = selectedValue === questionData.correctAnswer;
            }

            // X·ª≠ l√Ω giao di·ªán v√† √¢m thanh
            buttons.forEach((btn) => {
                let optionIsCorrect = false;
                let btnText = btn.textContent.substring(3).trim();

                if (questionData.type === 'multiple-choice') {
                    // T√¨m ƒë√°p √°n ƒë√∫ng b·∫±ng c√°ch so s√°nh n·ªôi dung
                    const correctOption = questionData.options.find(opt => opt.isCorrect);
                    optionIsCorrect = correctOption && correctOption.text === btnText;
                } else if (questionData.type === 'true-false') {
                    optionIsCorrect = (btnText === 'ƒê√öNG' && questionData.correctAnswer === true) || (btnText === 'SAI' && questionData.correctAnswer === false);
                }

                if (optionIsCorrect) {
                    btn.classList.add('correct');
                }
                if (btn === selectedButton && !optionIsCorrect) {
                    btn.classList.add('wrong');
                }
            });

            // Ghi nh·∫≠n k·∫øt qu·∫£
            if (answeredCorrectly) {
                playSFX('correct');
                correctChallenges++;
            } else {
                playSFX('wrong');
            }
            
            document.getElementById('next-challenge-btn').style.display = 'block';
        }

        // X·ª≠ l√Ω N·ªëi c·ªôt (Matching)
        let selectedItemA = null;
        let selectedItemB = null;
        let currentMatches = 0;
        let totalMatches = 0;
        let matchingCorrect = true; // Bi·∫øn ki·ªÉm tra n·∫øu c√≥ b·∫•t k·ª≥ c·∫∑p n√†o sai

        function renderMatching(data, container) {
            const matchingContainer = document.createElement('div');
            matchingContainer.className = 'matching-container';

            const colA = document.createElement('div');
            colA.className = 'matching-column';
            const colB = document.createElement('div');
            colB.className = 'matching-column';

            let itemsA = data.matches.map(m => ({ text: m.colA, correctMatch: m.colB }));
            let itemsB = data.matches.map(m => ({ text: m.colB, isMatched: false }));

            // X√°o tr·ªôn c·ªôt A v√† B
            shuffleArray(itemsA);
            shuffleArray(itemsB);
            totalMatches = data.matches.length;
            currentMatches = 0;
            matchingCorrect = true;

            itemsA.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'match-item';
                itemDiv.textContent = item.text;
                itemDiv.dataset.col = 'A';
                itemDiv.dataset.correct = item.correctMatch;
                itemDiv.onclick = () => selectMatchItem(itemDiv, 'A');
                colA.appendChild(itemDiv);
            });

            itemsB.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'match-item';
                itemDiv.textContent = item.text;
                itemDiv.dataset.col = 'B';
                itemDiv.onclick = () => selectMatchItem(itemDiv, 'B');
                colB.appendChild(itemDiv);
            });

            matchingContainer.appendChild(colA);
            matchingContainer.appendChild(colB);
            container.appendChild(matchingContainer);

            // Th√™m tin nh·∫Øn k·∫øt qu·∫£ (ban ƒë·∫ßu ·∫©n)
            const msgDiv = document.createElement('div');
            msgDiv.className = 'matching-message';
            msgDiv.id = 'matching-message';
            msgDiv.style.display = 'none';
            matchingContainer.appendChild(msgDiv);
        }

        function disableAllMatchItems() {
            document.querySelectorAll('.match-item').forEach(item => item.onclick = null); 
        }

        function selectMatchItem(item, col) {
            if (item.classList.contains('matched') || item.classList.contains('incorrect-match')) return; 

            // Ch·ªçn item v√† b·ªè ch·ªçn item c√πng c·ªôt tr∆∞·ªõc ƒë√≥
            if (col === 'A') {
                if (selectedItemA) selectedItemA.classList.remove('selected');
                if (selectedItemA === item) {
                    selectedItemA = null;
                } else {
                    selectedItemA = item;
                    selectedItemA.classList.add('selected');
                }
            } else { // col === 'B'
                if (selectedItemB) selectedItemB.classList.remove('selected');
                if (selectedItemB === item) {
                    selectedItemB = null;
                } else {
                    selectedItemB = item;
                    selectedItemB.classList.add('selected');
                }
            }

            // Ki·ªÉm tra kh·ªõp n·∫øu c·∫£ hai ƒë√£ ƒë∆∞·ª£c ch·ªçn
            if (selectedItemA && selectedItemB) {
                checkMatch();
            }
        }

        function checkMatch() {
            const msgDiv = document.getElementById('matching-message');

            // Kh·ªõp ƒë√∫ng
            if (selectedItemA.dataset.correct === selectedItemB.textContent) {
                playSFX('correct');
                selectedItemA.classList.remove('selected');
                selectedItemB.classList.remove('selected');
                selectedItemA.classList.add('matched');
                selectedItemB.classList.add('matched');
                currentMatches++;
            } else {
                // Kh·ªõp sai: ƒë√°nh d·∫•u sai v√† ch·∫•p nh·∫≠n k·∫øt qu·∫£
                playSFX('wrong');
                matchingCorrect = false; // ƒê√°nh d·∫•u to√†n b·ªô th·ª≠ th√°ch l√† sai
                
                // ƒê√°nh d·∫•u c·∫∑p sai v·ª´a ch·ªçn
                selectedItemA.classList.remove('selected');
                selectedItemB.classList.remove('selected');
                selectedItemA.classList.add('incorrect-match');
                selectedItemB.classList.add('incorrect-match');
            }
            
            // ƒê·∫∑t l·∫°i l·ª±a ch·ªçn sau khi x·ª≠ l√Ω
            selectedItemA = null;
            selectedItemB = null;

            // Ki·ªÉm tra ho√†n th√†nh to√†n b·ªô c·∫∑p
            if (document.querySelectorAll('.match-item:not(.matched):not(.incorrect-match)').length === 0) {
                disableAllMatchItems(); // Kh√≥a t·∫•t c·∫£ c√°c n√∫t c√≤n l·∫°i

                // Ch·ªâ tƒÉng s·ªë c√¢u ƒë√∫ng n·∫øu t·∫•t c·∫£ c√°c c·∫∑p ƒë·ªÅu ƒë√∫ng t·ª´ ƒë·∫ßu
                if (matchingCorrect) { 
                    correctChallenges++;
                    msgDiv.style.display = 'block';
                    msgDiv.textContent = "Xu·∫•t s·∫Øc! B·∫°n ƒë√£ gh√©p ƒë√∫ng t·∫•t c·∫£ c√°c ch·ª©c nƒÉng c∆° b·∫£n!";
                    msgDiv.style.color = 'var(--correct-color)';
                } else {
                    msgDiv.style.display = 'block';
                    msgDiv.textContent = "Th·ª≠ th√°ch ho√†n th√†nh, nh∆∞ng c√≥ l·ªói x·∫£y ra. B·∫°n c·∫ßn n·ªëi ƒë√∫ng h·∫øt t·∫•t c·∫£ c√°c c·∫∑p ƒë·ªÉ ƒë∆∞·ª£c t√≠nh ƒëi·ªÉm th·ª≠ th√°ch. (Kh√¥ng ph√¢n bi·ªát ƒë√∫ng/sai t·ª´ng c·∫∑p).";
                    msgDiv.style.color = 'var(--wrong-color)';
                }
                
                document.getElementById('next-challenge-btn').style.display = 'block';
            }
        }

        document.getElementById('next-challenge-btn').addEventListener('click', () => {
            currentQuestionIndex++;
            loadChallenge();
        });


        // --- PH·∫¶N 3: K·∫æT QU·∫¢ & L∆ØU K·∫æT QU·∫¢ ---

        function finishGame() {
            isGameStarted = false;
            bgm.pause();
            playSFX('complete');
            const finalTime = stopTimer();
            const totalChallenges = shuffledQuestions.length;
            const percentCorrect = ((correctChallenges / totalChallenges) * 100).toFixed(0);
            
            // C·∫≠p nh·∫≠t thanh ti·∫øn ƒë·ªô cu·ªëi c√πng
            document.getElementById('progress-fill').style.width = '100%';

            // C·∫≠p nh·∫≠t th√¥ng tin k·∫øt qu·∫£
            document.getElementById('res-name').textContent = playerName;
            document.getElementById('res-class').textContent = playerClass;
            document.getElementById('res-play-count').textContent = playCount;
            document.getElementById('res-correct').textContent = correctChallenges;
            document.getElementById('res-percent').textContent = `${percentCorrect}%`;
            document.getElementById('res-time').textContent = finalTime;
            
            // Ghi l·ªùi nh·∫≠n x√©t
            let commentText = "";
            let trophyIcon = "";

            if (percentCorrect == 100) {
                commentText = "HO√ÄN TH√ÄNH XU·∫§T S·∫ÆC! B·∫°n l√† m·ªôt nh√† th√°m hi·ªÉm m√°y t√≠nh ƒë·∫°i t√†i! üíØ";
                trophyIcon = "üåü";
            } else if (percentCorrect >= 50) {
                commentText = "HO√ÄN TH√ÄNH T·ªêT! B·∫°n ƒë√£ n·∫Øm v·ªØng ki·∫øn th·ª©c, c·ªë g·∫Øng th√™m ch√∫t n·ªØa nh√©! üí™";
                trophyIcon = "‚úÖ";
            } else {
                commentText = "C·ªê G·∫ÆNG L√äN! H√£y √¥n t·∫≠p l·∫°i c√°c ki·∫øn th·ª©c Ph·∫ßn c·ª©ng & Ph·∫ßn m·ªÅm v√† th·ª≠ l·∫°i l·∫ßn n·ªØa! üí°";
                trophyIcon = "ü§î";
            }

            document.getElementById('comment').textContent = commentText;
            document.getElementById('trophy').textContent = trophyIcon;

            switchScreen('result-screen');
        }

        function replayGame() {
            // L·∫•y th√¥ng tin t·ª´ Ph·∫ßn 1 (ƒë√£ l∆∞u) v√† b·ªè qua m√†n h√¨nh nh·∫≠p
            document.getElementById('player-name').value = playerName;
            document.getElementById('player-class').value = playerClass;
            startGame();
        }

        function shareResult() {
            // S·ª≠ d·ª•ng html2canvas ƒë·ªÉ ch·ª•p k·∫øt qu·∫£
            const resultScreen = document.getElementById('result-screen');
            const resultContainer = resultScreen.closest('.container');

            // ·∫®n c√°c n√∫t h√†nh ƒë·ªông tr∆∞·ªõc khi ch·ª•p
            const actions = resultScreen.querySelector('.result-actions');
            actions.style.display = 'none';

            html2canvas(resultContainer, {
                scale: 2, // TƒÉng ch·∫•t l∆∞·ª£ng ·∫£nh
                backgroundColor: '#F1F8E9', // ƒê·∫£m b·∫£o n·ªÅn m√†u tr·∫Øng (ho·∫∑c m√†u c·ªßa result-screen)
                useCORS: true
            }).then(canvas => {
                // Hi·ªÉn th·ªã l·∫°i c√°c n√∫t sau khi ch·ª•p
                actions.style.display = 'flex'; 

                const imageURL = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.href = imageURL;
                link.download = `Ket_qua_Tham_Hiem_May_Tinh_${playerName.replace(/\s/g, '_')}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                alert("ƒê√£ t·∫£i h√¨nh ·∫£nh k·∫øt qu·∫£ v·ªÅ m√°y!");
            }).catch(error => {
                console.error("L·ªói khi ch·ª•p ·∫£nh:", error);
                actions.style.display = 'flex'; 
                alert("Kh√¥ng th·ªÉ ch·ª•p ·∫£nh k·∫øt qu·∫£. Vui l√≤ng th·ª≠ l·∫°i.");
            });
        }
        
        // Kh·ªüi t·∫°o tr·∫°ng th√°i ban ƒë·∫ßu
        document.addEventListener('DOMContentLoaded', () => {
            switchScreen('start-screen');
            // C√†i ƒë·∫∑t √¢m l∆∞·ª£ng m·∫∑c ƒë·ªãnh
            bgm.volume = 0.3;
            sfxCorrect.volume = 0.5;
            sfxWrong.volume = 0.5;
            sfxComplete.volume = 0.6;
            // T·∫£i nh·∫°c n·ªÅn (kh√¥ng t·ª± ƒë·ªông play v√¨ b·ªã tr√¨nh duy·ªát ch·∫∑n)
            bgm.load(); 
        });

    </script>
</body>
</html>